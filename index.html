<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>Подработки и зарплата</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="theme-color" content="#0b0d12">
<style>
  :root{
    --bg:#0f1115; --card:#161b22; --mut:#9aa4b2; --text:#e6eef8; --accent:#3b82f6; --accent-2:#2563eb;
    --ok:#16a34a; --danger:#ef4444; --pill:#0b1220; --border:#202735;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:940px;margin:0 auto;padding:16px}
  .h1{font-weight:800;font-size:28px;margin:6px 0 14px}
  .tabs{display:flex;gap:12px;margin:4px 0 14px}
  .tab{border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 16px;border-radius:14px;cursor:pointer}
  .tab.active{outline:2px solid var(--accent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;align-items:center}
  .row.wrap{flex-wrap:wrap}
  .grow{flex:1;min-width:0}

  /* отключаем double-tap zoom на кликабельных элементах */
html, body { touch-action: manipulation; }
.btn, .tab, .cal-day, label, input, select {
  touch-action: manipulation;
}

      .btn{
  border:1px solid var(--border);
  background:#1f2937;
  color:var(--text);
  border-radius:14px;
  padding:0 14px;
  cursor:pointer;
  height:44px;
  white-space:nowrap;

  /* НОВОЕ: идеальный центр */
  display:flex;
  align-items:center;
  justify-content:center;
}
      
/* защита от зума при фокусе на инпутах в iOS: шрифт >= 16px */
input, select { font-size:16px; }

  .btn.primary{background:var(--accent);border-color:var(--accent-2)}
  .btn.danger{background:#3a0d12;border-color:#7f1d1d}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  input,select{width:100%;padding:0 14px;border-radius:12px;border:1px solid var(--border);
               background:#0e1420;color:var(--text);height:44px}
  .mut{color:var(--mut)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:780px){.grid-3{grid-template-columns:1fr}}

  .quick{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
  .quick .btn{padding:16px 8px;height:48px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);
        padding:6px 10px;border-radius:999px;border:1px solid var(--border)}
  .mtt{margin-top:8px}
  .mt-8{margin-top:8px}
  .section-title{font-weight:700;margin:2px 0 8px}

      /* --- Импорт: красивый файл-инпут --- */
.file-wrap{
  display:grid;
  grid-template-columns:auto 1fr; /* кнопка | имя файла */
  gap:12px;
  align-items:center;
}
.file-input{
  position:absolute;
  width:1px;height:1px;overflow:hidden;
  clip:rect(0 0 0 0); clip-path: inset(50%);
  white-space:nowrap;border:0;padding:0;margin:-1px;
}
.file-name{
  display:flex;align-items:center;
  height:44px;padding:0 14px;border-radius:12px;
  background:#0e1420;border:1px solid var(--border);
  color:var(--text);
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
/* --- Импорт: ровная сетка --- */
.import-grid{
  display:grid;
  grid-template-columns: 200px 1fr; /* левая узкая колонка + правая растяжимая */
  grid-auto-rows: 44px;
  column-gap:12px;
  row-gap:12px;
  align-items:center;
}

/* делаем .file-wrap «сквозной», чтобы её дети легли в сетку родителя */
.import-grid .file-wrap{ display: contents; }

      
@media (max-width: 560px){
  .import-grid{
    grid-template-columns: 1fr;      /* одна колонка на мобилках */
    grid-auto-rows:auto;
  }
  .import-grid .file-name{ grid-column:auto; }
}
      
  /* Поле + кнопка — строго в линию */
  .field-row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
  .field{display:flex;flex-direction:column;gap:6px}

  /* Календарь */
  .cal-head{
    display:grid;
    grid-template-columns:auto 1fr auto; /* кнопка | заголовок | кнопка */
    align-items:center;
    gap:12px;
    width:100%;
  }
  .cal-title {
  font-weight: 800;
  font-size: 16px;   /* всегда одинаковый размер */
  text-align: center;
  line-height: 1.2;
}
.cal-title .year {
  display: block;
  font-size: 16px;
  font-weight: 500;
  margin-top: 2px;
}
  .cal-head .btn:first-child{ justify-self:start; }
  .cal-head .btn:last-child{  justify-self:end;  }
  .cal-head .btn{ max-width:100%; }

  .cal-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:6px 0 8px;color:var(--mut)}
  .cal-dow span{text-align:center}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cal-day{position:relative;border:1px solid var(--border);background:#0f1420;border-radius:18px;min-height:60px;padding:6px 6px 4px;text-align:center;color:var(--text);cursor:pointer}
  .cal-day .num{display:block;font-weight:700;margin-bottom:2px}
  .cal-day .badge{font-size:15px;line-height:1}
  .cal-day.selected{outline:3px solid var(--accent);outline-offset:0}
  .legend{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px;color:var(--mut)}
  .legend span{display:inline-flex;align-items:center;gap:6px}

  /* Строка записи: 3 колонки — название | часы | действия */
  .rowline{
    display:grid;
    grid-template-columns:1fr 100px auto;
    gap:8px;
    align-items:center;
    padding:10px;
    border:1px solid var(--border);
    border-radius:12px;
    margin:6px 0;
  }
  .rowline .hours{ text-align:right }
  .rowline .actions{ justify-self:end }

  .money{text-align:right}
  .totals{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .totals .pill{background:#0f1625}

      /* Ряд двух нижних кнопок на всю ширину */
.buttons-row{
  grid-column: 1 / -1;  /* растянуть на обе колонки сетки импорта */
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.buttons-row .btn{
  flex:1 1 180px;       /* одинаковая ширина; ужимаются на узком экране */
}
      
  @media (max-width:560px){
    .rowline{ grid-template-columns:1fr 70px auto }
    .cal-day{min-height:56px}
  }
      @media (max-width:560px){
  .import-grid{ grid-template-columns:1fr; grid-auto-rows:auto; }
  .buttons-row .btn{ flex:1 1 140px; }
}
      /* ===== Modal (Архив) ===== */
.modal[hidden]{ display:none }
.modal{
  position:fixed; inset:0; z-index:9999; display:grid; place-items:center;
}
.modal-backdrop{
  position:absolute; inset:0; background:#0008; backdrop-filter:saturate(80%) blur(2px);
}
      /* Кнопка закрытия (крестик) */
.modal-close{
  position:absolute; top:10px; right:10px;
  width:36px; height:36px; border-radius:999px;
  border:1px solid var(--border); background:#111827; color:var(--text);
  display:flex; align-items:center; justify-content:center; cursor:pointer;
  font-size:20px; line-height:1;
      padding: 2px 0 0;
}

/* делаем карточку модалки скроллируемой, а не фон */
.modal-card{
  position:relative; z-index:1; width:min(720px, calc(100% - 24px));
  background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;
overscroll-behavior: contain;
  /* НОВОЕ: ограничение высоты и собственный скролл */
  max-height:calc(100vh - 24px);
  overflow:auto;
  -webkit-overflow-scrolling: touch; /* iOS плавный скролл */
}

/* Блокируем прокрутку фона, когда открыта модалка */
body.no-scroll{
  overflow:hidden;
  height:100vh; /* фикс для iOS */
}
.modal-head{ font-weight:800; font-size:18px; margin-bottom:12px }
.modal-row{ display:grid; grid-template-columns:1fr 1fr auto; gap:12px; align-items:end }
@media (max-width:560px){
  .modal-row{ grid-template-columns:1fr 1fr; }
  .modal-row .wide{ grid-column:1 / -1; }
}
.small-note{ color:var(--mut); margin-top:8px }

/* компактная сетка внутри результата */
.archive-totals{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px }
.archive-totals .pill{ background:#0f1625 }
.archive-list{ margin-top:10px }
.archive-item{
  display:grid; grid-template-columns:1fr 90px; gap:8px; align-items:center;
  padding:8px; border:1px solid var(--border); border-radius:10px; margin:6px 0;
}
.archive-item .r{ text-align:right }
</style>
</head>
<body>
  <div class="wrap">
    <div class="h1">Подработки и зарплата</div>

    <div class="tabs">
      <button class="tab active" data-tab="journal">Журнал</button>
      <button class="tab" data-tab="settings">Настройки</button>
      <button class="tab" data-tab="holidays">Праздники</button>
      <button class="tab" data-tab="import">Импорт</button>
    </div>

    <!-- JOURNAL -->
    <section id="journal" class="tabpage">
      <div class="card">
        <div class="field-row">
          <div class="field">
            <div class="mut">Дата</div>
            <input id="dt" readonly>
          </div>
          <button class="btn" id="btnToday">Сегодня</button>
        </div>

        <div class="field-row mt-8">
          <div class="field">
            <div class="mut">Часы</div>
            <input id="hours" inputmode="decimal" placeholder="напр., 3.5">
          </div>
          <button class="btn primary" id="btnAdd">Добавить</button>
        </div>

        <div class="section-title mt-8">Быстрые кнопки:</div>
        <div class="quick" id="quick">
          <button class="btn" data-qk="hrs-3.5">3.5 ч</button>
          <button class="btn" data-qk="hrs-8">8 ч</button>
          <button class="btn" data-qk="leave-hours">Отгул</button>
          <button class="btn" data-qk="vacation">Отпуск</button>
        </div>
      </div>

      <div class="card">
        <div class="cal-head">
          <button class="btn" id="prevM">◀ Предыдущий</button>
          <div class="cal-title" id="cal-title"></div>
          <button class="btn" id="nextM">Следующий ▶</button>
        </div>
        <div class="cal-dow" id="cal-dow"></div>
        <div class="cal-grid" id="cal-grid"></div>
        <div class="legend">
          <span>🛠️ — подработка</span>
          <span>⛔ — отгул</span>
          <span>🏖️ — отпуск</span>
          <span>🎉 — праздничный</span>
        </div>
      </div>

      <div class="card">
        <div id="day-list"></div>
        <div class="totals" id="totals"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="tabpage" hidden>
      <div class="card">
        <div class="grid-3">
          <div>
            <div class="mut">Оклад, ₽ (на руки)</div>
            <input id="salary" inputmode="numeric">
          </div>
          <div>
            <div class="mut">Рабочих дней в текущем месяце (Пн–Пт минус праздники)</div>
            <input id="workdays" inputmode="numeric" readonly>
          </div>
          <div>
            <div class="mut">Часов в день</div>
            <input id="hoursPerDay" inputmode="numeric" value="8">
          </div>
        </div>
        <div class="mtt">
          <div class="mut">Среднедневной (для отпуска), ₽ — необязательное поле</div>
          <input id="avgDaily" inputmode="decimal" placeholder="если пусто — считаем автоматически за 12 мес.">
        </div>
        <div class="row mtt">
  <button class="btn primary" id="saveSettings">Сохранить настройки</button>
  <button class="btn" id="openArchive">Архив</button>
</div>
      </div>
    </section>

    <!-- HOLIDAYS -->
    <section id="holidays" class="tabpage" hidden>
      <div class="card">
        <div class="mut">Отметьте праздничные дни кликом (сохраняются по месяцам).</div>
        <div class="cal-head">
          <button class="btn" id="hPrev">◀ Предыдущий</button>
          <div class="cal-title" id="h-title"></div>
          <button class="btn" id="hNext">Следующий ▶</button>
        </div>
        <div class="cal-dow" id="h-dow"></div>
        <div class="cal-grid" id="h-grid"></div>
      </div>
    </section>

        <!-- Modal: Архив -->
<div id="archiveModal" class="modal" hidden>
  <div class="modal-backdrop" data-close></div>
 <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="archiveTitle">
  <button class="modal-close" data-close aria-label="Закрыть">×</button>
  <div class="modal-head" id="archiveTitle">Архив выплат</div>
  
    <div class="modal-row">
      <div>
        <div class="mut">Месяц</div>
        <select id="archMonth"></select>
      </div>
      <div>
        <div class="mut">Год</div>
        <input id="archYear" inputmode="numeric" />
      </div>
      <div>
        <button class="btn primary wide" id="archShow">Показать</button>
      </div>
    </div>

    <div class="small-note">История строится по вашим записям (подработки, отгулы, отпуск) и настройкам зарплаты/часов.</div>

    <div id="archResult"></div>

    <div class="row mtt">
      <button class="btn" data-close>Закрыть</button>
    </div>
  </div>
</div>
    <!-- IMPORT -->
<section id="import" class="tabpage" hidden>
  <div class="card">
    <div class="import-grid">
      <div class="file-wrap">
        <label for="file" class="btn">Выбрать файл</label>
        <span class="file-name" id="fileName" aria-live="polite">файл не выбран</span>
        <input id="file" type="file" accept="application/json" class="file-input">
      </div>

      <div class="buttons-row">
        <button class="btn" id="btnExport">Экспорт JSON</button>
        <button class="btn primary" id="btnImport">Импорт</button>
      </div>
    </div>

    <div class="mut mtt">Экспорт включает записи, праздники и базовые настройки.</div>
  </div>
</section>

<script>
/* ================== STATE & STORAGE ================== */
function ymd(d){return d.toISOString().slice(0,10)}
function pad2(n){return String(n).padStart(2,'0')}
function ymStr(y,m){return `${y}-${pad2(m+1)}`}
function makeId(){return Math.random().toString(36).slice(2,9)+Date.now().toString(36)}
const LS_KEYS = { entries:'entries', holidays:'holidays', settings:'settings' };
function loadEntries(){try{return JSON.parse(localStorage.getItem(LS_KEYS.entries)||'[]')}catch(e){return[]}}
function saveEntries(a){localStorage.setItem(LS_KEYS.entries,JSON.stringify(a))}
function loadHolidays(){try{return JSON.parse(localStorage.getItem(LS_KEYS.holidays)||'{}')}catch(e){return{}}}
function saveHolidays(m){localStorage.setItem(LS_KEYS.holidays,JSON.stringify(m))}
function loadSettings(){try{return JSON.parse(localStorage.getItem(LS_KEYS.settings)||'{}')}catch(e){return{}}}
function saveSettingsObj(o){localStorage.setItem(LS_KEYS.settings,JSON.stringify(o))}

/* default settings */
const defaultSettings = { salary:null, workdays:22, hoursPerDay:8, avgDaily:null };
const settings = Object.assign({}, defaultSettings, loadSettings());

/* selected date / month */
const today = new Date();
const state = {
  year: today.getFullYear(),
  month: today.getMonth(),
  get ym(){return ymStr(this.year,this.month)},
  selectedDate: ymd(today),
  holidays: loadHolidays()
};

/* === util === */
function daysInMonth(y,m){ return new Date(y,m+1,0).getDate() }
function isWeekday(y,m,d){ const dow=new Date(y,m,d).getDay(); return dow>=1 && dow<=5; }
function computeWorkdays(y,m){
  const days=daysInMonth(y,m); let wd=0;
  for(let d=1; d<=days; d++) if(isWeekday(y,m,d)) wd++;
  const hol=(state.holidays[ymStr(y,m)]||[]);
  const weekdayHols=hol.filter(d=>isWeekday(y,m,d)).length;
  return Math.max(0, wd - weekdayHols);
}
function updateWorkdaysForCurrentMonth(){
  const wd = computeWorkdays(state.year, state.month);
  settings.workdays = wd; saveSettingsObj(settings);
  const el=document.getElementById('workdays'); if(el) el.value = wd;
}

/* ================== TABS ================== */
const tabBtns=[...document.querySelectorAll('.tab')];
const tabPages=[...document.querySelectorAll('.tabpage')];
tabBtns.forEach(b=>b.onclick=()=>{
  tabBtns.forEach(x=>x.classList.remove('active'));
  tabPages.forEach(s=>s.hidden=true);
  b.classList.add('active');
  document.getElementById(b.dataset.tab).hidden=false;
  if(b.dataset.tab==='holidays'){renderHolidaysCalendar(hYear,hMonth)}
  if(b.dataset.tab==='settings'){updateWorkdaysForCurrentMonth()}
        // если открыт архив — закрываем
  if(!modal.hidden) closeArchive();
});

function setTodayUi(){
  document.getElementById('dt').value = new Date(state.selectedDate)
    .toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
}
document.getElementById('btnToday').onclick=()=>{
  const t = new Date();
  state.year=t.getFullYear(); state.month=t.getMonth(); state.selectedDate=ymd(t);
  setTodayUi(); renderCalendar(state.year,state.month); renderDayDetails(state.selectedDate);
  updateWorkdaysForCurrentMonth();
};

/* SETTINGS */
document.getElementById('salary').value = settings.salary ?? '';
document.getElementById('hoursPerDay').value = settings.hoursPerDay;
document.getElementById('avgDaily').value = settings.avgDaily??'';
updateWorkdaysForCurrentMonth();
document.getElementById('saveSettings').onclick = () => {
  const salaryStr = document.getElementById('salary').value.trim();
  settings.salary = salaryStr === '' ? null : Number(salaryStr);

  settings.hoursPerDay = Number(document.getElementById('hoursPerDay').value || 0);

  const a = document.getElementById('avgDaily').value.trim();
  settings.avgDaily = a === '' ? null : (Number(a.replace(',','.')) || null);

  saveSettingsObj(settings);
  renderDayDetails(state.selectedDate);
  alert('Сохранено.');
};

/* ADD / UPDATE / DELETE */
function addOrUpdateWork(dateISO, hoursVal){
  const list = loadEntries();
  const idx  = list.findIndex(e => e.date === dateISO && e.kind === 'work');
  const rec  = {
    id:   idx > -1 ? list[idx].id : makeId(),
    date: dateISO,
    kind: 'work',
    hours: Number(hoursVal) || 0
  };
  if (idx > -1) list[idx] = rec; else list.push(rec);
  saveEntries(list);
}

function addOffHours(dateISO, hoursVal){
  const list = loadEntries();
  list.push({ id: makeId(), date: dateISO, kind: 'offHours', hours: Number(hoursVal) || 0 });
  saveEntries(list);
}
function toggleVacation(dateISO){
  const list=loadEntries();
  const idx=list.findIndex(e=>e.date===dateISO && e.kind==='vacation');
  if(idx>-1) list.splice(idx,1);
  else list.push({ id:makeId(), date:dateISO, kind:'vacation', hours:0 });
  saveEntries(list);
}
function deleteEntryById(id){
  const list=loadEntries();
  const i=list.findIndex(e=>e.id===id);
  if(i>-1){ list.splice(i,1); saveEntries(list) }
}
function bindDeleteButtons(){
  document.querySelectorAll('[data-del-id]').forEach(b=>{
    b.onclick=()=>{ deleteEntryById(b.dataset.delId); renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month); };
  });
}

/* inputs */
document.getElementById('btnAdd').onclick=()=>{
  const h = Number(document.getElementById('hours').value.replace(',','.'))||0;
  if(h<=0) return;
  addOrUpdateWork(state.selectedDate,h);
  document.getElementById('hours').value='';
  renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month);
};
document.getElementById('quick').onclick=(ev)=>{
  const b=ev.target.closest('button[data-qk]'); if(!b) return;
  const code=b.dataset.qk;
  if(code==='hrs-3.5') addOrUpdateWork(state.selectedDate,3.5);
  if(code==='hrs-8') addOrUpdateWork(state.selectedDate,8);
  if(code==='leave-hours'){
    const n = Number((prompt('Отгул (часы):','2')||'').replace(',','.'))||0;
    if(n>0) addOffHours(state.selectedDate,n);
  }
  if(code==='vacation') toggleVacation(state.selectedDate);
  renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month);
};

/* CALENDAR */
function renderCalendar(y,m){
  const titleEl = document.getElementById('cal-title');
const d = new Date(y,m,1);
const month = d.toLocaleDateString('ru-RU',{month:'long'});
const year  = d.getFullYear();
titleEl.innerHTML = `${month}<span class="year">${year} г.</span>`;

  document.getElementById('cal-dow').innerHTML =
    ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'].map(d=>`<span>${d}</span>`).join('');

  const grid=document.getElementById('cal-grid'); grid.innerHTML='';
  const first=new Date(y,m,1);
  const startCol=(first.getDay()+6)%7;
  const n=daysInMonth(y,m);
  const entries=loadEntries();
  const hol = state.holidays[ymStr(y,m)] || [];

  for(let i=0;i<startCol;i++){
    const d=document.createElement('div'); d.className='cal-day'; d.style.visibility='hidden'; grid.appendChild(d);
  }
  for(let day=1; day<=n; day++){
    const dateISO=`${y}-${pad2(m+1)}-${pad2(day)}`;
    const hasWork=entries.some(e=>e.date===dateISO && e.kind==='work');
    const hasLeave=entries.some(e=>e.date===dateISO && e.kind==='offHours');
    const hasVac=entries.some(e=>e.date===dateISO && e.kind==='vacation');
    const isHol=hol.includes(day);
    const badge=(hasWork?'🛠️':'')+(hasLeave?' ⛔':'')+(hasVac?' 🏖️':'')+(isHol?' 🎉':'');

    const btn=document.createElement('button');
    btn.className='cal-day';
    if(dateISO===state.selectedDate) btn.classList.add('selected');
    btn.innerHTML=`<span class="num">${day}</span><div class="badge">${badge}</div>`;
    btn.onclick=()=>{ state.selectedDate=dateISO; setTodayUi(); renderCalendar(y,m); renderDayDetails(dateISO); };
    grid.appendChild(btn);
  }
}
document.getElementById('prevM').onclick=()=>{ state.month--; if(state.month<0){state.month=11;state.year--} renderCalendar(state.year,state.month); updateWorkdaysForCurrentMonth(); }
document.getElementById('nextM').onclick=()=>{ state.month++; if(state.month>11){state.month=0;state.year++} renderCalendar(state.year,state.month); updateWorkdaysForCurrentMonth(); }

/* TOTALS + LIST */
      /* ===== ARCHIVE: helpers for arbitrary month ===== */
function hourRateFor(y,m){
  const wd  = Math.max(1, computeWorkdays(y,m));
  const hpd = Math.max(1, Number(settings.hoursPerDay||8));
  const sal = Number(settings.salary||0);
  return (wd*hpd) > 0 ? sal/(wd*hpd) : 0;
}

// среднедневной для конкретного месяца (скользящие 12 мес «до» выбранного)
function autoAverageDailyFor(y,m){
  const anchor = new Date(y, m, 1);
  let sum = 0;
  for(let i=1;i<=12;i++){
    const d = new Date(anchor); d.setMonth(anchor.getMonth()-i);
    sum += monthAccruals(d.getFullYear(), d.getMonth());
  }
  return sum / (29.3 * 12);
}
function avgDailyFor(y,m){
  if(settings.avgDaily!=null) return Number(settings.avgDaily)||0;
  return autoAverageDailyFor(y,m);
}

// расчёт итогов по выбранному месяцу
function totalsForMonth(y,m){
  const ym = ymStr(y,m);
  const list = loadEntries().filter(e => e.date.slice(0,7) === ym);

  let workH = 0, offH = 0;
  const vacDays = [];

  list.forEach(e=>{
    if(e.kind === 'work') workH += Number(e.hours||0);
    else if(e.kind === 'offHours') offH += Number(e.hours||0);
    else if(e.kind === 'vacation') vacDays.push(Number(e.date.slice(8,10)));
  });

  const hol = state.holidays[ym] || [];
  const rate = hourRateFor(y,m);
  const dayFromSalary = Number(settings.salary||0) / Math.max(1, computeWorkdays(y,m));

  const vacPaidDays = vacDays.filter(d => !hol.includes(d)).length;
  const vacWeekdays = vacDays.filter(d => isWeekday(y,m,d)).length;

  const payWork = workH * rate;
  const payVac  = avgDailyFor(y,m) * vacPaidDays;
  const base    = Math.max(0, Number(settings.salary||0) - offH*rate - vacWeekdays*dayFromSalary);
  const total   = base + payWork + payVac;

  return { workH, offH, vacPaidDays, vacWeekdays, rate, payWork, payVac, base, total };
}

// генерация списочка по дням
function monthEntriesList(y,m){
  const ym = ymStr(y,m);
  const list = loadEntries().filter(e => e.date.slice(0,7) === ym)
                 .sort((a,b)=>a.date.localeCompare(b.date));
  const byDay = new Map();
  list.forEach(e=>{
    const d = Number(e.date.slice(8,10));
    if(!byDay.has(d)) byDay.set(d, []);
    byDay.get(d).push(e);
  });
  return [...byDay.entries()].map(([d,items])=>{
    const label = `${String(d).padStart(2,'0')}.${String(m+1).padStart(2,'0')}.${y}`;
    const text = items.map(e=>{
      const icon = e.kind==='work'?'🛠️':(e.kind==='offHours'?'⛔':'🏖️');
      const hrs  = e.kind==='vacation' ? '' : ` — ${Number(e.hours||0)} ч`;
      const title= e.kind==='work'?'Подработка':(e.kind==='offHours'?'Отгул':'Отпуск');
      return `${icon} ${title}${hrs}`;
    }).join(', ');
    return { label, text };
  });
}
function currentHourRate(){
  const wd = Math.max(1, Number(settings.workdays||22));
  const hpd= Math.max(1, Number(settings.hoursPerDay||8));
  const sal= Number(settings.salary||0);
  return wd*hpd>0 ? sal/(wd*hpd) : 0;
}
function monthAccruals(y,m){
  const ym = ymStr(y,m);
  const list = loadEntries().filter(e=>e.date.slice(0,7)===ym);
  const rate = currentHourRate();
  let workH = 0;
  list.forEach(e=>{ if(e.kind==='work') workH += Number(e.hours||0); });
  const overtimePay = workH * rate;
  return Number(settings.salary||0) + overtimePay;
}
function autoAverageDaily(){
  const anchor = new Date(state.year, state.month, 1);
  let sum = 0;
  for(let i=1;i<=12;i++){
    const d = new Date(anchor); d.setMonth(anchor.getMonth()-i);
    sum += monthAccruals(d.getFullYear(), d.getMonth());
  }
  return sum / (29.3 * 12);
}
function avgDaily(){
  if(settings.avgDaily!=null) return Number(settings.avgDaily)||0;
  return autoAverageDaily();
}
function calcTotals(dateISO){
  const y = Number(dateISO.slice(0,4));
  const m = Number(dateISO.slice(5,7)) - 1;
  const ym = dateISO.slice(0,7);

  const list = loadEntries().filter(e => e.date.slice(0,7) === ym);

  let workH = 0, offH = 0;
  const vacDays = [];

  list.forEach(e=>{
    if(e.kind === 'work') workH += Number(e.hours||0);
    else if(e.kind === 'offHours') offH += Number(e.hours||0);
    else if(e.kind === 'vacation') vacDays.push(Number(e.date.slice(8,10)));
  });

  const rate = currentHourRate();
  const dayFromSalary = Number(settings.salary||0) / Math.max(1, Number(settings.workdays||22));
  const hol = state.holidays[ymStr(y,m)] || [];

  const vacPaidDays = vacDays.filter(d => !hol.includes(d)).length;
  const vacWeekdays = vacDays.filter(d => isWeekday(y,m,d)).length;

  const payWork = workH * rate;
  const payVac  = avgDaily() * vacPaidDays;

  const base = Math.max(0, Number(settings.salary||0) - offH*rate - vacWeekdays*dayFromSalary);
  const total = base + payWork + payVac;
  return { workH, offH, vacPaidDays, vacWeekdays, rate, payWork, payVac, base, total };
}
function renderDayDetails(dateISO){
  const box=document.getElementById('day-list');
  const list=loadEntries().filter(e=>e.date===dateISO);
  const label=new Date(dateISO).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  let html=`<h3 style="margin:6px 0 10px">${label}</h3>`;
  if(list.length===0){ html+=`<div class="mut">Записей нет.</div>`; }
  else{
    html+=list.map(e=>{
      const icon = e.kind==='work'?'🛠️':(e.kind==='offHours'?'⛔':'🏖️');
      const title= e.kind==='work'?'Подработка':(e.kind==='offHours'?'Отгул':'Отпуск');
      const hrs  = e.kind==='vacation'?'—':Number(e.hours||0).toFixed(2);
      return `<div class="rowline">
        <div><span class="pill">${icon}</span> ${title}</div>
        <div class="hours">${hrs}</div>
        <div class="actions"><button class="btn danger" data-del-id="${e.id}">Удалить</button></div>
      </div>`;
    }).join('');
  }
  box.innerHTML=html;
  bindDeleteButtons();

  const t=calcTotals(dateISO);
  document.getElementById('totals').innerHTML = `
    <span class="pill">База: ${t.base.toLocaleString('ru-RU')} ₽</span>
    <span class="pill">Почасовая: ${t.rate.toFixed(0)} ₽/ч</span>
    <span class="pill">Подработки: ${t.payWork.toLocaleString('ru-RU')} ₽ (часы: ${t.workH.toFixed(2)})</span>
    <span class="pill">Отгул: ${t.offH.toFixed(2)} ч</span>
    <span class="pill">Отпуск: ${t.payVac.toLocaleString('ru-RU')} ₽ (дн.: ${t.vacPaidDays})</span>
    <span class="pill" style="font-weight:700">Итого: ${t.total.toLocaleString('ru-RU')} ₽</span>
  `;
}

/* HOLIDAYS */
let hYear=state.year, hMonth=state.month;
function renderHolidaysCalendar(y,m){
  const t = document.getElementById('h-title');
const d = new Date(y,m,1);
const month = d.toLocaleDateString('ru-RU',{month:'long'});
const year  = d.getFullYear();
t.innerHTML = `${month}<span class="year">${year} г.</span>`;

  document.getElementById('h-dow').innerHTML =
    ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'].map(d=>`<span>${d}</span>`).join('');
  const grid=document.getElementById('h-grid'); grid.innerHTML='';
  const first=new Date(y,m,1);
  const startCol=(first.getDay()+6)%7, n=daysInMonth(y,m);
  const key = ymStr(y,m);
  const arr = (state.holidays[key] || []).slice();

  for(let i=0;i<startCol;i++){ const d=document.createElement('div'); d.className='cal-day'; d.style.visibility='hidden'; grid.appendChild(d); }
  for(let day=1; day<=n; day++){
    const btn=document.createElement('button'); btn.className='cal-day';
    const isHol=arr.includes(day);
    btn.innerHTML=`<span class="num">${day}</span><div class="badge">${isHol?'🎉':''}</div>`;
    btn.onclick = () => {
  const list = state.holidays[key] || [];
  const i = list.indexOf(day);
  if (i > -1) list.splice(i, 1); else list.push(day);
  state.holidays[key] = list.sort((a,b)=>a-b);
  saveHolidays(state.holidays);

  // Перерисовали сетку праздников
  renderHolidaysCalendar(y, m);

  // 1) ВСЕГДА обновляем "Рабочих дней в текущем месяце"
  //    (текущий месяц = тот, что открыт в журнале)
  updateWorkdaysForCurrentMonth();

  // 2) Если правим именно тот месяц, который сейчас открыт в журнале —
  //    перерисуем календарь и итоги за выбранный день,
  //    чтобы ставка/итоги пересчитались сразу.
  if (y === state.year && m === state.month) {
    renderCalendar(state.year, state.month);
    renderDayDetails(state.selectedDate);
  }
};
    grid.appendChild(btn);
  }
}
document.getElementById('hPrev').onclick=()=>{ hMonth--; if(hMonth<0){hMonth=11;hYear--} renderHolidaysCalendar(hYear,hMonth) }
document.getElementById('hNext').onclick=()=>{ hMonth++; if(hMonth>11){hMonth=0;hYear++} renderHolidaysCalendar(hYear,hMonth) }

/* IMPORT / EXPORT */
document.getElementById('btnExport').onclick=()=>{
  const payload = { entries: loadEntries(), holidays: loadHolidays(), settings };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paycalc_data.json'; a.click();
  URL.revokeObjectURL(a.href);
};
document.getElementById('btnImport').onclick=()=>{
  const f=document.getElementById('file').files?.[0];
  if(!f) return alert('Выберите файл JSON');
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(Array.isArray(data.entries)) saveEntries(data.entries); else saveEntries([]);
      if(data.holidays && typeof data.holidays==='object') saveHolidays(data.holidays);
      if(data.settings && typeof data.settings==='object'){
        Object.assign(settings, defaultSettings, data.settings); saveSettingsObj(settings);
      }
      alert('Импорт выполнен');
      renderCalendar(state.year,state.month); renderDayDetails(state.selectedDate);
      updateWorkdaysForCurrentMonth();
    }catch(e){ alert('Ошибка импорта: '+e.message) }
  };
  r.readAsText(f);
};

      // Показываем имя выбранного файла в UI
const fileInput  = document.getElementById('file');
const fileNameEl = document.getElementById('fileName');
if (fileInput && fileNameEl){
  fileInput.addEventListener('change', () => {
    fileNameEl.textContent = fileInput.files?.[0]?.name || 'файл не выбран';
  });
}
      
/* INIT */
function renderHolidaysCalendarInit(){ renderHolidaysCalendar(hYear,hMonth); }
setTodayUi();
renderCalendar(state.year,state.month);
renderDayDetails(state.selectedDate);
renderHolidaysCalendarInit();
updateWorkdaysForCurrentMonth();

      /* ===== ARCHIVE: UI ===== */
const modal = document.getElementById('archiveModal');
const archMonthSel = document.getElementById('archMonth');
const archYearInp  = document.getElementById('archYear');
const archShowBtn  = document.getElementById('archShow');
const archResult   = document.getElementById('archResult');

function openArchive(){
  if(archMonthSel && archMonthSel.options.length === 0){
    const months = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
    months.forEach((name,i)=>{
      const opt=document.createElement('option');
      opt.value = i; opt.textContent = name; archMonthSel.appendChild(opt);
    });
  }
  archMonthSel.value = String(state.month);
  archYearInp.value  = String(state.year);

  modal.hidden = false;
  document.body.classList.add('no-scroll');   // ← блокируем прокрутку фона
  // по желанию: сразу показать расчёт
  // renderArchive();
        archMonthSel?.focus();
}

function closeArchive(){
  modal.hidden = true;
  document.body.classList.remove('no-scroll'); // ← возвращаем прокрутку фона
}
function renderArchive(){
  const y = Number(archYearInp.value||state.year);
  const m = Number(archMonthSel.value||state.month);

  const t = totalsForMonth(y,m);
  const items = monthEntriesList(y,m);

  const head = new Date(y,m,1).toLocaleDateString('ru-RU',{month:'long', year:'numeric'});
  let html = `<h3 style="margin:10px 0 6px">${head}</h3>`;

  html += `
    <div class="archive-totals">
      <span class="pill">База: ${t.base.toLocaleString('ru-RU')} ₽</span>
      <span class="pill">Почасовая: ${t.rate.toFixed(0)} ₽/ч</span>
      <span class="pill">Подработки: ${t.payWork.toLocaleString('ru-RU')} ₽ (часы: ${t.workH.toFixed(2)})</span>
      <span class="pill">Отгул: ${t.offH.toFixed(2)} ч</span>
      <span class="pill">Отпуск: ${t.payVac.toLocaleString('ru-RU')} ₽ (дн.: ${t.vacPaidDays})</span>
      <span class="pill" style="font-weight:700">Итого: ${t.total.toLocaleString('ru-RU')} ₽</span>
    </div>
  `;

  if(items.length){
    html += `<div class="archive-list">` +
      items.map(it=>`
        <div class="archive-item">
          <div>${it.label}</div>
          <div class="r">${it.text}</div>
        </div>
      `).join('') +
    `</div>`;
  }else{
    html += `<div class="mut" style="margin-top:10px">Записей за выбранный месяц нет.</div>`;
  }

  archResult.innerHTML = html;
}

// кнопки
document.getElementById('openArchive')?.addEventListener('click', openArchive);
modal?.addEventListener('click', (e)=>{
  if(e.target.matches('[data-close]')) closeArchive();
});
archShowBtn?.addEventListener('click', renderArchive);
/* PWA register */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
  // Глушим быстрый повторный тап (двойной) — не даём браузеру включить зум
(function preventDoubleTapZoom(){
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (e) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();   // блокируем "второй" тап
    }
    lastTouchEnd = now;
  }, { passive: false });
})();
</script>
</body>
</html>
