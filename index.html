<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</title>
<meta name="theme-color" content="#0f1115">
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#0f1115;--card:#151922;--muted:#8b93a7;--text:#e9edf5;--accent:#4888ff;
    --ok:#18c38a;--warn:#ffb020;--bad:#ff5d5d;--ring:#2c66ff33;--chip:#1e2430;
    --chip-bd:#2a3344;--chip-hi:#202838;--badge:#26324b;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  h1{margin:0 0 6px;font-size:28px}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;align-items:center}
  .tabs{display:flex;gap:10px;margin:12px 0 16px}
  .tab{padding:10px 16px;border-radius:12px;background:var(--chip);border:1px solid var(--chip-bd);color:var(--text);cursor:pointer}
  .tab.active{background:var(--accent);border-color:transparent;color:#fff}
  .card{background:var(--card);border:1px solid #1f2633;border-radius:16px;padding:16px;margin:12px 0}
  label{display:block;margin:8px 0 6px;color:var(--muted)}
  input,select,button{font:inherit}
  .inp{width:100%;padding:10px 12px;border-radius:12px;background:#111726;border:1px solid #243044;color:var(--text);outline:none}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 18px;border-radius:12px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .btn.secondary{background:var(--chip);color:var(--text);border:1px solid var(--chip-bd)}
  .btn.danger{background:#7a1f2a}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-2-rows{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:1fr;gap:12px}
  .quick .q{padding:16px;border-radius:14px;background:var(--chip);border:1px solid var(--chip-bd);text-align:center;cursor:pointer}
  .section-title{font-weight:600;margin:0 0 12px}
  /* calendar */
  .cal{padding:12px}
  .cal-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .cal-title{font-size:22px;font-weight:700}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .dow{color:var(--muted);text-align:center;font-size:12px}
  .day{position:relative;height:56px;border-radius:16px;background:#141a25;border:1px solid #222b3b;display:flex;align-items:center;justify-content:center}
  .day.today{outline:2px solid var(--ring)}
  .day.has .badge{position:absolute;bottom:4px;left:50%;transform:translateX(-50%);font-size:14px;background:var(--badge);border-radius:10px;padding:2px 6px}
  .day .num{position:absolute;top:6px;left:10px;color:#d8deea}
  .legend{color:var(--muted);font-size:13px;margin-top:10px}
  .table{width:100%;border-collapse:collapse;margin-top:8px}
  .table th,.table td{padding:10px;border-top:1px solid #233040}
  .muted{color:var(--muted)}
  .right{float:right}
  .hr{height:1px;background:#202838;margin:12px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);border:1px solid var(--chip-bd);padding:6px 10px;border-radius:999px;font-size:13px}
  .footer{margin-top:18px;color:var(--muted);font-size:12px}
  @media (max-width:560px){
    .row.stack{flex-direction:column;align-items:stretch}
  }
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div>
      <h1>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏</h1>
      <div class="muted" style="margin-top:-4px">–∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</div>
    </div>
    <div id="jsOk" class="chip" style="background:#0c2a18;border-color:#124228;color:#b6f5d6">JS —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ</div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="journal">–ñ—É—Ä–Ω–∞–ª</button>
    <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="tab" data-tab="holidays">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
    <button class="tab" data-tab="import">–ò–º–ø–æ—Ä—Ç</button>
  </div>

  <!-- JOURNAL -->
  <section id="journal" class="card">
    <div class="row stack">
      <div style="flex:1">
        <label>–î–∞—Ç–∞</label>
        <div class="row">
          <input id="date" class="inp" type="date" style="flex:1">
          <button id="btnToday" class="btn secondary" style="margin-left:8px">–°–µ–≥–æ–¥–Ω—è</button>
        </div>
      </div>
      <div style="flex:1">
        <label>–ß–∞—Å—ã</label>
        <input id="hours" inputmode="decimal" class="inp" placeholder="–Ω–∞–ø—Ä., 3.5">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="add" class="btn" style="width:100%">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="card" style="background:#111827;border-color:#1c2534;margin-top:14px">
      <div class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ ¬´–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞¬ª):</div>
      <div class="grid-2-rows quick" id="quickBox">
        <div class="q" data-q="hrs-3.5">3.5 —á</div>
        <div class="q" data-q="hrs-8">8 —á</div>
        <div class="q" data-q="dayoff">–û—Ç–≥—É–ª</div>
        <div class="q" data-q="vac">–û—Ç–ø—É—Å–∫</div>
      </div>
    </div>

    <div class="card cal" id="calCard">
      <div class="cal-top">
        <button id="prev" class="btn secondary">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
        <div id="monthTitle" class="cal-title"></div>
        <button id="next" class="btn secondary">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
      </div>
      <div class="cal-grid" id="calHead"></div>
      <div class="hr"></div>
      <div class="legend">üî® ‚Äî –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞; üö´ ‚Äî –æ—Ç–≥—É–ª (—á–∞—Å—ã); üèñÔ∏è ‚Äî –æ—Ç–ø—É—Å–∫; üéâ ‚Äî –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π.</div>
    </div>

    <div id="dayTitle" class="section-title">‚Äî</div>
    <table class="table" id="list">
      <thead><tr><th>–¢–∏–ø</th><th>–ß–∞—Å—ã</th><th class="right">–û–ø–ª–∞—Ç–∞</th><th class="right">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="hr"></div>
    <div id="totals">
      <div class="section-title">–ò—Ç–æ–≥–∏</div>
      <div class="chips" id="totChips"></div>
      <div style="margin-top:8px" id="grand" class="section-title">–ò—Ç–æ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ: ‚Äî</div>
      <div class="muted" id="avgHint"></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="card hidden">
    <div class="row stack">
      <div style="flex:1">
        <label>–û–∫–ª–∞–¥ (–Ω–∞ —Ä—É–∫–∏), ‚ÇΩ</label>
        <input id="salary" class="inp" inputmode="numeric" placeholder="97000">
      </div>
      <div style="flex:1">
        <label>–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (–∞–≤—Ç–æ, –ü–Ω‚Äì–ü—Ç)</label>
        <input id="workdays" class="inp" disabled>
      </div>
    </div>

    <div class="row stack">
      <div style="flex:1">
        <label>–ß–∞—Å–æ–≤ –≤ –¥–Ω–µ</label>
        <input id="hoursInDay" class="inp" value="8" inputmode="numeric">
      </div>
      <div style="flex:1">
        <label>–¢–∏–ø –æ—Ç–ø—É—Å–∫–∞</label>
        <select id="leaveKind" class="inp">
          <option value="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π (–≤—Å–µ –¥–Ω–∏)</option>
          <option value="working">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π (—Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏)</option>
        </select>
      </div>
    </div>

    <div class="row stack">
      <div style="flex:1">
        <label>–ë—É–¥–Ω–∏ ‚Äî –ø–µ—Ä–≤—ã–µ 2 —á</label>
        <input id="multW12" class="inp" value="1.5" inputmode="decimal">
      </div>
      <div style="flex:1">
        <label>–ë—É–¥–Ω–∏ ‚Äî –¥–∞–ª—å—à–µ</label>
        <input id="multW2p" class="inp" value="2" inputmode="decimal">
      </div>
    </div>

    <div class="row stack">
      <div style="flex:1">
        <label>–°—É–±–±–æ—Ç–∞</label>
        <input id="multSat" class="inp" value="1.5" inputmode="decimal">
      </div>
      <div style="flex:1">
        <label>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</label>
        <input id="multSun" class="inp" value="2" inputmode="decimal">
      </div>
    </div>

    <div class="hr"></div>
    <div class="row stack">
      <button id="btnUpdate" class="btn">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
      <button id="btnReset" class="btn danger right">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
    </div>
    <div class="footer">v1.7 (calendar+dayoff icon fix)</div>
  </section>

  <!-- HOLIDAYS -->
  <section id="holidays" class="card hidden">
    <div class="section-title">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ –º–µ—Å—è—Ü–∞</div>
    <div class="muted">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: <span id="hMonth"></span>. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–µ–Ω—å –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.</div>
    <div class="card cal" style="margin-top:10px">
      <div class="cal-top">
        <button id="hPrev" class="btn secondary">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
        <div id="hTitle" class="cal-title"></div>
        <button id="hNext" class="btn secondary">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
      </div>
      <div class="cal-grid" id="hHead"></div>
    </div>
  </section>

  <!-- IMPORT -->
  <section id="import" class="card hidden">
    <div class="section-title">–ò–º–ø–æ—Ä—Ç / –≠–∫—Å–ø–æ—Ä—Ç</div>
    <div class="row" style="gap:10px">
      <button id="btnExport" class="btn secondary">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <label class="btn secondary" style="cursor:pointer">
        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        <input id="fileIn" type="file" accept="application/json" class="hidden">
      </label>
    </div>
  </section>
</div>

<script>
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const pad = n => n.toString().padStart(2,'0');
const mkISO = (y,m,d)=> `${y}-${pad(m)}-${pad(d)}`;
const todayISO = ()=> {
  const t=new Date(); return mkISO(t.getFullYear(),t.getMonth()+1,t.getDate());
};
const isoMonth = iso => iso.slice(0,7);

function monthBounds(ym){
  const [y,m]=ym.split('-').map(Number);
  const first=new Date(y,m-1,1);
  const days=new Date(y,m,0).getDate();
  const start=(first.getDay()+6)%7;
  return {y,m,first,days,start};
}

/* ---------- state ---------- */
const LSKEY = 'paycalc_state_v2';
const state = JSON.parse(localStorage.getItem(LSKEY) || '{}');

if(!state.settings){
  state.settings = {
    salary: 97000, hoursInDay:8,
    multW12:1.5, multW2p:2, multSat:1.5, multSun:2,
    leaveKind:'working', theme:'dark'
  };
}
if(!state.shifts) state.shifts = [];      // {date:'YYYY-MM-DD', type:'ot'|'vac'|'dayoff', hours:number}
if(!state.statuses) state.statuses = {};  // { 'YYYY-MM': {holidays:[iso], off:[iso], vac:[iso]} }
if(!state.month) state.month = isoMonth(todayISO());
if(!state.hmonth) state.hmonth = state.month;

save(); // ensure structure

/* ---------- UI refs ---------- */
const ui = {
  // tabs
  tabs: $$('.tab'),
  sections: { journal:$('#journal'), settings:$('#settings'), holidays:$('#holidays'), import:$('#import') },
  // journal
  date: $('#date'), btnToday: $('#btnToday'), hours: $('#hours'), add: $('#add'),
  monthTitle: $('#monthTitle'), calHead: $('#calHead'), prev: $('#prev'), next: $('#next'),
  dayTitle: $('#dayTitle'), tbody: $('#tbody'),
  quick: $$('#quickBox .q'),
  // totals
  chips: $('#totChips'), grand: $('#grand'), avgHint: $('#avgHint'),
  // settings
  salary: $('#salary'), workdays: $('#workdays'), hoursInDay: $('#hoursInDay'),
  multW12: $('#multW12'), multW2p: $('#multW2p'), multSat: $('#multSat'), multSun: $('#multSun'),
  leaveKind: $('#leaveKind'), btnUpdate: $('#btnUpdate'), btnReset: $('#btnReset'),
  // holidays
  hMonth: $('#hMonth'), hHead: $('#hHead'), hTitle: $('#hTitle'), hPrev: $('#hPrev'), hNext: $('#hNext'),
  // import/export
  btnExport: $('#btnExport'), fileIn: $('#fileIn')
};

/* ---------- tabs ---------- */
ui.tabs.forEach(t=>{
  t.addEventListener('click',()=>{
    ui.tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    Object.values(ui.sections).forEach(s=>s.classList.add('hidden'));
    ui.sections[t.dataset.tab].classList.remove('hidden');
    if(t.dataset.tab==='holidays') renderHolidayCalendar();
    if(t.dataset.tab==='settings')  renderSettings();
  });
});

/* ---------- settings bind ---------- */
function pullSettings(){
  const s=state.settings;
  ui.salary.value=s.salary;
  ui.hoursInDay.value=s.hoursInDay;
  ui.multW12.value=s.multW12; ui.multW2p.value=s.multW2p;
  ui.multSat.value=s.multSat; ui.multSun.value=s.multSun;
  ui.leaveKind.value=s.leaveKind;
}
function pushSettings(){
  const s=state.settings;
  s.salary=+ui.salary.value||0;
  s.hoursInDay=+ui.hoursInDay.value||8;
  s.multW12=parseFloat(ui.multW12.value)||1.5;
  s.multW2p=parseFloat(ui.multW2p.value)||2;
  s.multSat=parseFloat(ui.multSat.value)||1.5;
  s.multSun=parseFloat(ui.multSun.value)||2;
  s.leaveKind=ui.leaveKind.value;
  save(); recalcAndRender();
}

['salary','hoursInDay','multW12','multW2p','multSat','multSun','leaveKind']
  .forEach(id=> ui[id].addEventListener('change',pushSettings));

ui.btnReset.addEventListener('click',()=>{
  if(confirm('–°—Ç–µ—Ä–µ—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')){
    localStorage.removeItem(LSKEY);
    location.reload();
  }
});
ui.btnUpdate.addEventListener('click',()=>{
  // –ø—Ä–æ—Å—Ç–æ–π ¬´–ø–∏–Ω–æ–∫¬ª service worker + –∫—ç—à
  if('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.update()));
  caches && caches.keys && caches.keys().then(keys=>keys.forEach(k=>caches.delete(k)));
  location.reload(true);
});

/* ---------- utils save ---------- */
function save(){ localStorage.setItem(LSKEY, JSON.stringify(state));}

/* ---------- calendar render (Journal) ---------- */
function getStatuses(ym){ return (state.statuses[ym] ||= {holidays:[], off:[], vac:[]}); }
function isHoliday(iso){
  const ym=isoMonth(iso);
  const st=getStatuses(ym);
  return st.holidays.includes(iso);
}

function renderCalendar(){
  const ym=state.month, {y,m,days,start}=monthBounds(ym);
  ui.monthTitle.textContent=new Date(y,m-1,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
  ui.calHead.innerHTML='';
  ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(d=>{
    const el=document.createElement('div'); el.className='dow'; el.textContent=d; ui.calHead.appendChild(el);
  });
  for(let i=0;i<start;i++) ui.calHead.appendChild(document.createElement('div'));

  const today=todayISO();
  const st=getStatuses(ym);
  const offSet=new Set(st.off||[]), vacSet=new Set(st.vac||[]);
  for(let d=1; d<=days; d++){
    const iso=mkISO(y,m,d);
    const item=document.createElement('div'); item.className='day';
    if(iso===today) item.classList.add('today');

    const dayShifts=state.shifts.filter(s=>s.date===iso);
    const hasDayoff = dayShifts.some(s=>s.type==='dayoff');
    const hasOver   = dayShifts.some(s=>s.type==='ot');
    const isHol     = isHoliday(iso);

    let badge='', has=false;
    if(vacSet.has(iso)){ badge='üèñÔ∏è'; has=true; }
    else if(offSet.has(iso)){ badge='üö´'; has=true; }
    else if(isHol){ badge='üéâ'; has=true; }
    else if(hasDayoff){ badge='üö´'; has=true; }
    else if(hasOver){ badge='üî®'; has=true; }

    item.innerHTML=`<div class="num">${d}</div>${has?`<div class="badge">${badge}</div>`:''}`;
    if(has) item.classList.add('has');

    item.addEventListener('click',()=>{ ui.date.value=iso; renderDay(iso); });
    ui.calHead.appendChild(item);
  }
}

/* ---------- Holiday calendar ---------- */
function renderHolidayCalendar(){
  const ym=state.hmonth, {y,m,days,start}=monthBounds(ym);
  ui.hTitle.textContent=new Date(y,m-1,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
  ui.hMonth.textContent=ym;
  ui.hHead.innerHTML='';
  ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(d=>{
    const el=document.createElement('div'); el.className='dow'; el.textContent=d; ui.hHead.appendChild(el);
  });
  for(let i=0;i<start;i++) ui.hHead.appendChild(document.createElement('div'));

  const st=getStatuses(ym);
  const set=new Set(st.holidays||[]);
  for(let d=1; d<=days; d++){
    const iso=mkISO(y,m,d);
    const el=document.createElement('div'); el.className='day';
    const isHol=set.has(iso);
    el.innerHTML=`<div class="num">${d}</div>${isHol?`<div class="badge">üéâ</div>`:''}`;
    if(isHol) el.classList.add('has');
    el.addEventListener('click',()=>{
      if(set.has(iso)) set.delete(iso); else set.add(iso);
      st.holidays=[...set]; save(); recalcAndRender(); renderHolidayCalendar();
    });
    ui.hHead.appendChild(el);
  }
}
ui.hPrev.addEventListener('click',()=>{shiftMonth('hmonth',-1); renderHolidayCalendar();});
ui.hNext.addEventListener('click',()=>{shiftMonth('hmonth',+1); renderHolidayCalendar();});

/* ---------- month shift ---------- */
function shiftMonth(field,delta){
  const [y,m]=state[field].split('-').map(Number);
  const dt=new Date(y,m-1,1); dt.setMonth(dt.getMonth()+delta);
  state[field]=mkISO(dt.getFullYear(),dt.getMonth()+1,1).slice(0,7);
  save();
}

/* ---------- quick buttons ---------- */
ui.quick.forEach(b=>{
  b.addEventListener('click',()=>{
    const iso=ui.date.value || todayISO();
    if(b.dataset.q.startsWith('hrs-')){
      ui.hours.value = b.dataset.q.split('-')[1].replace('_','.');
      addShift('ot');
    }else if(b.dataset.q==='dayoff'){
      const h = prompt('–°–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ ¬´–æ—Ç–≥—É–ª–∞¬ª –≤—ã—á–µ—Å—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä 3.5)','3.5');
      if(h && !isNaN(h)){
        ui.hours.value = h;
        addShift('dayoff');
      }
    }else if(b.dataset.q==='vac'){
      toggleDayVacation(iso);
    }
  });
});

/* ---------- add/remove/edit ---------- */
ui.add.addEventListener('click',()=> addShift('auto'));
ui.btnToday.addEventListener('click',()=>{ ui.date.value=todayISO(); renderDay(ui.date.value); });
ui.prev.addEventListener('click',()=>{ shiftMonth('month',-1); recalcAndRender(); });
ui.next.addEventListener('click',()=>{ shiftMonth('month',+1); recalcAndRender(); });

function addShift(kind){
  const iso=ui.date.value || todayISO();
  const hours=parseFloat(ui.hours.value.replace(',','.'))||0;
  if(kind==='auto' || kind==='ot'){
    if(hours<=0){ alert('–£–∫–∞–∂–∏—Ç–µ —á–∞—Å—ã'); return; }
  }
  let type = (kind==='auto'||kind==='ot') ? 'ot' : (kind==='dayoff'?'dayoff':'ot');

  state.shifts.push({date:iso,type, hours});
  save(); ui.hours.value=''; renderDay(iso); recalcAndRender();
}

function toggleDayVacation(iso){
  const st=getStatuses(isoMonth(iso));
  const set=new Set(st.vac||[]);
  if(set.has(iso)) set.delete(iso); else set.add(iso);
  st.vac=[...set]; save(); recalcAndRender(); renderDay(iso);
}

function removeShift(idx){
  state.shifts.splice(idx,1);
  save(); renderDay(ui.date.value||todayISO()); recalcAndRender();
}

/* ---------- render day list ---------- */
function renderDay(iso){
  if(!iso) iso=todayISO();
  ui.date.value=iso;
  ui.dayTitle.textContent = new Date(iso+'T00:00:00').toLocaleDateString('ru-RU',{dateStyle:'full'});

  const rows = state.shifts.map((s,i)=>({...s, _i:i})).filter(s=>s.date===iso);
  ui.tbody.innerHTML = rows.map(r=>{
    const title = r.type==='ot' ? '–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞' : (r.type==='dayoff'?'–û—Ç–≥—É–ª':'‚Äî');
    const pay = fmtMoney(r.type==='ot' ? payOver(r) : 0);
    return `<tr>
      <td>${title}</td>
      <td>${r.hours.toFixed(2)}</td>
      <td class="right">${pay}</td>
      <td class="right"><button class="btn secondary" data-del="${r._i}">–£–¥–∞–ª–∏—Ç—å</button></td>
    </tr>`;
  }).join('') || `<tr><td colspan="4" class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</td></tr>`;

  ui.tbody.querySelectorAll('[data-del]').forEach(b=>{
    b.addEventListener('click',()=> removeShift(+b.dataset.del));
  });
  renderCalendar();
}

/* ---------- calculations ---------- */
function workdaysAuto(ym){
  const {y,m,days}=monthBounds(ym);
  const st=getStatuses(ym); const hol=new Set(st.holidays||[]);
  let cnt=0;
  for(let d=1; d<=days; d++){
    const date=new Date(y,m-1,d);
    const dow=date.getDay(); // 0..6; 0=Sun
    const iso=mkISO(y,m,d);
    const isWeekday = dow>=1 && dow<=5;
    if(isWeekday && !hol.has(iso)) cnt++;
  }
  return cnt;
}

function hourly(ym){
  const s=state.settings;
  const wd = workdaysAuto(ym);
  const baseHours = wd*s.hoursInDay;
  const hr = baseHours>0 ? s.salary / baseHours : 0;
  return {wd, baseHours, rate:hr};
}

function payOver(shift){
  // –±–∞–∑–æ–≤—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ —Ç–∏–ø—É –¥–Ω—è (–±—É–¥–Ω–∏/—Å—É–±/–≤–æ—Å–∫—Ä/–ø—Ä–∞–∑–¥–Ω–∏–∫) –∏ ¬´–ø–µ—Ä–≤—ã–µ 2 —á–∞—Å–∞¬ª
  const s=state.settings;
  const iso=shift.date, ym=isoMonth(iso);
  const d=new Date(iso+'T00:00:00');
  const dow=d.getDay(); // 0..6
  const hol=isHoliday(iso);
  const {rate}=hourly(ym);

  if(hol || dow===0) return shift.hours * rate * s.multSun;
  if(dow===6)       return shift.hours * rate * s.multSat;

  // weekday
  const h = shift.hours;
  const first2 = Math.min(h,2), rest=Math.max(0,h-2);
  return first2*rate*s.multW12 + rest*rate*s.multW2p;
}

function sumOverForMonth(ym){
  return state.shifts.filter(s=>isoMonth(s.date)===ym && s.type==='ot')
    .reduce((a,s)=>a+payOver(s),0);
}

function sumOverHours(ym){
  return state.shifts.filter(s=>isoMonth(s.date)===ym && s.type==='ot')
    .reduce((a,s)=>a + s.hours,0);
}

function sumDayoffHours(ym){
  return state.shifts.filter(s=>isoMonth(s.date)===ym && s.type==='dayoff')
    .reduce((a,s)=>a + s.hours,0);
}

function vacationsInMonth(ym){
  const st=getStatuses(ym);
  return st.vac||[];
}

function workedDays(ym){
  const s=state.settings;
  const wda = workdaysAuto(ym);
  const offHours = sumDayoffHours(ym);
  const offParts = offHours / s.hoursInDay;
  // –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–ø—É—Å–∫: –∏—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏
  const vacDays = (vacationsInMonth(ym)||[]).filter(iso=>{
    if(s.leaveKind==='calendar') return true;
    const d=new Date(iso+'T00:00:00'), dow=d.getDay(); return dow>=1&&dow<=5;
  }).length;
  return Math.max(0, wda - vacDays - offParts);
}

function basePay(ym){
  const s=state.settings;
  const wda=workdaysAuto(ym);
  const wdWorked = workedDays(ym);
  if(wda===0) return 0;
  return s.salary * (wdWorked / wda);
}

function averageDaily(){
  // —Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π = –≤—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∑–∞ 12 –º–µ—Å / (29.3 * 12)
  // –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 12 –º–µ—Å—è—Ü–µ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ–±–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–º –æ–∫–ª–∞–¥–æ–º.
  const s=state.settings;
  const today=todayISO(); const tm=new Date(today+'T00:00:00');
  let months=0, total=0;
  for(let i=0;i<12;i++){
    const d=new Date(tm); d.setMonth(d.getMonth()-i);
    const ym=mkISO(d.getFullYear(),d.getMonth()+1,1).slice(0,7);
    // –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è = –æ–∫–ª–∞–¥ + –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏ (–±–µ–∑ –æ—Ç–ø—É—Å–∫–Ω—ã—Ö)
    const base = basePay(ym);
    const over = sumOverForMonth(ym);
    if(base>0 || over>0){ total += base + over; months++; }
  }
  if(months<12){
    total += (12-months)*state.settings.salary; // –ø—Ä–∏–±–∞–≤–ª—è–µ–º –æ–∫–ª–∞–¥ –∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–µ—Å—è—Ü—ã
  }
  return total/(29.3*12);
}

function leavePay(ym){
  const s=state.settings;
  const avg=averageDaily();
  const days = (vacationsInMonth(ym)||[]).filter(iso=>{
    if(s.leaveKind==='calendar') return true;
    const d=new Date(iso+'T00:00:00'), dow=d.getDay(); return dow>=1&&dow<=5;
  }).length;
  return {days, amount: avg*days, avg};
}

function fmtMoney(n){ if(!isFinite(n)||n<=0) return '‚Äî'; return Math.round(n).toLocaleString('ru-RU')+' ‚ÇΩ'; }

function recalcAndRender(){
  // settings workdays auto
  const wd = workdaysAuto(state.month);
  ui.workdays.value = wd;

  renderCalendar();
  renderDay(ui.date.value||todayISO());

  const ym=state.month;
  const base = basePay(ym);
  const over = sumOverForMonth(ym);
  const overH = sumOverHours(ym);
  const vac  = leavePay(ym);

  ui.chips.innerHTML = `
    <div class="chip">–ë–∞–∑–∞ (–ø—Ä–æ–ø–æ—Ä—Ü.): ${fmtMoney(base)}</div>
    <div class="chip">–ü–æ—á–∞—Å–æ–≤–∞—è: ${fmtMoney(hourly(ym).rate)} /—á</div>
    <div class="chip">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏: ${fmtMoney(over)} (—á–∞—Å—ã: ${overH.toFixed(2)})</div>
    <div class="chip">–û—Ç–ø—É—Å–∫: ${vac.days} –¥–Ω ‚Ä¢ ${fmtMoney(vac.amount)}</div>
  `;
  const grand = base + over + vac.amount;
  ui.grand.textContent = '–ò—Ç–æ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ: ' + fmtMoney(grand);
  ui.avgHint.textContent = `–°—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π: ${fmtMoney(vac.avg)} (–ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º 12 –º–µ—Å, –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ ‚Äî –æ–∫–ª–∞–¥).`;
}

/* ---------- import/export ---------- */
ui.btnExport.addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='paycalc_data.json'; a.click(); URL.revokeObjectURL(a.href);
});
ui.fileIn.addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt=await f.text(); const data=JSON.parse(txt);
    // –ø—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–º–ø–æ–≤
    if(!data.settings || !('shifts' in data) || !('statuses' in data)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
    localStorage.setItem(LSKEY, JSON.stringify(data)); location.reload();
  }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
});

/* ---------- boot ---------- */
function renderSettings(){ pullSettings(); ui.workdays.value=workdaysAuto(state.month); }
function initCalendarHeaders(){
  // static headers created only once (grid container already exists)
  // handled in renderCalendar / renderHolidayCalendar
}
(function boot(){
  ui.date.value = todayISO();
  pullSettings();
  recalcAndRender();

  // holidays nav
  ui.hPrev.addEventListener('click',()=>{});
})();
</script>
</body>
</html>
