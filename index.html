<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –æ—Ñ—Ñ–ª–∞–π–Ω (PWA)</title>

  <!-- –í–ê–ñ–ù–û –¥–ª—è GitHub Pages –ø–æ–¥-–ø—É—Ç–∏ -->
  <base href="./">

  <meta name="theme-color" content="#0b0d12"/>
  <link rel="manifest" href="./manifest.webmanifest" crossorigin="use-credentials"/>
  <!-- iOS full-screen -->
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
  <meta name="apple-mobile-web-app-title" content="–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏"/>
  <link rel="apple-touch-icon" href="./icons/icon-192.png"/>
  <link rel="icon" href="./icons/icon-192.png"/>

  <style>
    :root{
      --bg:#0f1115;--card:#151922;--cardSoft:#1a1f2a;--text:#e9eef5;--muted:#9aa5b1;--line:#242a34;
      --accent:#3b82f6;--ok:#16a34a;--danger:#ef4444;--warn:#f59e0b
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    header h1{margin:0;font-size:18px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:var(--cardSoft);cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}
    .content{margin-top:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:10px}
    label{display:inline-flex;flex-direction:column;gap:6px}
    input,select,button,textarea{padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:var(--cardSoft);color:var(--text)}
    button{cursor:pointer}
    .btn-ok{border-color:#1f3a24;background:#142019;color:#9be7a0}
    .btn-warn{border-color:#4a3a16;background:#201a0f;color:#ffd68a}
    .btn-danger{border-color:#5a1f1f;background:#251113;color:#ffb3b3}

    .calendarArea{display:grid;grid-template-columns:1fr 330px;gap:10px}
    .calendar{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:8px;display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{ text-align:center;font-weight:600;color:var(--muted)}
    .day{border:1px solid var(--line);border-radius:8px;min-height:86px;padding:6px;background:var(--cardSoft);cursor:pointer;display:flex;flex-direction:column;gap:6px}
    .day .head{display:flex;justify-content:space-between;align-items:center;font-size:12px}
    .badges{display:inline-flex;gap:4px}
    .badge{border:1px solid var(--line);border-radius:6px;padding:1px 4px;font-size:11px}
    .badge.holiday{border-color:var(--warn)}
    .badge.vac{border-color:#22c55e}
    .badge.ot{border-color:#60a5fa}
    .badge.otgul{border-color:#a78bfa}
    .day .body{font-size:12px;color:var(--muted);display:grid;gap:3px}
    .selected{outline:2px solid var(--accent)}

    .editor{position:sticky;top:10px}
    .legend{font-size:13px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}

    .summaryGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:8px}
    .summaryItem{background:var(--cardSoft);border:1px solid var(--line);border-radius:8px;padding:8px}

    @media (max-width:900px){
      .calendarArea{grid-template-columns:1fr}
      .editor{position:relative;top:0}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –æ—Ñ—Ñ–ª–∞–π–Ω (PWA)</h1>
    <div class="row">
      <button id="btnToday">–°–µ–≥–æ–¥–Ω—è</button>
      <button id="btnInstall" style="display:none">‚¨áÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button id="btnUpdate" class="btn-warn" title="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –æ–±–Ω–æ–≤–∏—Ç—å">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </header>

  <div class="row tabs">
    <button class="tab active" data-tab="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    <button class="tab" data-tab="holidays">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
    <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="tab" data-tab="export">–≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç</button>
    <button class="tab" data-tab="legend">–õ–µ–≥–µ–Ω–¥–∞</button>
  </div>

  <div class="content">
    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <section id="tab-calendar" class="tab-pane">
      <div class="card row">
        <label>–ì–æ–¥
          <input id="yearInput" type="number" min="2000" max="2100"/>
        </label>
        <label>–ú–µ—Å—è—Ü
          <select id="monthSelect"></select>
        </label>
        <span class="muted">–°—Ç–∞—Ç—É—Å —Å–µ—Ç–∏: <b id="netState">‚Ä¶</b></span>
      </div>

      <div class="calendarArea">
        <div>
          <div class="calendar" id="calendar"></div>
        </div>
        <aside class="card editor" id="editor">
          <h3 id="edTitle">–î–µ–Ω—å</h3>
          <div class="row">
            <button id="toggleHoliday" class="btn-warn">üéå –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫</button>
            <label class="row" style="align-items:center;gap:6px">
              <input id="vacToggle" type="checkbox"/>
              <span>üèñÔ∏è –û—Ç–ø—É—Å–∫ (1 –Ω–∞ –¥–µ–Ω—å)</span>
            </label>
          </div>
          <hr/>
          <h4>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏</h4>
          <div class="row">
            <label>–ß–∞—Å—ã
              <input id="otHours" type="number" min="0" step="0.5" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 3.5"/>
            </label>
            <button id="setOvertime" class="btn-ok">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å / –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å</button>
            <button id="q35">+3.5 —á</button>
            <button id="q8">+8 —á</button>
            <button id="clearOvertime" class="btn-danger">–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É</button>
          </div>
          <div id="otCurrent" class="muted" style="margin-top:4px"></div>

          <hr/>
          <h4>–û—Ç–≥—É–ª—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</h4>
          <div class="row">
            <label>–ß–∞—Å—ã –æ—Ç–≥—É–ª–∞
              <input id="otgulHours" type="number" min="0.5" step="0.5" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2"/>
            </label>
            <button id="addOtgul" class="btn-ok">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <div id="otgulList" style="margin-top:6px"></div>
          <div class="muted" style="margin-top:6px">–û—Ç–≥—É–ª—ã —É–º–µ–Ω—å—à–∞—é—Ç –±–∞–∑–æ–≤—ã–µ —á–∞—Å—ã (–±–∞–∑–æ–≤—É—é —á–∞—Å—Ç—å –æ–∫–ª–∞–¥–∞).</div>
        </aside>
      </div>

      <div class="card">
        <h3>–°–≤–æ–¥–∫–∞</h3>
        <div class="summaryGrid" id="summary"></div>
      </div>
    </section>

    <!-- –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ -->
    <section id="tab-holidays" class="tab-pane" style="display:none">
      <div class="card">
        <h3>–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏</h3>
        <div id="holGrid" class="row" style="gap:6px;flex-wrap:wrap"></div>
        <div class="muted" style="margin-top:6px">–ú–æ–∂–Ω–æ –æ—Ç–º–µ—á–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –∏ –ø—Ä—è–º–æ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –∫–Ω–æ–ø–∫–æ–π ¬´üéå¬ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –¥–Ω—è.</div>
      </div>
    </section>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <section id="tab-settings" class="tab-pane" style="display:none">
      <div class="card row">
        <label>–û–∫–ª–∞–¥ (–Ω–∞ —Ä—É–∫–∏), ‚ÇΩ
          <input id="salary" type="number" min="0" step="1000"/>
        </label>
        <label>–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
          <input id="workDays" type="number" min="0" max="31"/>
        </label>
        <label>–ß–∞—Å—ã –≤ –¥–µ–Ω—å
          <input id="hoursPerDay" type="number" min="1" max="24" step="0.5"/>
        </label>
        <label>–°—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          <input id="avgDailyManual" type="number" min="0" step="1" placeholder="–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å—á–∏—Ç–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"/>
        </label>
        <button id="saveSettings" class="btn-ok">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div class="card">
        <h3>–ê–≤—Ç–æ-—Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å)</h3>
        <div id="avgDailyAutoView" class="muted">‚Äî</div>
        <div class="row" style="margin-top:6px">
          <button id="historyAddCurrent" class="btn-ok">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –æ–∫–ª–∞–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é</button>
          <button id="historyClear" class="btn-danger">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é 12 –º–µ—Å</button>
        </div>
      </div>
    </section>

    <!-- –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç -->
    <section id="tab-export" class="tab-pane" style="display:none">
      <div class="card row">
        <button id="btnExportJson">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <label class="row" style="align-items:center;gap:6px">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç JSON
          <input id="importJson" type="file" accept="application/json"/>
        </label>
        <button id="btnResetMonth" class="btn-danger">üóëÔ∏è –°–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞</button>
      </div>
      <div class="card muted">
        –ò–º–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞. –ü–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º —Å–¥–µ–ª–∞–π—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π.
      </div>
    </section>

    <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
    <section id="tab-legend" class="tab-pane" style="display:none">
      <div class="card legend">
        <span>üéå ‚Äî –ø—Ä–∞–∑–¥–Ω–∏–∫</span>
        <span>üèñÔ∏è ‚Äî –æ—Ç–ø—É—Å–∫ (1 –Ω–∞ –¥–µ–Ω—å)</span>
        <span>üïë ‚Äî –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞</span>
        <span>üïò ‚Äî –æ—Ç–≥—É–ª (–º–∏–Ω—É—Å —á–∞—Å—ã –±–∞–∑—ã)</span>
        <span>üîÑ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å (—Å–±—Ä–æ—Å–∏—Ç—å –∫—ç—à PWA)</span>
      </div>
      <div class="card">
        <h3>–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
        <ul>
          <li><b>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</b>: –≤–≤–æ–¥–∏—à—å —á–∞—Å—ã –∏ –∂–º—ë—à—å ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å / –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å¬ª. –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏: 3.5 —á, 8 —á.</li>
          <li><b>–û—Ç–≥—É–ª—ã</b>: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å; –∫–∞–∂–¥–∞—è —É–º–µ–Ω—å—à–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ —á–∞—Å—ã.</li>
          <li><b>–û—Ç–ø—É—Å–∫</b>: –æ–¥–∏–Ω –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞ –¥–µ–Ω—å; –æ—Ç–ø—É—Å–∫–Ω—ã–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ —Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–º—É.</li>
          <li><b>–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</b>: –æ—Ç–º–µ—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ (–∫–Ω–æ–ø–∫–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ) –∏–ª–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–ü—Ä–∞–∑–¥–Ω–∏–∫–∏¬ª.</li>
          <li><b>–°–µ–≥–æ–¥–Ω—è</b>: –∫–Ω–æ–ø–∫–∞ –≤ —à–∞–ø–∫–µ –±—ã—Å—Ç—Ä–æ –≤—ã–¥–µ–ª–∏—Ç —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É.</li>
        </ul>
      </div>
    </section>
  </div>
</div>

<script>
/* ===== –£—Ç–∏–ª–∏—Ç—ã –¥–∞—Ç ===== */
const MONTHS = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
const DOW = ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"];
const pad2 = n => (n<10?`0${n}`:`${n}`);
const ymd = (y,m0,d)=>`${y}-${pad2(m0+1)}-${pad2(d)}`;
const parseYmd = s => { const [y,m,d]=s.split("-").map(Number); return {y, m0:m-1, d}; };
const daysInMonth = (y,m0)=> new Date(y,m0+1,0).getDate();
const firstWeekday = (y,m0)=> (new Date(y,m0,1).getDay()+6)%7; // 0..6 Mon..Sun
const isWeekend = (y,m0,d)=> { const js=new Date(y,m0,d).getDay(); return js===0||js===6; };

/* ===== –•—Ä–∞–Ω–∏–ª–∏—â–µ ===== */
const KEY="podrabotki.v2";
const KEY_HIST="podrabotki.history";
const loadMonth=(y,m0)=>{
  const raw=localStorage.getItem(KEY);
  if(raw){
    try{
      const obj=JSON.parse(raw);
      if(obj.year===y && obj.month===m0) return obj;
    }catch{}
  }
  const dim=daysInMonth(y,m0);
  const days={};
  for(let d=1; d<=dim; d++){ const date=ymd(y,m0,d); days[date]={date,overtimeHours:0, otguls:[], vacation:false}; }
  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ = –∫–æ–ª-–≤–æ –ü–Ω-–ü—Ç
  let wd=0; for(let d=1; d<=dim; d++){const js=new Date(y,m0,d).getDay(); if(js>=1&&js<=5) wd++;}
  return {year:y, month:m0, baseSalary:0, workingDays:wd, hoursPerDay:8, avgDailyManual:null, holidays:[], days};
};
const saveMonth=(md)=> localStorage.setItem(KEY, JSON.stringify(md));
const loadHistory=()=> { try{ return JSON.parse(localStorage.getItem(KEY_HIST)||"{}"); }catch{ return {}; } };
const saveHistory=(h)=> localStorage.setItem(KEY_HIST, JSON.stringify(h));

/* ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
const now = new Date();
let state = { selectedDate: null, data: loadMonth(now.getFullYear(), now.getMonth()), history: loadHistory() };

/* ===== –†–∞—Å—á—ë—Ç—ã ===== */
const hourlyRate = (md)=>{
  const denom = md.workingDays>0 && md.hoursPerDay>0 ? md.workingDays*md.hoursPerDay : 0;
  return denom>0 ? md.baseSalary/denom : 0;
};

const compute = (md)=>{
  const rate = hourlyRate(md);
  const denomHours = md.workingDays*md.hoursPerDay;
  let baseHoursWorked = 0;
  let overtimeHours = 0;
  let vacationDays = 0;

  for(const d of Object.values(md.days)){
    const {y,m0,d:dd} = parseYmd(d.date);
    const weekend = isWeekend(y,m0,dd);
    // –±–∞–∑–æ–≤—ã–µ —á–∞—Å—ã: —Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏ (–ü–Ω-–ü—Ç), –Ω–µ –æ—Ç–ø—É—Å–∫; –º–∏–Ω—É—Å –æ—Ç–≥—É–ª—ã (–Ω–æ –Ω–µ –Ω–∏–∂–µ 0)
    if(!weekend && !d.vacation){
      const otgulSum = d.otguls.reduce((a,b)=>a+b,0);
      const baseToday = Math.max(0, md.hoursPerDay - otgulSum);
      baseHoursWorked += baseToday;
    }
    // –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞ ‚Äî —Å—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —á–∞—Å—ã
    overtimeHours += d.overtimeHours || 0;
    // –æ—Ç–ø—É—Å–∫–Ω—ã–µ –¥–Ω–∏
    if(d.vacation) vacationDays += 1;
  }

  const basePart = denomHours>0 ? (baseHoursWorked/denomHours)*md.baseSalary : 0;
  const overtimePay = rate * overtimeHours;

  // –°—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π
  let avgDailyAuto = 0;
  const hist = loadHistory();
  const keys = Object.keys(hist).sort().slice(-12);
  if(keys.length>0){
    const sum = keys.reduce((a,k)=>a + (Number(hist[k])||0),0);
    avgDailyAuto = sum / (12*29.3); // –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è): —Å—É–º–º–∞ –∑–∞ 12 –º–µ—Å / (12 √ó 29.3)
  } else {
    // –µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ–º—Å—è –Ω–∞ —Ç–µ–∫—É—â–∏–π –æ–∫–ª–∞–¥
    avgDailyAuto = (md.baseSalary || 0) / 29.3;
  }
  const avgDaily = (md.avgDailyManual && md.avgDailyManual>0) ? md.avgDailyManual : avgDailyAuto;
  const vacationPay = vacationDays * avgDaily;

  const total = basePart + overtimePay + vacationPay;

  return { rate, baseHoursWorked, overtimeHours, vacationDays, avgDailyAuto, avgDaily, basePart, overtimePay, vacationPay, total };
};

const fmt = n=> new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}).format(Math.round(n));

/* ===== –†–µ–Ω–¥–µ—Ä ===== */
const $ = sel => document.querySelector(sel);
const calendarEl = $("#calendar");
const yearInput = $("#yearInput");
const monthSelect = $("#monthSelect");
const edTitle = $("#edTitle");
const vacToggle = $("#vacToggle");
const otHours = $("#otHours");
const setOvertimeBtn = $("#setOvertime");
const q35 = $("#q35");
const q8 = $("#q8");
const clearOvertime = $("#clearOvertime");
const otCurrent = $("#otCurrent");
const otgulHours = $("#otgulHours");
const otgulList = $("#otgulList");
const toggleHolidayBtn = $("#toggleHoliday");
const summary = $("#summary");
const holGrid = $("#holGrid");
const salary = $("#salary");
const workDays = $("#workDays");
const hoursPerDay = $("#hoursPerDay");
const avgDailyManual = $("#avgDailyManual");
const saveSettings = $("#saveSettings");
const avgDailyAutoView = $("#avgDailyAutoView");
const importJson = $("#importJson");

function initUI(){
  monthSelect.innerHTML = MONTHS.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
  yearInput.value = String(state.data.year);
  monthSelect.value = String(state.data.month);
  salary.value = String(state.data.baseSalary||0);
  workDays.value = String(state.data.workingDays||0);
  hoursPerDay.value = String(state.data.hoursPerDay||8);
  avgDailyManual.value = state.data.avgDailyManual ? String(state.data.avgDailyManual) : "";
  renderAll();
}

function renderAll(){
  renderCalendar();
  renderEditor();
  renderSummary();
  renderHolidaysTab();
  renderAvgDailyAuto();
}

function renderCalendar(){
  const {year, month} = state.data;
  const dim = daysInMonth(year, month);
  const lead = firstWeekday(year, month);

  const dowRow = DOW.map(d=>`<div class="dow">${d}</div>`).join("");
  const blanks = Array.from({length:lead},()=>`<div></div>`).join("");

  const daysHtml = Array.from({length:dim},(_,i)=>{
    const d = i+1;
    const date = ymd(year, month, d);
    const dd = state.data.days[date];
    const badges=[];
    if(state.data.holidays.includes(date)) badges.push(`<span class="badge holiday" title="–ü—Ä–∞–∑–¥–Ω–∏–∫">üéå</span>`);
    if(dd?.vacation) badges.push(`<span class="badge vac" title="–û—Ç–ø—É—Å–∫">üèñÔ∏è</span>`);
    if((dd?.overtimeHours||0)>0) badges.push(`<span class="badge ot" title="–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞">üïë ${dd.overtimeHours}—á</span>`);
    const otgulSum = (dd?.otguls||[]).reduce((a,b)=>a+b,0);
    if(otgulSum>0) badges.push(`<span class="badge otgul" title="–û—Ç–≥—É–ª—ã">üïò ${otgulSum}—á</span>`);
    const selected = state.selectedDate===date?' selected':'';
    return `<div class="day${selected}" data-date="${date}">
      <div class="head"><div>${d}</div><div class="badges">${badges.join("")}</div></div>
      <div class="body">${badges.length? "" : '<span class="muted">‚Äî</span>'}</div>
    </div>`;
  }).join("");

  calendarEl.innerHTML = dowRow + blanks + daysHtml;
  calendarEl.querySelectorAll(".day").forEach(el=>{
    el.addEventListener("click", ()=>{
      state.selectedDate = el.dataset.date;
      renderCalendar(); // –ø–æ–¥—Å–≤–µ—Ç–∫–∞
      renderEditor();
    }, {passive:true});
  });
}

function renderEditor(){
  const date = state.selectedDate;
  if(!date){
    edTitle.textContent = "–î–µ–Ω—å";
    vacToggle.disabled = true;
    setOvertimeBtn.disabled = q35.disabled = q8.disabled = clearOvertime.disabled = true;
    otHours.disabled = otgulHours.disabled = true;
    toggleHolidayBtn.disabled = true;
    otCurrent.textContent = "";
    otgulList.innerHTML = "";
    return;
  }
  const dd = state.data.days[date];
  edTitle.textContent = `–î–µ–Ω—å: ${date}`;
  vacToggle.disabled = false;
  setOvertimeBtn.disabled = q35.disabled = q8.disabled = clearOvertime.disabled = false;
  otHours.disabled = otgulHours.disabled = false;
  toggleHolidayBtn.disabled = false;
  vacToggle.checked = dd.vacation;
  otCurrent.textContent = (dd.overtimeHours||0)>0 ? `–¢–µ–∫—É—â–∞—è –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞: ${dd.overtimeHours} —á` : "–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Ç";

  // —Å–ø–∏—Å–æ–∫ –æ—Ç–≥—É–ª–æ–≤
  const items = (dd.otguls||[]).map((h,idx)=>`<div class="row" style="justify-content:space-between">
    <span>üïò –û—Ç–≥—É–ª: <b>${h}</b> —á</span>
    <button data-idx="${idx}" class="btn-danger small">–£–¥–∞–ª–∏—Ç—å</button>
  </div>`).join("");
  otgulList.innerHTML = items || `<span class="muted">–û—Ç–≥—É–ª–æ–≤ –Ω–µ—Ç</span>`;
  otgulList.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const i = Number(btn.dataset.idx);
      dd.otguls.splice(i,1);
      saveMonth(state.data);
      renderAll();
      e.stopPropagation();
    });
  });
}

function renderSummary(){
  const t = compute(state.data);
  const items = [
    {label:"–ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞", val: fmt(t.rate)},
    {label:"–ë–∞–∑–∞ (—á–∞—Å–æ–≤)", val: `${t.baseHoursWorked} —á`},
    {label:"–ë–∞–∑–∞ (—Å—É–º–º–∞)", val: fmt(t.basePart)},
    {label:"–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ (—á–∞—Å—ã)", val: `${t.overtimeHours} —á`},
    {label:"–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ (—Å—É–º–º–∞)", val: fmt(t.overtimePay)},
    {label:"–û—Ç–ø—É—Å–∫ (–¥–Ω–∏)", val: `${t.vacationDays}`},
    {label:"–°—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π", val: fmt(t.avgDaily)},
    {label:"–û—Ç–ø—É—Å–∫–Ω—ã–µ", val: fmt(t.vacationPay)},
    {label:"–ò—Ç–æ–≥–æ", val: fmt(t.total)},
  ];
  summary.innerHTML = items.map(it=>`<div class="summaryItem"><div class="muted">${it.label}</div><div style="font-size:18px;margin-top:4px">${it.val}</div></div>`).join("");
}

function renderHolidaysTab(){
  const {year, month} = state.data;
  const dim = daysInMonth(year, month);
  const set = new Set(state.data.holidays);
  holGrid.innerHTML = Array.from({length:dim},(_,i)=>{
    const d=i+1; const date=ymd(year,month,d);
    const active = set.has(date) ? 'style="outline:2px solid var(--warn)"' : "";
    return `<button data-date="${date}" class="tab" ${active}>üéå ${d}</button>`;
  }).join("");
  holGrid.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const date=b.dataset.date;
      const arr=state.data.holidays;
      const i=arr.indexOf(date);
      if(i>=0) arr.splice(i,1); else arr.push(date);
      arr.sort();
      saveMonth(state.data);
      renderAll();
    }, {passive:true});
  });
}

function renderAvgDailyAuto(){
  const t = compute(state.data);
  avgDailyAutoView.textContent = `–ê–≤—Ç–æ: ${fmt(t.avgDailyAuto)} (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞ 12 –º–µ—Å, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å).`;
}

/* ===== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ===== */
// –≤–∫–ª–∞–¥–∫–∏
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const id = btn.dataset.tab;
    if(!id) return;
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x===btn));
    document.querySelectorAll(".tab-pane").forEach(p=> p.style.display = (p.id === `tab-${id}`) ? "" : "none");
  });
});

// –≤—ã–±–æ—Ä –º–µ—Å—è—Ü–∞/–≥–æ–¥–∞
yearInput.addEventListener("change", ()=>{
  const y=Number(yearInput.value)||now.getFullYear();
  const m=Number(monthSelect.value)||0;
  state.data = loadMonth(y,m);
  saveMonth(state.data);
  state.selectedDate=null;
  initUI();
});
monthSelect.addEventListener("change", ()=>{
  const y=Number(yearInput.value)||now.getFullYear();
  const m=Number(monthSelect.value)||0;
  state.data = loadMonth(y,m);
  saveMonth(state.data);
  state.selectedDate=null;
  initUI();
});

// —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–Ω—è
vacToggle.addEventListener("change", ()=>{
  if(!state.selectedDate) return;
  state.data.days[state.selectedDate].vacation = !!vacToggle.checked;
  saveMonth(state.data);
  renderAll();
});
toggleHolidayBtn.addEventListener("click", ()=>{
  if(!state.selectedDate) return;
  const d=state.selectedDate;
  const arr=state.data.holidays;
  const i=arr.indexOf(d);
  if(i>=0) arr.splice(i,1); else arr.push(d);
  arr.sort();
  saveMonth(state.data);
  renderAll();
});
setOvertimeBtn.addEventListener("click", ()=>{
  if(!state.selectedDate) return;
  const v = Math.max(0, Math.round((Number(otHours.value)||0)*2)/2);
  state.data.days[state.selectedDate].overtimeHours = v; // –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å
  saveMonth(state.data);
  renderAll();
});
q35.addEventListener("click", ()=>{ otHours.value="3.5"; setOvertimeBtn.click(); });
q8.addEventListener("click", ()=>{ otHours.value="8"; setOvertimeBtn.click(); });
clearOvertime.addEventListener("click", ()=>{
  if(!state.selectedDate) return;
  state.data.days[state.selectedDate].overtimeHours = 0;
  saveMonth(state.data);
  renderAll();
});
$("#addOtgul").addEventListener("click", ()=>{
  if(!state.selectedDate) return;
  const v = Math.max(0.5, Math.round((Number(otgulHours.value)||0)*2)/2);
  state.data.days[state.selectedDate].otguls.push(v);
  saveMonth(state.data);
  renderAll();
});

// –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
saveSettings.addEventListener("click", ()=>{
  state.data.baseSalary = Math.max(0, Math.round(Number(salary.value)||0));
  state.data.workingDays = Math.max(0, Math.round(Number(workDays.value)||0));
  state.data.hoursPerDay = Math.max(1, Math.round((Number(hoursPerDay.value)||8)*2)/2);
  const avg = Number(avgDailyManual.value);
  state.data.avgDailyManual = Number.isFinite(avg)&&avg>0 ? avg : null;
  saveMonth(state.data);
  renderAll();
});

// –∏—Å—Ç–æ—Ä–∏—è 12 –º–µ—Å
$("#historyAddCurrent").addEventListener("click", ()=>{
  const h = loadHistory();
  const k = `${state.data.year}-${pad2(state.data.month+1)}`;
  h[k] = state.data.baseSalary || 0;
  saveHistory(h);
  renderAvgDailyAuto();
});
$("#historyClear").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–∫–ª–∞–¥–æ–≤ –∑–∞ 12 –º–µ—Å—è—Ü–µ–≤?")){ saveHistory({}); renderAvgDailyAuto(); }
});

// —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç
$("#btnExportJson").addEventListener("click", ()=>{
  const payload = { schema:2, payload: state.data, history: loadHistory() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`podrabotki_${state.data.year}_${state.data.month+1}.json`;
  a.click(); URL.revokeObjectURL(a.href);
});
importJson.addEventListener("change", async ()=>{
  const f=importJson.files?.[0]; if(!f) return;
  try{
    const txt=await f.text();
    const parsed=JSON.parse(txt);
    if(!parsed || !parsed.payload) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");
    state.data = parsed.payload;
    if(parsed.history) saveHistory(parsed.history);
    saveMonth(state.data);
    state.selectedDate=null;
    initUI();
    alert("–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã");
  }catch(e){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + (e?.message||e)); }
  finally{ importJson.value=""; }
});
$("#btnResetMonth").addEventListener("click", ()=>{
  if(!confirm("–°—Ç–µ—Ä–µ—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü?")) return;
  localStorage.removeItem(KEY);
  state.data = loadMonth(state.data.year, state.data.month);
  state.selectedDate=null;
  initUI();
});

// —Å–µ–≥–æ–¥–Ω—è
$("#btnToday").addEventListener("click", ()=>{
  const t=new Date();
  if(t.getFullYear()!==state.data.year || t.getMonth()!==state.data.month){
    state.data = loadMonth(t.getFullYear(), t.getMonth());
    yearInput.value=String(state.data.year);
    monthSelect.value=String(state.data.month);
  }
  state.selectedDate = ymd(t.getFullYear(), t.getMonth(), t.getDate());
  saveMonth(state.data);
  renderAll();
});

// PWA: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW –∏ –∫–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    if(location.search.includes("kill-sw")){
      navigator.serviceWorker.getRegistrations().then(regs=>{
        regs.forEach(r=>r.unregister());
        caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))).finally(()=>location.replace(location.pathname+"?v="+Date.now()));
      }); return;
    }
    navigator.serviceWorker.register("./sw.js", {scope:"./"}).catch(()=>{});
  });
}
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); deferredPrompt=e; $("#btnInstall").style.display="inline-block"; });
$("#btnInstall").addEventListener("click", async ()=>{
  if(!deferredPrompt){ alert("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞: ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª."); return; }
  deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; $("#btnInstall").style.display="none";
});
$("#btnUpdate").addEventListener("click", async ()=>{
  try{
    const regs=await navigator.serviceWorker.getRegistrations();
    await Promise.all(regs.map(r=>r.unregister())); const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k)));
  } finally { location.reload(); }
});

// —Å–µ—Ç–µ–≤–æ–π —Å—Ç–∞—Ç—É—Å
function setNet(){ $("#netState").textContent = navigator.onLine? "–æ–Ω–ª–∞–π–Ω":"–æ—Ñ—Ñ–ª–∞–π–Ω"; }
window.addEventListener("online", setNet); window.addEventListener("offline", setNet); setNet();

// init
initUI();
</script>
</body>
</html>
