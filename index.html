<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –æ—Ñ—Ñ–ª–∞–π–Ω (PWA)</title>
  <base href="./">
  <meta name="theme-color" content="#0b0d12" />
  <link rel="manifest" href="./manifest.webmanifest" crossorigin="use-credentials" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <link rel="icon" href="./icons/icon-192.png" />
  <style>
    :root{--bg:#0f1115;--card:#151922;--text:#e9eef5;--muted:#9aa5b1;--accent:#3b82f6;--line:#242a34}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    header h1{margin:0;font-size:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#1a1f2a;color:var(--text);cursor:pointer}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –æ—Ñ—Ñ–ª–∞–π–Ω (PWA)</h1>
      <div class="row">
        <button id="btn-install" style="display:none">‚¨áÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="btn-update" title="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –æ–±–Ω–æ–≤–∏—Ç—å">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </header>
    <section class="card">
      <div class="row">
        <label>–°—Ç–∞—Ç—É—Å —Å–µ—Ç–∏: <span class="muted" id="offline-status">‚Ä¶</span></label>
      </div>
      <div style="margin-top:8px" class="muted">
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: Android ‚Äî ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª, iOS ‚Äî ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí –ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª.
      </div>
    </section>
  </div>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        if (location.search.includes('kill-sw')) {
          navigator.serviceWorker.getRegistrations().then(regs => {
            regs.forEach(r => r.unregister());
            caches.keys().then(keys => keys.forEach(k => caches.delete(k)))
              .finally(() => location.replace(location.pathname + '?v=' + Date.now()));
          });
          return;
        }
        navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(() => {});
      });
    }
    document.getElementById('btn-update')?.addEventListener('click', async () => {
      try {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      } finally {
        location.reload();
      }
    });
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('btn-install');
      if (btn) btn.style.display = 'inline-block';
    });
    document.getElementById('btn-install')?.addEventListener('click', async () => {
      if (!deferredPrompt) { alert('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞: ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª.'); return; }
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('btn-install').style.display = 'none';
    });
    function setStatus() {
      const el = document.getElementById('offline-status');
      if (!el) return;
      el.textContent = navigator.onLine ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ—Ñ–ª–∞–π–Ω';
    }
    window.addEventListener('online', setStatus);
    window.addEventListener('offline', setStatus);
    setStatus();
  </script>
</body>
</html>
