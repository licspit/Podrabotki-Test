<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</title>
<meta name="theme-color" content="#0f1115">
<style>
  :root{
    --bg:#0f1115;--card:#151922;--card-b:#1e2a3a;--mut:#9aa7b4;--text:#f5f7fb;--pri:#3b82f6;--ok:#22c55e;--bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:880px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px;font-size:28px;line-height:1.1}
  .tabs{display:flex;gap:10px;margin:8px 0 16px}
  .tab{padding:10px 16px;border:1px solid var(--card-b);background:var(--card);border-radius:12px;color:#cfd8e3;text-decoration:none;cursor:pointer}
  .tab.active{background:#202838;color:#fff}
  .section-card{border:1px solid var(--card-b);background:var(--card);border-radius:18px;padding:14px;margin:14px 0}
  .mut{color:var(--mut)}
  .btn{border:1px solid var(--card-b);background:#1a2331;color:#e8edf4;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
  .btn:hover{background:#202c3f}
  .btn-primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .btn-pill{border-radius:14px;padding:.85rem 1rem}
  .input{width:100%;border:1px solid var(--card-b);background:#121821;color:#fff;border-radius:12px;padding:12px 14px}
  .form-row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
  .grow{flex:1 1 0}
  .quick-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.75rem}
  .hstack{display:flex;gap:.75rem;align-items:center}
  /* calendar */
  .cal-head{display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin-bottom:.25rem}
  .calendar{margin-top:.75rem}
  .cal-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem;margin:.25rem 0 .5rem}
  .cal-dow span{opacity:.7;font-size:.9rem;text-align:center}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem}
  .cal-day{position:relative;border-radius:16px;height:50px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08)}
  .cal-day .badge{position:absolute;bottom:4px;font-size:16px;line-height:1}
  .cal-day.selected{outline:3px solid var(--pri);outline-offset:1px}
  .cal-day.has-ot{box-shadow:inset 0 0 0 2px var(--bad)}
  .cal-legend{opacity:.82;font-size:.92rem;margin-top:.6rem}
  /* day list */
  .tbl{width:100%;border-collapse:separate;border-spacing:0 8px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr 140px;gap:12px;align-items:center;background:#111824;border:1px solid #1d2836;border-radius:12px;padding:10px 12px}
  .pill{display:inline-block;border:1px solid var(--card-b);background:#101825;padding:4px 10px;border-radius:999px}
  .badge-ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
  .badge-bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
  .money{font-weight:700}
  .totals .pill{margin:4px 6px 0 0}
  .help{font-size:.92rem;opacity:.85}
  @media(min-width:480px){.cal-day{height:56px}}
</style>
</head>
<body>
<div class="wrap">
  <h1>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏</h1>

  <div class="tabs">
    <button class="tab active" data-tab="journal">–ñ—É—Ä–Ω–∞–ª</button>
    <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="tab" data-tab="holidays">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
    <button class="tab" data-tab="import">–ò–º–ø–æ—Ä—Ç</button>
  </div>

  <!-- JOURNAL -->
  <div id="tab-journal">
    <div class="section-card">
      <div class="form-row">
        <input id="dt" class="grow input" type="text" readonly>
        <button id="btnToday" class="btn btn-pill">–°–µ–≥–æ–¥–Ω—è</button>
      </div>
      <div class="form-row" style="margin-top:.6rem">
        <input id="hours" class="input" inputmode="decimal" placeholder="–Ω–∞–ø—Ä., 3.5" style="width:120px">
        <button id="btnAdd" class="btn btn-primary btn-pill grow">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="section-card">
      <div class="mut" style="margin-bottom:.5rem">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ ¬´–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞¬ª):</div>
      <div id="quick" class="quick-grid">
        <button class="btn btn-pill" data-qk="hrs-3.5">3.5 —á</button>
        <button class="btn btn-pill" data-qk="hrs-8">8 —á</button>
        <button class="btn btn-pill" data-qk="leave-hours">–û—Ç–≥—É–ª</button>
        <button class="btn btn-pill" data-qk="vacation">–û—Ç–ø—É—Å–∫</button>
      </div>
    </div>

    <div class="section-card">
      <div class="cal-head">
        <button id="prevM" class="btn btn-pill">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
        <div id="monthTitle" style="font-size:24px;font-weight:800;text-align:center;flex:1">‚Äî</div>
        <button id="nextM" class="btn btn-pill">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
      </div>
      <div class="calendar">
        <div class="cal-dow"><span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span><span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span></div>
        <div id="calGrid" class="cal-grid"></div>
        <div class="cal-legend help">üî® ‚Äî –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞; ‚õî ‚Äî –æ—Ç–≥—É–ª (—á–∞—Å—ã); üèñ ‚Äî –æ—Ç–ø—É—Å–∫; üéâ ‚Äî –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π.</div>
      </div>
    </div>

    <div class="section-card">
      <div id="dayTitle" style="font-size:20px;font-weight:700;margin:2px 0 12px">‚Äî</div>
      <div id="dayList"></div>
      <div class="totals" id="totals" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="tab-settings" style="display:none">
    <div class="section-card">
      <div class="mut" style="margin-bottom:.5rem">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:</div>
      <div id="curYm" class="pill"></div>
    </div>

    <div class="section-card">
      <div class="form-row">
        <div class="grow">
          <div class="mut">–û–∫–ª–∞–¥ (–Ω–∞ —Ä—É–∫–∏), ‚ÇΩ</div>
          <input id="salary" class="input" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 90000">
        </div>
        <div style="width:140px">
          <div class="mut">–ß–∞—Å–æ–≤ –≤ –¥–Ω–µ</div>
          <input id="hoursPerDay" class="input" inputmode="numeric" value="8">
        </div>
      </div>

      <div class="form-row" style="margin-top:.6rem">
        <div class="grow">
          <div class="mut">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (–∞–≤—Ç–æ, –ü–Ω‚Äì–ü—Ç)</div>
          <input id="workdays" class="input" inputmode="numeric" readonly>
        </div>
        <div class="grow">
          <div class="mut">–¢–∏–ø –æ—Ç–ø—É—Å–∫–∞</div>
          <select id="leaveMode" class="input">
            <option value="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π (–≤—Å–µ –¥–Ω–∏)</option>
            <option value="production">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π (—Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="section-card">
      <div class="mut">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
      <button id="btnHardRefresh" class="btn btn-pill" style="margin-top:.5rem">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
      <div class="help" style="margin-top:.5rem">–ï—Å–ª–∏ –Ω–µ –≤–∏–¥–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à (service worker) –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è.</div>
      <div class="help" style="margin-top:.75rem">–í–µ—Ä—Å–∏—è: <span id="ver">2025-09-vA</span></div>
    </div>
  </div>

  <!-- HOLIDAYS -->
  <div id="tab-holidays" style="display:none">
    <div class="section-card">
      <div class="mut">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ –º–µ—Å—è—Ü–∞. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–µ–Ω—å, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å/—Å–Ω—è—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫.</div>
      <div class="calendar" style="margin-top:10px">
        <div class="cal-head">
          <button id="hPrev" class="btn btn-pill">‚óÄ</button>
          <div id="hTitle" style="font-size:20px;font-weight:700;flex:1;text-align:center">‚Äî</div>
          <button id="hNext" class="btn btn-pill">‚ñ∂</button>
        </div>
        <div class="cal-dow"><span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span><span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span></div>
        <div id="hGrid" class="cal-grid"></div>
      </div>
    </div>
  </div>

  <!-- IMPORT -->
  <div id="tab-import" style="display:none">
    <div class="section-card">
      <div class="hstack">
        <button id="btnExport" class="btn btn-pill">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <label class="btn btn-pill" for="fileIn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
        <input id="fileIn" type="file" accept="application/json" style="display:none">
      </div>
      <div id="importMsg" class="help" style="margin-top:10px"></div>
    </div>
  </div>

</div>

<script>
/* =========================
   helpers
========================= */
const $ = s=>document.querySelector(s);
const el = $;
const LSK = 'paycalc_data_v2';
const fmtMoney = n => (isNaN(n)?'‚Äî':n.toLocaleString('ru-RU'))+' ‚ÇΩ';
const round2 = n => Math.round(n*100)/100;
const todayIso = () => new Date().toISOString().slice(0,10);
const ymOf = d => d.slice(0,7);

function load(){
  try{
    return JSON.parse(localStorage.getItem(LSK))||{};
  }catch{ return {}; }
}
function save(x){ localStorage.setItem(LSK, JSON.stringify(x)); }

/* =========================
   state
========================= */
let state = load();
state.entries ||= []; // {date:'YYYY-MM-DD', kind:'ot'|'leaveHours'|'vac', hours?, days?}
state.holidays ||= {}; // { 'YYYY-MM': [1,10, ...] }
state.settings ||= { salary:0, hoursPerDay:8, leaveMode:'production' };

let viewDate = new Date(); // –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
viewDate.setDate(1);

let selectedDateStr = state.selectedDate || todayIso();

/* =========================
   settings IO
========================= */
function get(k){ return state.settings?.[k]; }
function set(k,v){ state.settings[k]=v; save(state); }

function autoWorkdaysForMonth(ym){
  // –ü–Ω‚Äì–ü—Ç –º–∏–Ω—É—Å –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
  const [y,m] = ym.split('-').map(Number);
  const d0 = new Date(y, m-1, 1);
  const d1 = new Date(y, m, 0);
  const hol = new Set((state.holidays[ym]||[]).map(Number));
  let wd = 0;
  for(let d=1; d<=d1.getDate(); d++){
    const dt = new Date(y,m-1,d);
    const w = dt.getDay(); // 0 –í—Å ‚Ä¶ 6 –°–±
    const isWeekday = w>=1 && w<=5;
    if(isWeekday && !hol.has(d)) wd++;
  }
  return wd;
}

function refreshSettingsUI(){
  const ym = ymOf(selectedDateStr);
  $('#curYm').textContent = ym;
  $('#salary').value = get('salary')??'';
  $('#hoursPerDay').value = get('hoursPerDay')??8;
  $('#leaveMode').value = get('leaveMode')||'production';
  $('#workdays').value = autoWorkdaysForMonth(ym);
}

/* =========================
   calendar build
========================= */
function monthCells(y, m){ // m: 0..11
  const first = new Date(y,m,1);
  const last = new Date(y,m+1,0);
  const startOffset = (first.getDay()+6)%7; // —Å–¥–≤–∏–≥, —á—Ç–æ–±—ã –ü–Ω=0
  const days = last.getDate();
  const cells = [];
  for(let i=0;i<startOffset;i++) cells.push({}); // –ø—É—Å—Ç—ã–µ
  for(let d=1; d<=days; d++){
    const iso = new Date(y,m,d).toISOString().slice(0,10);
    cells.push({ dateIso: iso });
  }
  while(cells.length%7) cells.push({});
  return cells;
}

function monthTitle(elm, y, m){
  const dt = new Date(y,m,1);
  elm.textContent = dt.toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
}

function entriesByDateMap(){
  const map = {};
  for(const r of state.entries){
    (map[r.date] ||= []).push(r);
  }
  return map;
}

function getDayBadge(iso){
  const arr = entriesByDateMap()[iso]||[];
  if(arr.some(x=>x.kind==='vac')) return 'üèñ';
  if(arr.some(x=>x.kind==='leaveHours')) return '‚õî';
  if(arr.some(x=>x.kind==='ot')) return 'üî®';
  return '';
}

function dayBtn(dateIso){
  const badge = getDayBadge(dateIso);
  const b = document.createElement('button');
  b.className = 'cal-day' + (dateIso===selectedDateStr?' selected':'') + (badge==='‚õî'?' has-ot':'');
  b.innerHTML = `<span>${(new Date(dateIso)).getDate()}</span><span class="badge">${badge}</span>`;
  b.addEventListener('click',()=> setSelectedDate(dateIso));
  return b;
}

function renderCalendar(){
  const y=viewDate.getFullYear(), m=viewDate.getMonth();
  monthTitle($('#monthTitle'), y, m);
  const grid = $('#calGrid');
  grid.innerHTML = '';
  for(const c of monthCells(y,m)){
    if(!c.dateIso){ const d=document.createElement('div'); grid.appendChild(d); continue; }
    grid.appendChild(dayBtn(c.dateIso));
  }
}

function setSelectedDate(iso){
  selectedDateStr = iso;
  state.selectedDate = iso; save(state);
  const dt = new Date(iso+'T00:00:00');
  $('#dt').value = dt.toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
  renderCalendar();
  renderDayList();
}

/* =========================
   entries add/remove
========================= */
function addEntry(obj){
  state.entries.push(obj);
  save(state);
}

function removeEntry(idx){
  state.entries.splice(idx,1);
  save(state);
}

/* =========================
   quick buttons and add
========================= */
$('#btnToday').addEventListener('click',()=> setSelectedDate(todayIso()));

$('#btnAdd').addEventListener('click',()=>{
  const v = parseFloat(($('#hours').value||'0').replace(',','.'));
  if(!v||v<=0){ alert('–£–∫–∞–∂–∏—Ç–µ —á–∞—Å—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä 3.5'); return; }
  addEntry({date:selectedDateStr, kind:'ot', hours:v});
  $('#hours').value='';
  setSelectedDate(selectedDateStr);
});

$('#quick').addEventListener('click',e=>{
  const b = e.target.closest('[data-qk]'); if(!b) return;
  const tag = b.dataset.qk, iso = selectedDateStr;
  if(tag==='hrs-3.5') addEntry({date:iso, kind:'ot', hours:3.5});
  else if(tag==='hrs-8') addEntry({date:iso, kind:'ot', hours:8});
  else if(tag==='leave-hours'){
    const v = parseFloat(($('#hours').value||'0').replace(',','.')) || 0.5;
    addEntry({date:iso, kind:'leaveHours', hours:v});
  }else if(tag==='vacation'){
    addEntry({date:iso, kind:'vac', days:1});
  }
  setSelectedDate(iso);
});

/* =========================
   Payroll logic
========================= */
function groupByYm(){
  const map={}; for(const r of state.entries){ (map[ymOf(r.date)] ||= []).push(r); }
  return map;
}
function monthStats(ym){
  const list = groupByYm()[ym]||[];
  let otHours=0, leaveHours=0, vacationDays=0;
  for(const r of list){
    if(r.kind==='ot') otHours+=r.hours||0;
    else if(r.kind==='leaveHours') leaveHours+=r.hours||0;
    else if(r.kind==='vac') vacationDays+=r.days||1;
  }
  return {otHours, leaveHours, vacationDays};
}

function collectLastMonths(curYm, n){
  const [y,m] = curYm.split('-').map(Number);
  const arr=[];
  for(let i=0;i<n;i++){
    const d=new Date(y, m-1-i, 1);
    arr.push(d.toISOString().slice(0,7));
  }
  return arr.reverse();
}

function estimateBySalary(ym){
  const s = state.settings;
  const wd = autoWorkdaysForMonth(ym);
  const hourly = (s.salary||0)/wd/(s.hoursPerDay||8);
  return { totalForAvg: hourly*wd*(s.hoursPerDay||8) };
}

const monthTotals = {}; // for future; now use estimate only when missing

function avgDailyIncome(curYm){
  const xs = collectLastMonths(curYm,12);
  let total=0;
  for(const ym of xs){
    const t = monthTotals[ym] || estimateBySalary(ym);
    total += t.totalForAvg||0;
  }
  return total / (29.3*12);
}

function countWeekdaysInVacation(ym, dates){
  // dates: –º–∞—Å—Å–∏–≤ ISO –¥–∞—Ç –æ—Ç–ø—É—Å–∫–∞ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ; —É –Ω–∞—Å —Ö—Ä–∞–Ω–∏–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–æ days, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–±–ª–∏–∑–∏–º: —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏
  // —É–ø—Ä–æ—â–µ–Ω–∏–µ: vacationDays —É–∂–µ –ø–æ—Å—á–∏—Ç–∞–Ω—ã; –¥–ª—è production —Å—á–∏—Ç–∞–µ–º ¬´–±—É–¥–Ω–∏–µ –¥–æ–ª–∏¬ª
  // —Ç–æ—á–Ω–∞—è –ø–æ–º–µ—Å—è—á–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç—Ä–µ–±—É–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞—Ç—ã –æ—Ç–ø—É—Å–∫–∞ ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∑–∂–µ.
  // –ó–¥–µ—Å—å –ø—Ä–∏–º–µ–º, —á—Ç–æ –æ—Ç–ø—É—Å–∫–Ω—ã–µ –¥–Ω–∏ –ª–µ–∂–∞–ª–∏ –Ω–∞ –±—É–¥–Ω—è—Ö (—Å–∞–º—ã–π —á–∞—Å—Ç—ã–π —Å–ª—É—á–∞–π).
  return dates?.length||0; // –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏; –Ω–∏–∂–µ –±—É–¥–µ—Ç –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –ø–æ vacationDays
}

function calcOvertimeMoney(ym, hourly){
  // –ø—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å: –≤—Å–µ –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –ø–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É 2.0; (–º–æ–∂–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
  const st = monthStats(ym);
  return round2(st.otHours * (2.0*hourly));
}

function computePayroll(ym){
  const s = state.settings;
  const wdPlan = autoWorkdaysForMonth(ym);
  const st = monthStats(ym);

  const hourly = (s.salary||0)/wdPlan/(s.hoursPerDay||8);

  const vacDaysPaid = (s.leaveMode==='calendar') ? st.vacationDays : st.vacationDays; // —Å–º. –ø–æ—è—Å–Ω–µ–Ω–∏–µ –≤—ã—à–µ
  const workedDays = Math.max(0, wdPlan - vacDaysPaid);

  const baseHours = Math.max(0, workedDays*(s.hoursPerDay||8) - st.leaveHours);
  const basePay = round2(baseHours * hourly);

  const overtimePay = calcOvertimeMoney(ym, hourly);

  const avgDaily = avgDailyIncome(ym);
  const vacationPay = round2(avgDaily * vacDaysPaid);

  const total = round2(basePay + overtimePay + vacationPay);

  return {hourly, basePay, overtimePay, vacationPay, total, st};
}

/* =========================
   day list rendering
========================= */
function typeLabel(x){
  if(x.kind==='ot') return '–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞';
  if(x.kind==='leaveHours') return '–û—Ç–≥—É–ª';
  if(x.kind==='vac') return '–û—Ç–ø—É—Å–∫';
  return '‚Äî';
}
function typeIcon(x){
  if(x.kind==='ot') return 'üî®';
  if(x.kind==='leaveHours') return '‚õî';
  if(x.kind==='vac') return 'üèñ';
  return '';
}

function renderDayList(){
  const iso = selectedDateStr;
  const ym = ymOf(iso);
  const arr = (state.entries||[]).map((v,i)=>({...v,_i:i})).filter(x=>x.date===iso);

  $('#dayTitle').textContent =
    new Date(iso+'T00:00:00').toLocaleDateString('ru-RU',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  const box = $('#dayList'); box.innerHTML='';
  if(arr.length===0){
    box.innerHTML = '<div class="mut">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</div>';
  }else{
    for(const r of arr){
      const row = document.createElement('div');
      row.className='row';
      const hours = r.hours? r.hours.toFixed(2) : (r.days ? (r.days+' –¥–Ω.') : '');
      const money = r.kind==='ot' ? '‚Ä¶' : '‚Äî';
      row.innerHTML = `
        <div>${typeIcon(r)} ${typeLabel(r)}</div>
        <div class="mut">${hours}</div>
        <div class="money">${money}</div>
        <div><button class="btn btn-pill" data-del="${r._i}">–£–¥–∞–ª–∏—Ç—å</button></div>`;
      box.appendChild(row);
    }
    box.addEventListener('click',e=>{
      const b=e.target.closest('[data-del]'); if(!b) return;
      removeEntry(+b.dataset.del);
      setSelectedDate(selectedDateStr);
    },{once:true});
  }

  // totals
  const t = computePayroll(ym);
  const tot = $('#totals');
  tot.innerHTML = `
    <span class="pill">–ë–∞–∑–∞: ${fmtMoney(t.basePay)}</span>
    <span class="pill">–ü–æ—á–∞—Å–æ–≤–∞—è: ${Math.round(t.hourly)||0} ‚ÇΩ/—á</span>
    <span class="pill badge-ok">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏: ${fmtMoney(t.overtimePay)} (—á–∞—Å—ã: ${t.st.otHours.toFixed(2)})</span>
    <span class="pill">–û—Ç–≥—É–ª: ${t.st.leaveHours.toFixed(2)} —á</span>
    <span class="pill">–û—Ç–ø—É—Å–∫: ${fmtMoney(t.vacationPay)}</span>
    <span class="pill" style="font-weight:800">–ò—Ç–æ–≥–æ: ${fmtMoney(t.total)}</span>
  `;
}

/* =========================
   holidays tab
========================= */
let holidaysView = new Date(); holidaysView.setDate(1);

function renderHolidays(){
  const y=holidaysView.getFullYear(), m=holidaysView.getMonth();
  monthTitle($('#hTitle'), y, m);
  const ym = `${y}-${String(m+1).padStart(2,'0')}`;
  const set = new Set((state.holidays[ym]||[]).map(Number));
  const grid = $('#hGrid'); grid.innerHTML='';
  for(const c of monthCells(y,m)){
    if(!c.dateIso){ grid.appendChild(document.createElement('div')); continue; }
    const d = new Date(c.dateIso).getDate();
    const b = document.createElement('button');
    b.className='cal-day'+(set.has(d)?' selected':'');
    b.innerHTML=`<span>${d}</span><span class="badge">${set.has(d)?'üéâ':''}</span>`;
    b.addEventListener('click',()=>{
      if(set.has(d)) set.delete(d); else set.add(d);
      state.holidays[ym]=Array.from(set).sort((a,b)=>a-b);
      save(state);
      // –æ–±–Ω–æ–≤–∏–º –∞–≤—Ç–æ-—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç—É
      if(ym===ymOf(selectedDateStr)) refreshSettingsUI(), renderDayList();
      renderHolidays(); renderCalendar();
    });
    grid.appendChild(b);
  }
}

/* =========================
   tabs & nav
========================= */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id=t.dataset.tab;
    $('#tab-journal').style.display = id==='journal'?'':'none';
    $('#tab-settings').style.display = id==='settings'?'':'none';
    $('#tab-holidays').style.display = id==='holidays'?'':'none';
    $('#tab-import').style.display = id==='import'?'':'none';
    if(id==='settings') refreshSettingsUI();
    if(id==='holidays') renderHolidays();
  });
});

$('#prevM').addEventListener('click',()=>{ viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); });
$('#nextM').addEventListener('click',()=>{ viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); });

$('#hPrev').addEventListener('click',()=>{ holidaysView.setMonth(holidaysView.getMonth()-1); renderHolidays();});
$('#hNext').addEventListener('click',()=>{ holidaysView.setMonth(holidaysView.getMonth()+1); renderHolidays();});

/* =========================
   settings events
========================= */
$('#salary').addEventListener('input',e=>{ set('salary', +e.target.value.replace(/\s/g,'')); renderDayList(); });
$('#hoursPerDay').addEventListener('input',e=>{ set('hoursPerDay', +e.target.value||8); renderDayList(); });
$('#leaveMode').addEventListener('change',e=>{ set('leaveMode', e.target.value); renderDayList(); });

/* =========================
   import/export
========================= */
$('#btnExport').addEventListener('click',()=>{
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'paycalc_data.json';
  a.click();
  URL.revokeObjectURL(a.href);
});

$('#fileIn').addEventListener('change',async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    if(!data || typeof data!=='object') throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON');
    // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
    data.entries ||= [];
    data.settings ||= {salary:0,hoursPerDay:8,leaveMode:'production'};
    data.holidays ||= {};
    state = data; save(state);
    $('#importMsg').textContent='–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω';
    // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
    setSelectedDate(state.selectedDate||todayIso());
    renderCalendar(); refreshSettingsUI(); renderHolidays();
  }catch(err){
    $('#importMsg').textContent='–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message;
  }
});

/* =========================
   hard refresh
========================= */
$('#btnHardRefresh').addEventListener('click', async()=>{
  if('serviceWorker' in navigator){
    const regs = await navigator.serviceWorker.getRegistrations();
    for(const r of regs){ try{ await r.unregister(); }catch{} }
  }
  if('caches' in window){ const keys=await caches.keys(); for(const k of keys) await caches.delete(k); }
  location.reload(true);
});

/* =========================
   boot
========================= */
(function boot(){
  const dISO = selectedDateStr || todayIso();
  setSelectedDate(dISO);
  refreshSettingsUI();
})();
</script>
</body>
</html>
