<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</title>
<link rel="manifest" href="manifest.webmanifest">
<style>
  :root{
    --bg:#0f1115;--card:#151922;--muted:#9aa3b2;--on:#e7ecf3;--accent:#4c8dff;
    --ok:#2bb673;--danger:#d04949;--warn:#caa43a;--chip:#1c2432;--chip-on:#d7e2ff;
    --ring:#3a67f0;--chip-muted:#202736;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--on);font:16px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:920px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:6px 0 14px}
  h1{font-size:28px;margin:0 12px 0 0}
  .tabs{display:flex;gap:10px;flex-wrap:wrap}
  .tab{padding:10px 16px;border:1px solid #2a3241;border-radius:14px;background:#121722;color:var(--on);cursor:pointer}
  .tab.active{background:#1b2230;border-color:#3a475d}
  .card{background:var(--card);border:1px solid #262d3a;border-radius:16px;padding:16px;margin:14px 0}
  .card-title{font-weight:700;margin-bottom:10px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:640px){.grid-2,.grid-3{grid-template-columns:1fr}}
  .field span{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type="number"],input[type="text"],select,button,.pill{
    height:44px;border-radius:12px;border:1px solid #2a3241;background:#111620;color:var(--on);
    padding:0 12px;font-size:16px;outline:none
  }
  input[readonly]{opacity:.7}
  button.primary{background:var(--accent);border-color:#3c77e6;color:#fff}
  button.ghost{background:#131824}
  .hint{color:var(--muted);font-size:13px}
  .quick-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .quick{height:56px;border-radius:14px;background:#131a27;border:1px solid #24314a}
  .calendar{user-select:none}
  .cal-head{display:flex;align-items:center;justify-content:space-between;margin:4px 0 10px}
  .cal-title{font-size:28px;font-weight:800}
  .cal-nav{display:flex;gap:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border-radius:999px;padding:6px 10px;margin-right:8px;color:var(--chip-on);font-size:13px;border:1px solid #2a3346}
  .days{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
  .dow{color:var(--muted);text-align:center}
  .day{height:64px;border-radius:18px;background:#131a27;border:1px solid #24314a;display:flex;align-items:center;justify-content:center;position:relative}
  .day.disabled{opacity:.35}
  .day .num{font-weight:700}
  .day .badge{position:absolute;bottom:6px;left:0;right:0;text-align:center;font-size:20px;line-height:1}
  .day.sel{outline:3px solid var(--ring);outline-offset:0}
  .legend{margin-top:8px}
  .list{display:grid;gap:8px;margin-top:10px}
  .entry{display:flex;align-items:center;justify-content:space-between;background:#121826;border:1px solid #223043;border-radius:14px;padding:12px}
  .chip-kpi{display:inline-block;background:#122013;border:1px solid #24472c;color:#bfe9c6;border-radius:999px;padding:8px 12px;margin:6px 6px 0 0}
  .chip-pay{display:inline-block;background:#111d2a;border:1px solid #274966;color:#d2e9ff;border-radius:999px;padding:8px 12px;margin:6px 6px 0 0}
  .danger{background:#2b1517;border-color:#5a2a30}
  .footer-note{color:var(--muted);font-size:12px;margin-top:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏</h1>
    <div class="tabs">
      <button class="tab active" data-tab="journal">–ñ—É—Ä–Ω–∞–ª</button>
      <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="tab" data-tab="holidays">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
      <button class="tab" data-tab="import">–ò–º–ø–æ—Ä—Ç</button>
    </div>
  </header>

  <!-- JOURNAL -->
  <section id="tab-journal" class="card">
    <div class="card">
      <div class="grid-2">
        <label class="field">
          <span>–î–∞—Ç–∞</span>
          <input id="in-date" type="text" readonly>
        </label>
        <div class="row" style="align-items:end;justify-content:flex-end">
          <button id="btn-today" class="ghost">–°–µ–≥–æ–¥–Ω—è</button>
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <label class="field">
          <span>–ß–∞—Å—ã</span>
          <input id="in-hours" type="text" placeholder="–Ω–∞–ø—Ä., 3.5">
        </label>
        <div class="row" style="align-items:end;justify-content:flex-end">
          <button id="btn-add" class="primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hint" style="margin-bottom:8px">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ ¬´–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞¬ª):</div>
        <div class="quick-grid">
          <button class="quick" data-q="hrs:3.5">3.5 —á</button>
          <button class="quick" data-q="hrs:8">8 —á</button>
          <button class="quick" data-q="unpaid">–û—Ç–≥—É–ª</button>
          <button class="quick" data-q="leave">–û—Ç–ø—É—Å–∫</button>
        </div>
      </div>
    </div>

    <div class="card calendar">
      <div class="cal-head">
        <div class="cal-nav">
          <button id="prev" class="ghost">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
        </div>
        <div id="cal-title" class="cal-title">‚Äì</div>
        <div class="cal-nav">
          <button id="next" class="ghost">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
        </div>
      </div>

      <div class="days dow">
        <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
      </div>
      <div id="days" class="days" style="margin-top:8px"></div>

      <div class="legend">
        <span class="chip">üîß ‚Äî –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞</span>
        <span class="chip">‚õî ‚Äî –æ—Ç–≥—É–ª (—á–∞—Å—ã)</span>
        <span class="chip">üèñÔ∏è ‚Äî –æ—Ç–ø—É—Å–∫</span>
        <span class="chip">üéâ ‚Äî –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π</span>
      </div>
    </div>

    <div class="card" id="day-panel">
      <div id="day-title" class="card-title">‚Äî</div>
      <div class="list" id="day-list"></div>
      <div id="totals" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" class="card" style="display:none">
    <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—á—ë—Ç–∞</div>

    <div class="grid-2">
      <label class="field">
        <span>–û–∫–ª–∞–¥ (–Ω–∞ —Ä—É–∫–∏), ‚ÇΩ</span>
        <input id="st-salary" type="number" step="1" min="0" inputmode="numeric">
      </label>
      <label class="field">
        <span>–ß–∞—Å–æ–≤ –≤ –¥–Ω–µ</span>
        <input id="st-hpd" type="number" step="0.5" min="1" inputmode="decimal">
      </label>
    </div>

    <div class="grid-2" style="margin-top:8px">
      <label class="field">
        <span>–¢–∏–ø –æ—Ç–ø—É—Å–∫–∞</span>
        <select id="st-leave-type">
          <option value="production">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π (—Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏–µ)</option>
          <option value="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π (–≤—Å–µ –¥–Ω–∏)</option>
        </select>
      </label>
      <label class="field">
        <span>–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (–∞–≤—Ç–æ, –ü–Ω‚Äì–ü—Ç) ‚Äî —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</span>
        <input id="st-workdays" type="number" min="0" step="1" readonly>
      </label>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="card-title">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ–¥—Ä–∞–±–æ—Ç–æ–∫</div>
      <div class="grid-2">
        <label class="field">
          <span>–ë—É–¥–Ω–∏ ‚Äî –ø–µ—Ä–≤—ã–µ 2 —á</span>
          <input id="st-weekday-first2" type="number" step="0.1" min="1" inputmode="decimal">
        </label>
        <label class="field">
          <span>–ë—É–¥–Ω–∏ ‚Äî –¥–∞–ª—å—à–µ</span>
          <input id="st-weekday-next" type="number" step="0.1" min="1" inputmode="decimal">
        </label>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <label class="field">
          <span>–°—É–±–±–æ—Ç–∞</span>
          <input id="st-saturday" type="number" step="0.1" min="1" inputmode="decimal">
        </label>
        <label class="field">
          <span>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</span>
          <input id="st-sunday" type="number" step="0.1" min="1" inputmode="decimal">
        </label>
        <label class="field">
          <span>–ü—Ä–∞–∑–¥–Ω–∏–∫</span>
          <input id="st-holiday" type="number" step="0.1" min="1" inputmode="decimal">
        </label>
      </div>
    </div>

    <div class="footer-note">–í–µ—Ä—Å–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–µ–∑ SW-–∫—ç—à–∞.</div>
  </section>

  <!-- HOLIDAYS -->
  <section id="tab-holidays" class="card" style="display:none">
    <div class="card-title">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ –º–µ—Å—è—Ü–∞</div>
    <div class="hint" id="hol-caption"></div>
    <div id="hol-grid" class="days" style="margin-top:10px"></div>
  </section>

  <!-- IMPORT -->
  <section id="tab-import" class="card" style="display:none">
    <div class="card-title">–ò–º–ø–æ—Ä—Ç / –≠–∫—Å–ø–æ—Ä—Ç</div>
    <div class="row" style="gap:10px;margin-bottom:12px">
      <button id="btn-export" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <input id="file" type="file" accept=".json,application/json">
    </div>
    <div class="hint">–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Å–æ–≤–ø–∞–¥–∞—é—â–∏–µ –º–µ—Å—è—Ü—ã. –§–æ—Ä–º–∞—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º —Å —ç—Ç–æ–π –≤–µ—Ä—Å–∏–µ–π.</div>
  </section>
</div>

<!-- dayjs -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/ru.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
<script>dayjs.locale('ru');</script>

<script>
/* ========= –ü —Ö —Ä –∞ –Ω –∏ –ª –∫ –∞ ========= */
const LS_KEY='paycalc_state_v5';

const state = load() || {
  settings: {
    salary: 0,
    hoursPerDay: 8,
    leaveType: 'production', // production|calendar
    weekdayFirst2: 1.5,
    weekdayNext:   2.0,
    saturday:      1.5,
    sunday:        2.0,
    holiday:       2.0,
    workdaysAuto: {} // {'YYYY-MM': number}
  },
  // –∑–∞–ø–∏—Å–∏: {'YYYY-MM': [{date,kind:'overtime'|'unpaid', hours:number}]}
  entries: {},
  // –ø—Ä–∞–∑–¥–Ω–∏–∫–∏: {'YYYY-MM': ['YYYY-MM-DD',...]}
  holidays: {},
  // –æ—Ç–ø—É—Å–∫–∞: {'YYYY-MM': ['YYYY-MM-DD',...]}
  leaves: {}
};

function save(){localStorage.setItem(LS_KEY,JSON.stringify(state));}
function load(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'');}catch(e){return null}}

function q(s,root=document){return root.querySelector(s)}
function qa(s,root=document){return Array.from(root.querySelectorAll(s))}
function round2(x){return Math.round((x+Number.EPSILON)*100)/100}
function ymOf(d){return dayjs(d).format('YYYY-MM')}
function today(){return dayjs().format('YYYY-MM-DD')}

/* ========= Tabs ========= */
qa('.tab').forEach(btn=>{
  btn.onclick=()=>{
    qa('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t=btn.dataset.tab;
    qa('section[id^="tab-"]').forEach(s=>s.style.display='none');
    q('#tab-'+t).style.display='';
    if(t==='holidays') renderHolidays(currentYM());
    if(t==='settings') updateWorkdaysAuto(currentYM()), bindSettingsUI();
  }
});

/* ========= Calendar ========= */
let cur = dayjs().startOf('month');
let selected = dayjs().format('YYYY-MM-DD');

q('#btn-today').onclick = ()=>{ selected=today(); cur=dayjs(selected).startOf('month'); renderAll(); };

q('#prev').onclick = ()=>{cur=cur.subtract(1,'month'); selected=cur.startOf('month').format('YYYY-MM-DD'); renderAll();};
q('#next').onclick = ()=>{cur=cur.add(1,'month'); selected=cur.startOf('month').format('YYYY-MM-DD'); renderAll();};

function currentYM(){return cur.format('YYYY-MM');}

function renderCalendar(){
  const title = cur.format('MMMM YYYY –≥.');
  q('#cal-title').textContent = title;

  const firstDow = (cur.day()+6)%7; // –ü–Ω=0..–í—Å=6
  const daysInMonth = cur.daysInMonth();
  const prevPad = firstDow;
  const totalCells = Math.ceil((prevPad+daysInMonth)/7)*7;

  const hol = state.holidays[currentYM()]||[];
  const leaves = state.leaves[currentYM()]||[];
  const entries = state.entries[currentYM()]||[];

  const grid = document.createDocumentFragment();
  for(let i=0;i<totalCells;i++){
    const cell = document.createElement('div');
    cell.className='day';
    const dayIndex = i - prevPad + 1;
    const inMonth = dayIndex>=1 && dayIndex<=daysInMonth;

    if(!inMonth){
      cell.classList.add('disabled');
      cell.innerHTML = '<div class="num" style="opacity:.25">¬∑</div>';
      grid.appendChild(cell);
      continue;
    }

    const date = cur.date(dayIndex).format('YYYY-MM-DD');
    if(date===selected) cell.classList.add('sel');

    const num = document.createElement('div');
    num.className='num';
    num.textContent= dayIndex;
    cell.appendChild(num);

    const badge = document.createElement('div');
    badge.className='badge';

    const hasOt = entries.some(e=>e.date===date && e.kind==='overtime');
    const hasUn = entries.some(e=>e.date===date && e.kind==='unpaid');
    const isLeave = leaves.includes(date);
    const isHol = hol.includes(date);

    let mark = '';
    if(hasOt) mark+='üîß';
    if(hasUn) mark+='‚õî';
    if(isLeave) mark+='üèñÔ∏è';
    if(isHol) mark+='üéâ';
    badge.textContent = mark;
    cell.appendChild(badge);

    cell.onclick = ()=>{
      selected=date;
      renderAll();
    };
    grid.appendChild(cell);
  }
  const daysEl = q('#days'); daysEl.innerHTML=''; daysEl.appendChild(grid);
  q('#in-date').value = dayjs(selected).format('D MMM YYYY –≥.');
}

function renderDayPanel(){
  q('#day-title').textContent = dayjs(selected).format('dddd, D MMMM YYYY –≥.');
  const list = q('#day-list'); list.innerHTML='';

  const ym = currentYM();
  const items = (state.entries[ym]||[]).filter(e=>e.date===selected);
  const isLeave = (state.leaves[ym]||[]).includes(selected);

  if(isLeave){
    const row = document.createElement('div');
    row.className='entry';
    row.innerHTML = `<div>üèñÔ∏è –û—Ç–ø—É—Å–∫</div>
                     <button class="ghost danger" data-act="del-leave">–£–¥–∞–ª–∏—Ç—å</button>`;
    row.querySelector('button').onclick = ()=>{toggleLeave(selected,true);};
    list.appendChild(row);
  }

  for(const e of items){
    const icon = e.kind==='overtime'?'üîß':'‚õî';
    const title = e.kind==='overtime'?'–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞':'–û—Ç–≥—É–ª';
    const row = document.createElement('div');
    row.className='entry';
    row.innerHTML = `<div>${icon} <b>${title}</b> ‚Ä¢ ${e.hours.toFixed(2)}</div>
                     <button class="ghost danger">–£–¥–∞–ª–∏—Ç—å</button>`;
    row.querySelector('button').onclick = ()=>{
      removeEntry(ym,e);
      renderAll();
    };
    list.appendChild(row);
  }

  renderTotals(ym);
}

/* ========= Entries ops ========= */
function removeEntry(ym, entry){
  const arr = state.entries[ym]||[];
  const idx = arr.indexOf(entry);
  if(idx>=0){ arr.splice(idx,1); state.entries[ym]=arr; save(); }
}

function upsertOvertime(date,hours){
  const ym = ymOf(date);
  if(!state.entries[ym]) state.entries[ym]=[];
  // –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞ –≤ –¥–µ–Ω—å ‚Äî –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å, –∑–∞–º–µ–Ω—è–µ–º
  const arr = state.entries[ym];
  const ex = arr.find(e=>e.date===date && e.kind==='overtime');
  if(ex){ ex.hours=hours; } else { arr.push({date,kind:'overtime',hours}); }
  save();
}

function addUnpaid(date,hours){
  const ym = ymOf(date);
  if(!state.entries[ym]) state.entries[ym]=[];
  state.entries[ym].push({date,kind:'unpaid',hours});
  save();
}

function toggleLeave(date, removeOnly=false){
  const ym=ymOf(date);
  const list=state.leaves[ym]||[];
  const i=list.indexOf(date);
  if(i>=0){ list.splice(i,1); } else if(!removeOnly){ list.push(date); }
  state.leaves[ym]=list; save();
}

/* ========= Totals ========= */
function countWorkdaysPnPtExcludingHolidays(ym, holList){
  const m = dayjs(ym+'-01'); const last = m.daysInMonth();
  let c=0;
  for(let d=1;d<=last;d++){
    const cur=m.date(d);
    const dow=cur.day(); // 0=Sun..6
    const iso=(dow+6)%7; // 0..6 Mon..Sun
    const dt=cur.format('YYYY-MM-DD');
    if(iso<=4 && !(holList||[]).includes(dt)) c++;
  }
  return c;
}

function calcAvgDaily(){
  // –ø—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞: –µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –ø–æ –æ–∫–ª–∞–¥—É —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
  // (–º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É—è 12 –º–µ—Å –∏—Å—Ç–æ—Ä–∏–∏)
  const s=state.settings;
  const ym=currentYM();
  const wd = s.workdaysAuto[ym] ?? countWorkdaysPnPtExcludingHolidays(ym, state.holidays[ym]);
  const perDay=(s.salary||0)/(wd||1);
  return perDay; // —Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π
}

function calcOvertimeForMonth(ym,s){
  const perHour=(s.salary||0)/((s.hoursPerDay||8)*(s.workdaysAuto[ym] ?? countWorkdaysPnPtExcludingHolidays(ym,state.holidays[ym])||1));
  const entries=(state.entries[ym]||[]).filter(e=>e.kind==='overtime');
  const hol=state.holidays[ym]||[];
  let pay=0,hrs=0;
  for(const e of entries){
    const h=e.hours||0;
    const d=dayjs(e.date); const dow=d.day(); const isHol=hol.includes(e.date);
    if(isHol){
      pay+= perHour*h*(s.holiday??2);
    }else if(dow===0){
      pay+= perHour*h*(s.sunday??2);
    }else if(dow===6){
      pay+= perHour*h*(s.saturday??1.5);
    }else{
      const first=Math.min(h,2), rest=Math.max(0,h-2);
      pay+= perHour*( first*(s.weekdayFirst2??1.5) + rest*(s.weekdayNext??2) );
    }
    hrs+=h;
  }
  return {overtimePay:pay,overtimeHours:hrs};
}

function calcTotalsForMonth(ym){
  const s=state.settings;
  const hol=state.holidays[ym]||[];
  const wdAuto = s.workdaysAuto[ym] ?? countWorkdaysPnPtExcludingHolidays(ym,hol);
  q('#st-workdays').value = wdAuto;

  const leaves = state.leaves[ym]||[];
  const leaveDays = (s.leaveType==='calendar')
    ? leaves.length
    : leaves.filter(dt=>{
        const d=dayjs(dt), dow=d.day(); const iso=(dow+6)%7;
        return iso<=4 && !hol.includes(dt);
      }).length;

  const hoursPerDay = s.hoursPerDay||8;
  const basePerDay = (s.salary||0)/(wdAuto||1);
  const basePerHour = basePerDay/hoursPerDay;

  // –æ—Ç–≥—É–ª—ã (–º–∏–Ω—É—Å)
  const unpaidHours = (state.entries[ym]||[])
    .filter(e=>e.kind==='unpaid')
    .reduce((a,e)=>a+(e.hours||0),0);

  const baseHours = Math.max(0, (wdAuto - (s.leaveType==='production'?leaveDays:0)) * hoursPerDay - unpaidHours);
  const basePay = basePerHour * baseHours;

  // –æ—Ç–ø—É—Å–∫–Ω—ã–µ
  const leavePay = calcAvgDaily() * leaveDays;

  const {overtimePay,overtimeHours} = calcOvertimeForMonth(ym,s);
  const total = round2(basePay + leavePay + overtimePay);

  // –≤—ã–≤–µ—Å—Ç–∏
  const t=q('#totals'); t.innerHTML='';
  const chips=document.createElement('div');

  chips.innerHTML = `
    <span class="chip-kpi">–ë–∞–∑–∞: ${fmt(basePay)}</span>
    <span class="chip-kpi">–ü–æ—á–∞—Å–æ–≤–∞—è: ${fmt(basePerHour)} ‚ÇΩ/—á</span>
    <span class="chip-pay">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏: ${fmt(overtimePay)} (—á–∞—Å—ã: ${overtimeHours.toFixed(2)})</span>
    <span class="chip-kpi">–û—Ç–≥—É–ª: ${unpaidHours.toFixed(2)} —á</span>
    <span class="chip-pay">–û—Ç–ø—É—Å–∫: ${fmt(leavePay)} (–¥–Ω.: ${leaveDays})</span>
    <div style="margin-top:10px;font-weight:800">–ò—Ç–æ–≥–æ: ${fmt(total)}</div>
  `;
  t.appendChild(chips);
}

function fmt(n){return (n||0).toLocaleString('ru-RU',{maximumFractionDigits:2})+' ‚ÇΩ';}

/* ========= UI actions ========= */
q('#btn-add').onclick=()=>{
  const h = parseFloat(q('#in-hours').value.replace(',','.'));
  if(!(h>0)) return;
  upsertOvertime(selected,h);
  q('#in-hours').value='';
  renderAll();
};
qa('.quick').forEach(b=>{
  b.onclick=()=>{
    const tag=b.dataset.q;
    if(tag.startsWith('hrs:')){
      const h=parseFloat(tag.split(':')[1]);
      upsertOvertime(selected,h);
    }else if(tag==='unpaid'){
      const h=parseFloat(prompt('–°–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –æ—Ç–≥—É–ª–∞ –≤—ã—á–µ—Å—Ç—å?','0.5').replace(',','.'));
      if(h>0) addUnpaid(selected,h);
    }else if(tag==='leave'){
      toggleLeave(selected);
    }
    renderAll();
  };
});

/* ========= Holidays tab ========= */
function renderHolidays(ym){
  q('#hol-caption').textContent = '–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: '+ym+'. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–µ–Ω—å –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.';
  const m=dayjs(ym+'-01'); const last=m.daysInMonth();
  const hol=state.holidays[ym]||[];
  const grid=q('#hol-grid'); grid.innerHTML='';
  for(let d=1;d<=last;d++){
    const dt=m.date(d).format('YYYY-MM-DD');
    const btn=document.createElement('button');
    btn.className='pill'; btn.textContent=d;
    btn.style.background = hol.includes(dt)?'#3a1c24':'#131a27';
    btn.onclick=()=>{
      const list=state.holidays[ym]||[];
      const i=list.indexOf(dt);
      if(i>=0) list.splice(i,1); else list.push(dt);
      state.holidays[ym]=list; save();
      updateWorkdaysAuto(ym);
      renderHolidays(ym); renderAll();
    };
    grid.appendChild(btn);
  }
}

/* ========= Settings bind ========= */
function withDefaultsSettings(s){ // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å—Ç–æ—Ä–∞–¥–∂–µ–π
  return {
    salary: s.salary ?? 0,
    hoursPerDay: s.hoursPerDay ?? 8,
    leaveType: s.leaveType ?? 'production',
    weekdayFirst2: s.weekdayFirst2 ?? 1.5,
    weekdayNext:   s.weekdayNext   ?? 2.0,
    saturday:      s.saturday      ?? 1.5,
    sunday:        s.sunday        ?? 2.0,
    holiday:       s.holiday       ?? 2.0,
    workdaysAuto:  s.workdaysAuto ?? {}
  };
}
state.settings = withDefaultsSettings(state.settings);

function bindSettingsUI(){
  const s=state.settings;
  q('#st-salary').value=s.salary;
  q('#st-hpd').value=s.hoursPerDay;
  q('#st-leave-type').value=s.leaveType;
  q('#st-weekday-first2').value=s.weekdayFirst2;
  q('#st-weekday-next').value=s.weekdayNext;
  q('#st-saturday').value=s.saturday;
  q('#st-sunday').value=s.sunday;
  q('#st-holiday').value=s.holiday;

  q('#st-salary').oninput=e=>{s.salary=+e.target.value||0; save(); renderAll();}
  q('#st-hpd').oninput=e=>{s.hoursPerDay=parseFloat(e.target.value.replace(',','.'))||8; save(); renderAll();}
  q('#st-leave-type').onchange=e=>{s.leaveType=e.target.value; save(); renderAll();}

  ['st-weekday-first2','st-weekday-next','st-saturday','st-sunday','st-holiday'].forEach(id=>{
    q('#'+id).oninput=(e)=>{
      const v=parseFloat(e.target.value.replace(',','.'))||0;
      const map={'st-weekday-first2':'weekdayFirst2','st-weekday-next':'weekdayNext','st-saturday':'saturday','st-sunday':'sunday','st-holiday':'holiday'};
      s[map[id]]=v; save(); renderAll();
    };
  });

  updateWorkdaysAuto(currentYM());
}

function updateWorkdaysAuto(ym){
  const wd = countWorkdaysPnPtExcludingHolidays(ym, state.holidays[ym]);
  state.settings.workdaysAuto[ym]=wd; save();
  q('#st-workdays').value=wd;
}

/* ========= Import/Export ========= */
q('#btn-export').onclick=()=>{
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paycalc_data.json'; a.click();
};
q('#file').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(data.settings) state.settings = withDefaultsSettings(data.settings);
      if(data.entries) state.entries = data.entries;
      if(data.holidays) state.holidays = data.holidays;
      if(data.leaves) state.leaves = data.leaves;
      save(); renderAll(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
  };
  r.readAsText(f);
};

/* ========= Boot ========= */
function renderAll(){ renderCalendar(); renderDayPanel(); if(q('.tab.active').dataset.tab==='settings') bindSettingsUI(); }
bindSettingsUI();
renderAll();
</script>
</body>
</html>
