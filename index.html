<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</title>
<style>
  :root{
    --bg:#0f1115; --card:#161b22; --mut:#9aa4b2; --text:#e6eef8; --accent:#3b82f6; --accent-2:#2563eb;
    --ok:#16a34a; --danger:#ef4444; --pill:#0b1220; --border:#202735;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:940px;margin:0 auto;padding:16px}
  .h1{font-weight:800;font-size:28px;margin:6px 0 14px}
  .tabs{display:flex;gap:12px;margin:4px 0 14px}
  .tab{border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 16px;border-radius:14px;cursor:pointer}
  .tab.active{outline:2px solid var(--accent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;align-items:center}
  .row.wrap{flex-wrap:wrap}
  .grow{flex:1}
  .btn{border:1px solid var(--border);background:#1f2937;color:var(--text);border-radius:14px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent-2)}
  .btn.danger{background:#3a0d12;border-color:#7f1d1d}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0e1420;color:var(--text)}
  .mut{color:var(--mut)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .quick{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
  .quick .btn{padding:16px 8px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);padding:6px 10px;border-radius:999px;border:1px solid var(--border)}
  .mtt{margin-top:8px}
  .mt-12{margin-top:12px}
  .section-title{font-weight:700;margin:2px 0 8px}
  /* calendar */
  .cal-head{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px;margin-bottom:6px}
  .cal-title{font-weight:800;font-size:22px;text-align:center}
  .cal-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:6px 0 8px;color:var(--mut)}
  .cal-dow span{text-align:center}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cal-day{position:relative;border:1px solid var(--border);background:#0f1420;border-radius:18px;min-height:60px;padding:6px 6px 4px;text-align:center;color:var(--text);cursor:pointer}
  .cal-day .num{display:block;font-weight:700;margin-bottom:2px}
  .cal-day .badge{font-size:15px;line-height:1}
  .cal-day.selected{outline:3px solid var(--accent);outline-offset:0}
  .legend{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px;color:var(--mut)}
  .legend span{display:inline-flex;align-items:center;gap:6px}
  .rowline{display:grid;grid-template-columns:1fr 100px 130px 110px;gap:8px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;margin:6px 0}
  .money{text-align:right}
  .totals{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .totals .pill{background:#0f1625}
  @media (max-width:560px){
    .rowline{grid-template-columns:1fr 70px 90px 100px}
    .cal-day{min-height:56px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="h1">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</div>

    <div class="tabs">
      <button class="tab active" data-tab="journal">–ñ—É—Ä–Ω–∞–ª</button>
      <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="tab" data-tab="holidays">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
      <button class="tab" data-tab="import">–ò–º–ø–æ—Ä—Ç</button>
    </div>

    <!-- JOURNAL -->
    <section id="journal" class="tabpage">
      <div class="card">
        <div class="row wrap">
          <div class="grow">
            <div class="mut">–î–∞—Ç–∞</div>
            <input id="dt" readonly>
          </div>
          <div><button class="btn" id="btnToday">–°–µ–≥–æ–¥–Ω—è</button></div>
        </div>

        <div class="row wrap mt-12">
          <div class="grow">
            <div class="mut">–ß–∞—Å—ã</div>
            <input id="hours" inputmode="decimal" placeholder="–Ω–∞–ø—Ä., 3.5">
          </div>
          <div><button class="btn primary" id="btnAdd">–î–æ–±–∞–≤–∏—Ç—å</button></div>
        </div>

        <div class="section-title mt-12">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏:</div>
        <div class="quick" id="quick">
          <button class="btn" data-qk="hrs-3.5">3.5 —á</button>
          <button class="btn" data-qk="hrs-8">8 —á</button>
          <button class="btn" data-qk="leave-hours">–û—Ç–≥—É–ª</button>
          <button class="btn" data-qk="vacation">–û—Ç–ø—É—Å–∫</button>
        </div>
      </div>

      <div class="card">
        <div class="cal-head">
          <button class="btn" id="prevM">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
          <div class="cal-title" id="cal-title"></div>
          <button class="btn" id="nextM">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
        </div>
        <div class="cal-dow" id="cal-dow"></div>
        <div class="cal-grid" id="cal-grid"></div>
        <div class="legend">
          <span>üõ†Ô∏è ‚Äî –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞</span>
          <span>‚õî ‚Äî –æ—Ç–≥—É–ª</span>
          <span>üèñÔ∏è ‚Äî –æ—Ç–ø—É—Å–∫</span>
          <span>üéâ ‚Äî –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π</span>
        </div>
      </div>

      <div class="card">
        <div id="day-list"></div>
        <div class="totals" id="totals"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="tabpage" hidden>
      <div class="card">
        <div class="row wrap">
          <div class="grow">
            <div class="mut">–û–∫–ª–∞–¥, ‚ÇΩ (–Ω–∞ —Ä—É–∫–∏)</div>
            <input id="salary" inputmode="numeric">
          </div>
          <div class="grow">
            <div class="mut">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –≤ –º–µ—Å. (–ü–Ω‚Äì–ü—Ç)</div>
            <input id="workdays" inputmode="numeric">
          </div>
          <div class="grow">
            <div class="mut">–ß–∞—Å–æ–≤ –≤ –¥–µ–Ω—å</div>
            <input id="hoursPerDay" inputmode="numeric">
          </div>
        </div>
        <div class="row mtt">
          <div class="grow">
            <div class="mut">–°—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π (–¥–ª—è –æ—Ç–ø—É—Å–∫–∞), ‚ÇΩ ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</div>
            <input id="avgDaily" inputmode="decimal" placeholder="–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–æ–º –∑–∞ 12 –º–µ—Å.">
          </div>
        </div>
        <div class="section-title mt-12">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ–¥—Ä–∞–±–æ—Ç–æ–∫</div>
        <div class="row wrap">
          <div class="grow"><div class="mut">–ë—É–¥–Ω–∏ (–ø–µ—Ä–≤—ã–µ 2 —á)</div><input id="rateWdFirst2" inputmode="decimal"></div>
          <div class="grow"><div class="mut">–ë—É–¥–Ω–∏ (–¥–∞–ª—å—à–µ)</div><input id="rateWdNext" inputmode="decimal"></div>
          <div class="grow"><div class="mut">–°—É–±–±–æ—Ç–∞</div><input id="rateSat" inputmode="decimal"></div>
          <div class="grow"><div class="mut">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</div><input id="rateSun" inputmode="decimal"></div>
          <div class="grow"><div class="mut">–ü—Ä–∞–∑–¥–Ω–∏–∫</div><input id="rateHol" inputmode="decimal"></div>
        </div>
        <div class="row mt-12">
          <button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
      </div>
    </section>

    <!-- HOLIDAYS -->
    <section id="holidays" class="tabpage" hidden>
      <div class="card">
        <div class="mut">–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ –∫–ª–∏–∫–æ–º (—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ –º–µ—Å—è—Ü–∞–º).</div>
        <div class="cal-head">
          <button class="btn" id="hPrev">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
          <div class="cal-title" id="h-title"></div>
          <button class="btn" id="hNext">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
        </div>
        <div class="cal-dow" id="h-dow"></div>
        <div class="cal-grid" id="h-grid"></div>
      </div>
    </section>

    <!-- IMPORT -->
    <section id="import" class="tabpage" hidden>
      <div class="card">
        <div class="row wrap">
          <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
          <input id="file" type="file" accept="application/json" class="mtt">
          <button class="btn" id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
        </div>
        <div class="mut mtt">–≠–∫—Å–ø–æ—Ä—Ç –≤–∫–ª—é—á–∞–µ—Ç –∑–∞–ø–∏—Å–∏, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</div>
      </div>
    </section>
  </div>

<script>
/* ================== STATE & STORAGE ================== */
function ymd(d){return d.toISOString().slice(0,10)}
function pad2(n){return String(n).padStart(2,'0')}
function ymStr(y,m){return y+'-'+pad2(m+1)}
function makeId(){return Math.random().toString(36).slice(2,9)+Date.now().toString(36)}

const LS_KEYS={entries:'entries',holidays:'holidays',settings:'settings'}
function loadJSON(key, fallback){try{return JSON.parse(localStorage.getItem(key)||fallback)}catch(_){return JSON.parse(fallback)}}
function saveJSON(key, val){localStorage.setItem(key, JSON.stringify(val))}

/* settings */
const defaultSettings={
  salary:97000, workdays:22, hoursPerDay:8, avgDaily:null,
  rateWdFirst2:1.5, rateWdNext:2, rateSat:1.5, rateSun:2, rateHol:2
};
const settings = Object.assign({}, defaultSettings, loadJSON(LS_KEYS.settings,'{}'));

/* entries & holidays */
function loadEntries(){return loadJSON(LS_KEYS.entries,'[]')}
function saveEntries(a){saveJSON(LS_KEYS.entries,a)}
const holidaysMap = loadJSON(LS_KEYS.holidays,'{}');

/* selected date / month */
const today = new Date();
const state = {
  year: today.getFullYear(),
  month: today.getMonth(),
  get ym(){return ymStr(this.year,this.month)},
  selectedDate: ymd(today)
};

/* ================== TABS ================== */
const tabBtns=[...document.querySelectorAll('.tab')];
const tabPages=[...document.querySelectorAll('.tabpage')];
tabBtns.forEach(b=>b.onclick=()=>{
  tabBtns.forEach(x=>x.classList.remove('active'));
  tabPages.forEach(s=>s.hidden=true);
  b.classList.add('active');
  document.getElementById(b.dataset.tab).hidden=false;
  if(b.dataset.tab==='holidays') renderHolidaysCalendar(hYear,hMonth);
});

/* ================== SETTINGS UI ================== */
function refreshSettingsUI(){
  document.getElementById('salary').value = settings.salary;
  document.getElementById('workdays').value = settings.workdays;
  document.getElementById('hoursPerDay').value = settings.hoursPerDay;
  document.getElementById('avgDaily').value = settings.avgDaily==null?'':settings.avgDaily;
  document.getElementById('rateWdFirst2').value = settings.rateWdFirst2;
  document.getElementById('rateWdNext').value = settings.rateWdNext;
  document.getElementById('rateSat').value = settings.rateSat;
  document.getElementById('rateSun').value = settings.rateSun;
  document.getElementById('rateHol').value = settings.rateHol;
}
refreshSettingsUI();

document.getElementById('saveSettings').onclick=()=>{
  settings.salary = +document.getElementById('salary').value || 0;
  settings.workdays = +document.getElementById('workdays').value || 0;
  settings.hoursPerDay = +document.getElementById('hoursPerDay').value || 0;
  var a = document.getElementById('avgDaily').value;
  a = (a||'').trim();
  settings.avgDaily = a===''? null : (+a.replace(',','.')||null);
  settings.rateWdFirst2 = +document.getElementById('rateWdFirst2').value || 1.5;
  settings.rateWdNext   = +document.getElementById('rateWdNext').value   || 2;
  settings.rateSat      = +document.getElementById('rateSat').value      || 1.5;
  settings.rateSun      = +document.getElementById('rateSun').value      || 2;
  settings.rateHol      = +document.getElementById('rateHol').value      || 2;
  saveJSON(LS_KEYS.settings, settings);
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  renderDayDetails(state.selectedDate);
};

/* ================== JOURNAL INPUTS ================== */
function setTodayUi(){
  document.getElementById('dt').value = new Date(state.selectedDate)
    .toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
}
document.getElementById('btnToday').onclick=()=>{
  const t=new Date();
  state.year=t.getFullYear(); state.month=t.getMonth(); state.selectedDate=ymd(t);
  setTodayUi(); renderCalendar(state.year,state.month); renderDayDetails(state.selectedDate);
};

document.getElementById('btnAdd').onclick=()=>{
  var raw=document.getElementById('hours').value||'';
  const h = Number(raw.replace(',','.'))||0;
  if(h<=0) return;
  addOrUpdateWork(state.selectedDate,h);
  document.getElementById('hours').value='';
  renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month);
};
document.getElementById('quick').onclick=function(ev){
  const b=ev.target.closest('button[data-qk]'); if(!b) return;
  const code=b.dataset.qk;
  if(code==='hrs-3.5') addOrUpdateWork(state.selectedDate,3.5);
  if(code==='hrs-8') addOrUpdateWork(state.selectedDate,8);
  if(code==='leave-hours'){
    const r = prompt('–û—Ç–≥—É–ª (—á–∞—Å—ã):','0.5');
    const n = Number((r||'').replace(',','.'))||0;
    if(n>0) addOffHours(state.selectedDate,n);
  }
  if(code==='vacation') toggleVacation(state.selectedDate);
  renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month);
};

/* ================== ENTRIES OPS ================== */
function addOrUpdateWork(dateISO,hours){
  const list=loadEntries();
  const i=list.findIndex(e=>e.date===dateISO && e.kind==='work');
  const rec={ id: i>-1?list[i].id:makeId(), date:dateISO, kind:'work', hours:+hours||0 };
  if(i>-1) list[i]=rec; else list.push(rec);
  saveEntries(list);
}
function addOffHours(dateISO,hours){
  const list=loadEntries();
  list.push({ id:makeId(), date:dateISO, kind:'offHours', hours:+hours||0 });
  saveEntries(list);
}
function toggleVacation(dateISO){
  const list=loadEntries();
  const i=list.findIndex(e=>e.date===dateISO && e.kind==='vacation');
  if(i>-1) list.splice(i,1);
  else list.push({ id:makeId(), date:dateISO, kind:'vacation', hours:0 });
  saveEntries(list);
}
function deleteEntryById(id){
  const list=loadEntries();
  const i=list.findIndex(e=>e.id===id);
  if(i>-1){ list.splice(i,1); saveEntries(list); }
}

/* ================== CALENDAR (journal) ================== */
function daysInMonth(y,m){return new Date(y,m+1,0).getDate()}
function renderCalendar(y,m){
  document.getElementById('cal-title').textContent =
    new Date(y,m,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
  document.getElementById('cal-dow').innerHTML =
    ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(function(d){return '<span>'+d+'</span>'}).join('');
  const grid=document.getElementById('cal-grid'); grid.innerHTML='';
  const first=new Date(y,m,1);
  const startCol=(first.getDay()+6)%7; // –ü–Ω=0
  const n=daysInMonth(y,m);
  const entries=loadEntries();
  const hol = holidaysMap[ymStr(y,m)] || [];

  for(let i=0;i<startCol;i++){
    const d=document.createElement('div'); d.className='cal-day'; d.style.visibility='hidden'; grid.appendChild(d);
  }
  for(let day=1; day<=n; day++){
    const dateISO=y+'-'+pad2(m+1)+'-'+pad2(day);
    const hasWork=entries.some(e=>e.date===dateISO && e.kind==='work');
    const hasOff =entries.some(e=>e.date===dateISO && e.kind==='offHours');
    const hasVac =entries.some(e=>e.date===dateISO && e.kind==='vacation');
    const isHol  =hol.indexOf(day)>-1;
    const badge=(hasWork?'üõ†Ô∏è':'')+(hasOff?' ‚õî':'')+(hasVac?' üèñÔ∏è':'')+(isHol?' üéâ':'');

    const btn=document.createElement('button');
    btn.className='cal-day';
    if(dateISO===state.selectedDate) btn.classList.add('selected');
    btn.innerHTML='<span class="num">'+day+'</span><div class="badge">'+badge+'</div>';
    btn.onclick=function(){ state.selectedDate=dateISO; setTodayUi(); renderCalendar(y,m); renderDayDetails(dateISO); };
    grid.appendChild(btn);
  }
}
document.getElementById('prevM').onclick=function(){ state.month--; if(state.month<0){state.month=11;state.year--} renderCalendar(state.year,state.month) }
document.getElementById('nextM').onclick=function(){ state.month++; if(state.month>11){state.month=0;state.year++} renderCalendar(state.year,state.month) }

/* ================== HOLIDAYS PAGE ================== */
let hYear=state.year, hMonth=state.month;
function renderHolidaysCalendar(y,m){
  document.getElementById('h-title').textContent =
    new Date(y,m,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
  document.getElementById('h-dow').innerHTML =
    ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(function(d){return '<span>'+d+'</span>'}).join('');
  const grid=document.getElementById('h-grid'); grid.innerHTML='';
  const first=new Date(y,m,1);
  const startCol=(first.getDay()+6)%7, n=daysInMonth(y,m);
  const key = ymStr(y,m);
  const arr = (holidaysMap[key] || []).slice();

  for(let i=0;i<startCol;i++){ const d=document.createElement('div'); d.className='cal-day'; d.style.visibility='hidden'; grid.appendChild(d); }
  for(let day=1; day<=n; day++){
    const btn=document.createElement('button'); btn.className='cal-day';
    const isHol=arr.indexOf(day)>-1;
    btn.innerHTML='<span class="num">'+day+'</span><div class="badge">'+(isHol?'üéâ':'')+'</div>';
    btn.onclick=function(){
      const list=holidaysMap[key]||[];
      const i=list.indexOf(day);
      if(i>-1) list.splice(i,1); else list.push(day);
      holidaysMap[key]=list.sort(function(a,b){return a-b});
      saveJSON(LS_KEYS.holidays, holidaysMap);
      renderHolidaysCalendar(y,m);
      if(y===state.year && m===state.month) renderCalendar(state.year,state.month);
    };
    grid.appendChild(btn);
  }
}
document.getElementById('hPrev').onclick=function(){ hMonth--; if(hMonth<0){hMonth=11;hYear--} renderHolidaysCalendar(hYear,hMonth) }
document.getElementById('hNext').onclick=function(){ hMonth++; if(hMonth>11){hMonth=0;hYear++} renderHolidaysCalendar(hYear,hMonth) }

/* ================== CALC HELPERS ================== */
function currentHourRate(){
  const wd=Math.max(1, +settings.workdays||1);
  const hpd=Math.max(1, +settings.hoursPerDay||1);
  const sal= +settings.salary||0;
  return wd*hpd>0 ? sal/(wd*hpd) : 0;
}
function isHoliday(dateISO){
  const d=new Date(dateISO);
  const key=ymStr(d.getFullYear(), d.getMonth());
  const arr = holidaysMap[key]||[];
  return arr.indexOf(d.getDate())>-1;
}
function isWeekday(dateISO){
  const day = new Date(dateISO).getDay(); // 0=Sun..6=Sat
  return day>=1 && day<=5;
}
function isSaturday(dateISO){ return new Date(dateISO).getDay()===6 }
function isSunday(dateISO){ return new Date(dateISO).getDay()===0 }

/* –æ–ø–ª–∞—Ç–∞ –ø–æ–¥—Ä–∞–±–æ—Ç–æ–∫ —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏ */
function calcOvertimePay(dateISO,hours,baseRate){
  if(hours<=0) return 0;
  if(isHoliday(dateISO)) return hours*baseRate*settings.rateHol;
  if(isSaturday(dateISO)) return hours*baseRate*settings.rateSat;
  if(isSunday(dateISO))   return hours*baseRate*settings.rateSun;
  const first = Math.min(hours,2)*settings.rateWdFirst2;
  const rest  = Math.max(0,hours-2)*settings.rateWdNext;
  return baseRate*(first+rest);
}

/* –≤—ã—á–∏—Ç–∞–Ω–∏–µ –æ—Ç–≥—É–ª–∞ */
function calcOffPenalty(dateISO,hours,baseRate){
  if(hours<=0) return 0;
  if(!isHoliday(dateISO) && isWeekday(dateISO)) return hours*baseRate;
  return 0;
}

/* –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –º–µ—Å—è—Ü–∞: –æ–∫–ª–∞–¥ + –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏ (–¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ) */
function monthAccruals(y,m){
  const ym = ymStr(y,m);
  const list = loadEntries().filter(function(e){return e.date.slice(0,7)===ym});
  const baseRate = currentHourRate();
  var pay = +settings.salary || 0;
  list.forEach(function(e){
    if(e.kind==='work') pay += calcOvertimePay(e.date, +e.hours||0, baseRate);
  });
  return pay;
}

/* —Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π: –∑–∞ 12 –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Å—è—Ü–µ–≤; –ø—É—Å—Ç—ã–µ ‚Äî –æ–∫–ª–∞–¥ */
function autoAverageDaily(){
  const anchor = new Date(state.year, state.month, 1);
  var sum = 0;
  for(var i=1;i<=12;i++){
    const d=new Date(anchor); d.setMonth(anchor.getMonth()-i);
    sum += monthAccruals(d.getFullYear(), d.getMonth());
  }
  return sum/(29.3*12);
}
function avgDaily(){
  if(settings.avgDaily!=null) return +settings.avgDaily||0;
  return autoAverageDaily();
}

/* –∏—Ç–æ–≥–∏ –ø–æ –º–µ—Å—è—Ü—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã */
function calcTotals(dateISO){
  const ym=dateISO.slice(0,7);
  const list=loadEntries().filter(function(e){return e.date.slice(0,7)===ym});
  const baseRate=currentHourRate();
  var workH=0, offH=0, vacD=0, otPay=0, offPenalty=0;

  list.forEach(function(e){
    if(e.kind==='work'){
      const h=+e.hours||0;
      workH+=h;
      otPay+=calcOvertimePay(e.date, h, baseRate);
    }else if(e.kind==='offHours'){
      const h=+e.hours||0;
      offH+=h;
      offPenalty+=calcOffPenalty(e.date, h, baseRate);
    }else if(e.kind==='vacation'){
      vacD++;
    }
  });

  const leavePay = vacD*avgDaily();
  const base = +settings.salary||0;
  const total = Math.max(0, base + otPay + leavePay - offPenalty);

  return {workH, offH, vacD, rate:baseRate, otPay, offPenalty, leavePay, base, total};
}

/* ================== DAY LIST & TOTALS RENDER ================== */
function bindDeleteButtons(){
  var nodes=document.querySelectorAll('[data-del-id]');
  for(var i=0;i<nodes.length;i++){
    nodes[i].onclick=function(){ deleteEntryById(this.dataset.delId); renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month); };
  }
}
function renderDayDetails(dateISO){
  const box=document.getElementById('day-list');
  const list=loadEntries().filter(function(e){return e.date===dateISO});
  const label=new Date(dateISO).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  var html='<h3 style="margin:6px 0 10px">'+label+'</h3>';
  if(list.length===0){
    html+='<div class="mut">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</div>';
  }else{
    html+=list.map(function(e){
      const icon = e.kind==='work'?'üõ†Ô∏è':(e.kind==='offHours'?'‚õî':'üèñÔ∏è');
      const title= e.kind==='work'?'–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞':(e.kind==='offHours'?'–û—Ç–≥—É–ª':'–û—Ç–ø—É—Å–∫');
      const hrs  = e.kind==='vacation'?'‚Äî':(+e.hours||0).toFixed(2);
      return '<div class="rowline">'+
        '<div><span class="pill">'+icon+'</span> '+title+'</div>'+
        '<div style="text-align:right">'+hrs+'</div>'+
        '<div></div>'+
        '<div style="text-align:right"><button class="btn danger" data-del-id="'+e.id+'">–£–¥–∞–ª–∏—Ç—å</button></div>'+
      '</div>';
    }).join('');
  }
  box.innerHTML=html;
  bindDeleteButtons();

  const t=calcTotals(dateISO);
  document.getElementById('totals').innerHTML =
    '<span class="pill">–ë–∞–∑–∞: '+t.base.toLocaleString('ru-RU')+' ‚ÇΩ</span>'+
    '<span class="pill">–ü–æ—á–∞—Å–æ–≤–∞—è: '+t.rate.toFixed(0)+' ‚ÇΩ/—á</span>'+
    '<span class="pill">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏: '+t.otPay.toLocaleString('ru-RU')+' ‚ÇΩ (—á–∞—Å—ã: '+t.workH.toFixed(2)+')</span>'+
    '<span class="pill">–û—Ç–≥—É–ª: ‚àí'+t.offPenalty.toLocaleString('ru-RU')+' ‚ÇΩ (—á–∞—Å—ã: '+t.offH.toFixed(2)+')</span>'+
    '<span class="pill">–û—Ç–ø—É—Å–∫: '+t.leavePay.toLocaleString('ru-RU')+' ‚ÇΩ (–¥–Ω.: '+t.vacD+')</span>'+
    '<span class="pill" style="font-weight:700">–ò—Ç–æ–≥–æ: '+t.total.toLocaleString('ru-RU')+' ‚ÇΩ</span>';
}

/* ================== IMPORT / EXPORT ================== */
document.getElementById('btnExport').onclick=function(){
  const payload={ entries:loadEntries(), holidays:holidaysMap, settings };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paycalc_data.json'; a.click();
  URL.revokeObjectURL(a.href);
};
document.getElementById('btnImport').onclick=function(){
  var files=document.getElementById('file').files;
  var f = files && files[0];
  if(!f) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª JSON');
  const r=new FileReader();
  r.onload=function(){
    try{
      const data=JSON.parse(r.result);
      saveEntries(Array.isArray(data.entries)?data.entries:[]);
      if(data.holidays && typeof data.holidays==='object') saveJSON(LS_KEYS.holidays, data.holidays);
      if(data.settings && typeof data.settings==='object'){
        const merged = Object.assign({}, defaultSettings, data.settings);
        saveJSON(LS_KEYS.settings, merged);
        Object.assign(settings, merged);
        refreshSettingsUI();
      }
      alert('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
      renderCalendar(state.year,state.month); renderDayDetails(state.selectedDate);
    }catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e.message) }
  };
  r.readAsText(f);
};

/* ================== INIT ================== */
setTodayUi();
renderCalendar(state.year,state.month);
let hYear=state.year, hMonth=state.month;
renderHolidaysCalendar(hYear,hMonth);
renderDayDetails(state.selectedDate);
</script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker
      .register('./sw.js?v=2025-09-05-2')   // ‚Üê –º–µ–Ω—è–π —Ö–≤–æ—Å—Ç –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ
      .then(reg => reg.update())
      .catch(console.error);
  }
</script>
</body>
</html>
