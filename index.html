<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞ ‚Äî PWA</title>

  <!-- –í–∞–∂–Ω–æ –¥–ª—è GitHub Pages –≤ –ø–æ–¥-–ø–∞–ø–∫–µ -->
  <base href="./">

  <!-- PWA -->
  <meta name="theme-color" content="#0b0d12"/>
  <link rel="manifest" href="./manifest.webmanifest" crossorigin="use-credentials"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
  <meta name="apple-mobile-web-app-title" content="–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏"/>
  <link rel="apple-touch-icon" href="./icons/icon-192.png"/>
  <link rel="icon" href="./icons/icon-192.png"/>

  <style>
    :root{
      --bg:#0e1117; --surface:#141922; --surface-2:#1a2030; --line:#263043;
      --text:#e8eef7; --muted:#9aa6b2; --accent:#4e8cff;
      --ok:#1eb980; --warn:#ffb020; --danger:#ff6b6b; --chip:#20283a;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{margin:0;font-size:20px}
    .seg{display:flex;gap:10px;flex-wrap:wrap}
    .seg button{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--surface-2);color:var(--text);cursor:pointer}
    .seg .active{outline:2px solid var(--accent)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--surface-2);color:var(--text);cursor:pointer}
    .btn-ok{background:#13261f;border-color:#1f4c38}
    .btn-warn{background:#2b2312;border-color:#4a3a16}
    .btn-danger{background:#2a1416;border-color:#5a1f1f}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);padding:12px}

    /* –§–æ—Ä–º—ã */
    label{display:flex;flex-direction:column;gap:6px;font-size:13px}
    input,select{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--surface-2);color:var(--text)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px}
    .muted{color:var(--muted)}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}

    /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–∑ —Å–∫—Ä–∏–Ω–∞ */
    .monthNav{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin:6px 0}
    .monthNav .prev{justify-self:start}
    .monthNav .title{justify-self:center;font-weight:600}
    .monthNav .next{justify-self:end}
    .calendar{display:grid;gap:8px;background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);padding:10px}
    .calendar .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:6px}
    .calendar .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cell{position:relative;min-height:70px;border:1px solid var(--line);border-radius:18px;background:var(--surface-2);padding:8px;display:flex;flex-direction:column;justify-content:space-between}
    .cell .num{font-size:12px;color:var(--muted)}
    .cell .ico{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .cell.selected{outline:3px solid var(--accent)}
    .center{display:flex;justify-content:center;align-items:center}
    .chips{display:flex;flex-wrap:wrap;gap:6px}

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–Ω—è –∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ */
    .dayPanel .head{font-weight:700;font-size:18px;margin-bottom:8px}
    .tokens{display:flex;flex-wrap:wrap;gap:8px}
    .token{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:8px 12px}

    @media (max-width:900px){ .wrap{padding:10px} }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</h1>
    <div class="toolbar">
      <button id="btnToday" class="btn">–°–µ–≥–æ–¥–Ω—è</button>
      <button id="btnInstall" class="btn" style="display:none">‚¨áÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button id="btnUpdate" class="btn btn-warn" title="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –æ–±–Ω–æ–≤–∏—Ç—å">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </header>

  <!-- –°–µ–≥–º–µ–Ω—Ç—ã -->
  <div class="seg">
    <button class="segbtn active" data-tab="journal">–ñ—É—Ä–Ω–∞–ª</button>
    <button class="segbtn" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="segbtn" data-tab="holidays">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
    <button class="segbtn" data-tab="export">–≠–∫—Å–ø–æ—Ä—Ç</button>
  </div>

  <!-- ===== –ñ–£–†–ù–ê–õ ===== -->
  <section id="tab-journal" class="tab-pane" style="margin-top:10px">
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–≤–æ–¥–∞ (–∫–∞–∫ –Ω–∞ 2-–º —Å–∫—Ä–∏–Ω–µ) -->
    <div class="card" style="margin-bottom:10px">
      <div class="row">
        <label>–î–∞—Ç–∞ –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏
          <input id="dateInput" type="date"/>
        </label>
        <button id="btnDateToday" class="btn">–°–µ–≥–æ–¥–Ω—è</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label>–¢–∏–ø
          <select id="otType">
            <option value="auto">(–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</option>
            <option value="weekday">–ë—É–¥–Ω–∏</option>
            <option value="sat">–°—É–±–±–æ—Ç–∞</option>
            <option value="sun">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
            <option value="holiday">–ü—Ä–∞–∑–¥–Ω–∏–∫</option>
          </select>
        </label>
        <label>–ß–∞—Å—ã
          <input id="otHours" type="number" min="0.5" step="0.5" placeholder="–Ω–∞–ø—Ä., 3.5"/>
        </label>
        <button id="btnAddOver" class="btn btn-ok">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="muted">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏:</div>
        <button class="btn" data-q="3.5" data-t="weekday">–ë—É–¥–Ω–∏ 3.5 —á</button>
        <button class="btn" data-q="8" data-t="sat">–°—É–±–±–æ—Ç–∞ 8 —á</button>
        <button class="btn" data-q="8" data-t="sun">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 8 —á</button>
        <button class="btn" data-q="8" data-t="holiday">–ü—Ä–∞–∑–¥–Ω–∏–∫ 8 —á</button>
      </div>
    </div>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <div class="calendar">
      <div class="monthNav">
        <button class="btn" id="btnPrev">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
        <div class="title" id="monthTitle">‚Äî</div>
        <button class="btn" id="btnNext">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
      </div>
      <div class="dow muted"><div class="center">–ü–Ω</div><div class="center">–í—Ç</div><div class="center">–°—Ä</div><div class="center">–ß—Ç</div><div class="center">–ü—Ç</div><div class="center">–°–±</div><div class="center">–í—Å</div></div>
      <div class="grid" id="calendarGrid"></div>
      <div class="muted" style="margin-top:6px">üõ† ‚Äî –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞; ‚õî ‚Äî –æ—Ç–≥—É–ª (—á–∞—Å—ã); üèñÔ∏è ‚Äî –æ—Ç–ø—É—Å–∫; üéâ ‚Äî –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π.</div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è (–∫–∞–∫ –Ω–∞ 1-–º —Å–∫—Ä–∏–Ω–µ) -->
    <div class="card dayPanel" style="margin-top:10px">
      <div class="head" id="dayHead">‚Äî</div>
      <div class="row">
        <div class="pill">üõ† –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞: <b id="curOver">0</b> —á</div>
        <div class="pill">‚õî –û—Ç–≥—É–ª: <b id="curOtgul">0</b> —á</div>
        <div class="pill">üèñÔ∏è –û—Ç–ø—É—Å–∫: <b id="curVac">–Ω–µ—Ç</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnOverDel" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É</button>
        <button id="btnVacToggle" class="btn">üèñÔ∏è –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ—Ç–ø—É—Å–∫</button>
        <button id="btnOtgulAdd" class="btn">+ –û—Ç–≥—É–ª 2 —á</button>
        <button id="btnOtgulRemove" class="btn btn-danger">‚Äì –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≥—É–ª</button>
        <button id="btnHolidayToggle" class="btn btn-warn">üéâ –ü—Ä–∞–∑–¥–Ω–∏–∫</button>
      </div>
      <hr/>
      <div class="tokens" id="sumTokens"></div>
      <div class="pill" style="margin-top:10px;font-size:18px"><b>–ò—Ç–æ–≥–æ: <span id="totalSum">0 ‚ÇΩ</span></b></div>
    </div>
  </section>

  <!-- ===== –ù–ê–°–¢–†–û–ô–ö–ò ===== -->
  <section id="tab-settings" class="tab-pane" style="display:none;margin-top:10px">
    <div class="card">
      <div class="row">
        <label>–û–∫–ª–∞–¥ (–Ω–∞ —Ä—É–∫–∏), ‚ÇΩ
          <input id="salary" type="number" min="0" step="1000"/>
        </label>
        <label>–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
          <input id="workDays" type="number" min="0" max="31"/>
        </label>
        <label>–ß–∞—Å—ã –≤ –¥–µ–Ω—å
          <input id="hoursPerDay" type="number" min="1" max="24" step="0.5"/>
        </label>
        <label>–°—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          <input id="avgDailyManual" type="number" min="0" step="1" placeholder="–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∞–≤—Ç–æ"/>
        </label>
        <button id="saveSettings" class="btn btn-ok">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <hr/>
      <div class="row">
        <div class="muted">–ê–≤—Ç–æ-—Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å):</div>
        <div class="pill" id="avgDailyAutoView">‚Äî</div>
        <button id="historyAddCurrent" class="btn btn-ok">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –æ–∫–ª–∞–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é</button>
        <button id="historyClear" class="btn btn-danger">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
      </div>
    </div>
  </section>

  <!-- ===== –ü–†–ê–ó–î–ù–ò–ö–ò ===== -->
  <section id="tab-holidays" class="tab-pane" style="display:none;margin-top:10px">
    <div class="card">
      <h3 style="margin:0 0 8px 0">–°–≤–æ–∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏</h3>
      <div id="holGrid" class="chips"></div>
      <div class="muted" style="margin-top:8px">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å –¥–∞—Ç–æ–π, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å.</div>
    </div>
  </section>

  <!-- ===== –≠–ö–°–ü–û–†–¢ ===== -->
  <section id="tab-export" class="tab-pane" style="display:none;margin-top:10px">
    <div class="card">
      <div class="row">
        <button id="btnExportJson" class="btn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <label class="row" style="align-items:center">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç JSON
          <input id="importJson" type="file" accept="application/json"/>
        </label>
        <button id="btnResetMonth" class="btn btn-danger">üóëÔ∏è –°–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞</button>
      </div>
      <div class="muted" style="margin-top:8px">–ò–º–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞.</div>
    </div>
  </section>
</div>

<script>
/* ==== –î–ê–¢–´/–£–¢–ò–õ–´ ==== */
const MONTHS = ["—è–Ω–≤–∞—Ä—å","—Ñ–µ–≤—Ä–∞–ª—å","–º–∞—Ä—Ç","–∞–ø—Ä–µ–ª—å","–º–∞–π","–∏—é–Ω—å","–∏—é–ª—å","–∞–≤–≥—É—Å—Ç","—Å–µ–Ω—Ç—è–±—Ä—å","–æ–∫—Ç—è–±—Ä—å","–Ω–æ—è–±—Ä—å","–¥–µ–∫–∞–±—Ä—å"];
const DOW = ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"];
const pad2 = n => (n<10?`0${n}`:String(n));
const ymd = (y,m0,d)=>`${y}-${pad2(m0+1)}-${pad2(d)}`;
const parseYmd = s => { const [y,m,d]=s.split("-").map(Number); return {y, m0:m-1, d}; };
const daysInMonth=(y,m0)=>new Date(y,m0+1,0).getDate();
const firstWeekday=(y,m0)=>(new Date(y,m0,1).getDay()+6)%7; // 0..6 Mon..Sun
const isWeekend=(y,m0,d)=>{ const js=new Date(y,m0,d).getDay(); return js===0||js===6; };
const fmtRub = n => new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:2}).format(n);

/* ==== –•–†–ê–ù–ò–õ–ò–©–ï ==== */
const KEY="podrabotki.v2"; const KEY_HIST="podrabotki.history";
function loadMonth(y,m0){
  const raw=localStorage.getItem(KEY);
  if(raw){ try{ const obj=JSON.parse(raw); if(obj.year===y&&obj.month===m0) return obj; }catch{} }
  const dim=daysInMonth(y,m0); const days={};
  for(let d=1; d<=dim; d++){ const date=ymd(y,m0,d); days[date]={date,overtimeHours:0,otguls:[],vacation:false}; }
  let wd=0; for(let d=1; d<=dim; d++){const js=new Date(y,m0,d).getDay(); if(js>=1&&js<=5) wd++;}
  return {year:y,month:m0,baseSalary:0,workingDays:wd,hoursPerDay:8,avgDailyManual:null,holidays:[],days};
}
const saveMonth=(md)=>localStorage.setItem(KEY,JSON.stringify(md));
const loadHistory=()=>{ try{return JSON.parse(localStorage.getItem(KEY_HIST)||"{}");}catch{return{}}; };
const saveHistory=(h)=>localStorage.setItem(KEY_HIST,JSON.stringify(h));

/* ==== –°–û–°–¢–û–Ø–ù–ò–ï ==== */
const now=new Date();
let state={ data: loadMonth(now.getFullYear(), now.getMonth()), history: loadHistory(), selected: null };

/* ==== –†–ê–°–ß–Å–¢–´ ==== */
const hourlyRate=(md)=> {
  const denom=md.workingDays>0 && md.hoursPerDay>0 ? md.workingDays*md.hoursPerDay : 0;
  return denom>0 ? md.baseSalary/denom : 0;
};
function compute(md){
  const rate=hourlyRate(md);
  const denomH=md.workingDays*md.hoursPerDay;
  let baseHours=0, overH=0, vacDays=0;
  for(const d of Object.values(md.days)){
    const {y,m0,d:dd}=parseYmd(d.date);
    if(!isWeekend(y,m0,dd) && !d.vacation){
      const minus = (d.otguls||[]).reduce((a,b)=>a+b,0);
      baseHours += Math.max(0, md.hoursPerDay - minus);
    }
    overH += d.overtimeHours||0;
    if(d.vacation) vacDays++;
  }
  const basePart = denomH>0 ? (baseHours/denomH)*md.baseSalary : 0;
  const overPay = overH*rate;

  // —Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π
  const hist=loadHistory(); const keys=Object.keys(hist).sort().slice(-12);
  let avgAuto = (md.baseSalary||0)/29.3;
  if(keys.length){ const sum=keys.reduce((a,k)=>a+(+hist[k]||0),0); avgAuto = sum/(12*29.3); }
  const avgDaily = (md.avgDailyManual && md.avgDailyManual>0) ? md.avgDailyManual : avgAuto;
  const vacPay = vacDays*avgDaily;

  return {rate,baseHours,basePart,overH,overPay,vacDays,avgDaily,avgAuto,total:basePart+overPay+vacPay};
}

/* ==== –≠–õ–ï–ú–ï–ù–¢–´ ==== */
const $=s=>document.querySelector(s);
const monthTitle=$("#monthTitle");
const grid=$("#calendarGrid");
const dateInput=$("#dateInput");
const btnDateToday=$("#btnDateToday");
const btnPrev=$("#btnPrev"), btnNext=$("#btnNext"), btnToday=$("#btnToday");
const curOver=$("#curOver"), curOtgul=$("#curOtgul"), curVac=$("#curVac"), dayHead=$("#dayHead");
const btnOverDel=$("#btnOverDel"), btnVacToggle=$("#btnVacToggle"), btnOtgulAdd=$("#btnOtgulAdd"), btnOtgulRemove=$("#btnOtgulRemove"), btnHolidayToggle=$("#btnHolidayToggle");
const sumTokens=$("#sumTokens"), totalSum=$("#totalSum");
const salary=$("#salary"), workDays=$("#workDays"), hoursPerDay=$("#hoursPerDay"), avgDailyManual=$("#avgDailyManual"), saveSettings=$("#saveSettings");
const avgDailyAutoView=$("#avgDailyAutoView"); const holGrid=$("#holGrid");
const importJson=$("#importJson");

/* ==== UI ==== */
function setTab(id){
  document.querySelectorAll(".segbtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===id));
  document.querySelectorAll(".tab-pane").forEach(p=>p.style.display = (p.id===`tab-${id}`) ? "" : "none");
}
document.querySelectorAll(".segbtn").forEach(b=>b.addEventListener("click",()=>setTab(b.dataset.tab)));

function initUI(){
  updateMonthHeader();
  renderCalendar();
  bindSettings();
  renderDayPanel();
  renderHolidaysTab();
  renderTotals();
  syncDateInputToSelected();
  renderAvgDailyAuto();
}
function updateMonthHeader(){
  monthTitle.textContent = `${MONTHS[state.data.month]} ${state.data.year} –≥.`;
}
function syncDateInputToSelected(){
  if(state.selected) dateInput.value = state.selected;
  else dateInput.value = ymd(state.data.year, state.data.month, 1);
}
function renderCalendar(){
  const {year,month} = state.data;
  const dim=daysInMonth(year,month), lead=firstWeekday(year,month);
  const cells=[];
  for(let i=0;i<lead;i++) cells.push(`<div></div>`);
  for(let d=1; d<=dim; d++){
    const date=ymd(year,month,d); const dd=state.data.days[date];
    const badges=[];
    if(dd?.overtimeHours>0) badges.push("üõ†");
    const otg=(dd?.otguls||[]).reduce((a,b)=>a+b,0); if(otg>0) badges.push("‚õî");
    if(dd?.vacation) badges.push("üèñÔ∏è");
    if(state.data.holidays.includes(date)) badges.push("üéâ");
    const sel = state.selected===date ? " selected":"";
    cells.push(`<div class="cell${sel}" data-date="${date}">
      <div class="num">${d}</div>
      <div class="ico">${badges.map(x=>`<span>${x}</span>`).join("")}</div>
    </div>`);
  }
  grid.innerHTML = cells.join("");
  grid.querySelectorAll(".cell").forEach(c=>{
    c.addEventListener("click", ()=>{
      state.selected = c.dataset.date;
      renderCalendar();
      renderDayPanel();
    }, {passive:true});
  });
}
function renderDayPanel(){
  const date = state.selected;
  if(!date){ dayHead.textContent="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å"; curOver.textContent="0"; curOtgul.textContent="0"; curVac.textContent="–Ω–µ—Ç"; return; }
  const {y,m0,d} = parseYmd(date);
  const weekday = ["–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ","–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫","–≤—Ç–æ—Ä–Ω–∏–∫","—Å—Ä–µ–¥–∞","—á–µ—Ç–≤–µ—Ä–≥","–ø—è—Ç–Ω–∏—Ü–∞","—Å—É–±–±–æ—Ç–∞"][new Date(y,m0,d).getDay()];
  dayHead.textContent = `${weekday}, ${d} ${MONTHS[m0]} ${y} –≥.`;
  const dd = state.data.days[date];
  curOver.textContent = String(dd.overtimeHours||0);
  curOtgul.textContent = String((dd.otguls||[]).reduce((a,b)=>a+b,0));
  curVac.textContent = dd.vacation ? "–¥–∞" : "–Ω–µ—Ç";
  renderTotals(); // –¥–ª—è —Å—É—Ç–∏ –ø–µ—Ä–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
}
function renderTotals(){
  const t = compute(state.data);
  sumTokens.innerHTML = [
    `<span class="pill">–ë–∞–∑–∞: <b>${fmtRub(t.basePart)}</b></span>`,
    `<span class="pill">–ü–æ—á–∞—Å–æ–≤–∞—è: <b>${fmtRub(t.rate)}</b></span>`,
    `<span class="pill" style="background:#13261f;border-color:#1f4c38">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏: <b>${fmtRub(t.overPay)}</b> (—á–∞—Å—ã: ${t.overH.toFixed(2)})</span>`,
    `<span class="pill">–û—Ç–≥—É–ª: <b>${state.selected? (state.data.days[state.selected].otguls||[]).reduce((a,b)=>a+b,0):0} —á</b></span>`,
    `<span class="pill">–û—Ç–ø—É—Å–∫: <b>${fmtRub(t.vacDays*t.avgDaily)}</b></span>`
  ].join("");
  totalSum.textContent = fmtRub(t.total);
}
function bindSettings(){
  salary.value = String(state.data.baseSalary||0);
  workDays.value = String(state.data.workingDays||0);
  hoursPerDay.value = String(state.data.hoursPerDay||8);
  avgDailyManual.value = state.data.avgDailyManual ? String(state.data.avgDailyManual) : "";
}

/* ==== –°–æ–±—ã—Ç–∏—è –≤–µ—Ä—Ö–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫ ==== */
btnPrev.addEventListener("click", ()=>{
  let y=state.data.year, m=state.data.month-1; if(m<0){m=11;y--;}
  state.data = loadMonth(y,m); saveMonth(state.data); state.selected=null; updateMonthHeader(); renderCalendar(); renderHolidaysTab(); renderDayPanel();
});
btnNext.addEventListener("click", ()=>{
  let y=state.data.year, m=state.data.month+1; if(m>11){m=0;y++;}
  state.data = loadMonth(y,m); saveMonth(state.data); state.selected=null; updateMonthHeader(); renderCalendar(); renderHolidaysTab(); renderDayPanel();
});
btnToday.addEventListener("click", ()=>{
  const t=new Date();
  state.data = loadMonth(t.getFullYear(), t.getMonth()); saveMonth(state.data);
  state.selected = ymd(t.getFullYear(),t.getMonth(),t.getDate());
  updateMonthHeader(); renderCalendar(); renderDayPanel(); renderHolidaysTab();
});
btnDateToday.addEventListener("click", ()=>{
  const t=new Date(); dateInput.value = ymd(t.getFullYear(),t.getMonth(),t.getDate());
});

/* ==== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ ==== */
document.querySelectorAll('[data-q]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    dateInput.value = dateInput.value || ymd(state.data.year, state.data.month, 1);
    $("#otType").value = btn.dataset.t || "auto";
    $("#otHours").value = btn.dataset.q;
    $("#btnAddOver").click();
  });
});
$("#btnAddOver").addEventListener("click", ()=>{
  const date = dateInput.value || state.selected;
  if(!date){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É"); return; }
  state.selected = date;
  const hours = Math.max(0.5, Math.round((Number($("#otHours").value)||0)*2)/2);
  state.data.days[date].overtimeHours = hours; // –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å, –∫–∞–∫ —Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å
  saveMonth(state.data); renderCalendar(); renderDayPanel();
});
btnOverDel.addEventListener("click", ()=>{
  if(!state.selected) return; state.data.days[state.selected].overtimeHours = 0; saveMonth(state.data); renderCalendar(); renderDayPanel();
});
btnVacToggle.addEventListener("click", ()=>{
  if(!state.selected) return; const d=state.data.days[state.selected]; d.vacation=!d.vacation; saveMonth(state.data); renderCalendar(); renderDayPanel();
});
btnOtgulAdd.addEventListener("click", ()=>{
  if(!state.selected) return; state.data.days[state.selected].otguls.push(2); saveMonth(state.data); renderCalendar(); renderDayPanel();
});
btnOtgulRemove.addEventListener("click", ()=>{
  if(!state.selected) return; const arr=state.data.days[state.selected].otguls; if(arr.length) arr.pop(); saveMonth(state.data); renderCalendar(); renderDayPanel();
});
btnHolidayToggle.addEventListener("click", ()=>{
  if(!state.selected) return;
  const arr=state.data.holidays; const i=arr.indexOf(state.selected); if(i>=0) arr.splice(i,1); else arr.push(state.selected);
  arr.sort(); saveMonth(state.data); renderCalendar(); renderDayPanel(); renderHolidaysTab();
});

/* ==== –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ –≤–∫–ª–∞–¥–∫–∞ ==== */
function renderHolidaysTab(){
  const {year,month}=state.data; const dim=daysInMonth(year,month); const set=new Set(state.data.holidays);
  const html = Array.from({length:dim},(_,i)=>{const d=i+1; const date=ymd(year,month,d); const on=set.has(date);
    return `<button class="btn" data-date="${date}" style="border-radius:999px;${on?'outline:2px solid var(--warn)':''}">üéâ ${d}</button>`;
  }).join("");
  holGrid.innerHTML = html;
  holGrid.querySelectorAll("button").forEach(b=>b.addEventListener("click",()=>{
    const date=b.dataset.date; const arr=state.data.holidays; const i=arr.indexOf(date); if(i>=0) arr.splice(i,1); else arr.push(date);
    arr.sort(); saveMonth(state.data); renderCalendar(); renderHolidaysTab();
  }));
}

/* ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –ò—Å—Ç–æ—Ä–∏—è ==== */
saveSettings.addEventListener("click", ()=>{
  state.data.baseSalary = Math.max(0, Math.round(Number(salary.value)||0));
  state.data.workingDays = Math.max(0, Math.round(Number(workDays.value)||0));
  state.data.hoursPerDay = Math.max(1, Math.round((Number(hoursPerDay.value)||8)*2)/2);
  const avg = Number(avgDailyManual.value); state.data.avgDailyManual = (Number.isFinite(avg)&&avg>0) ? avg : null;
  saveMonth(state.data); renderTotals(); renderAvgDailyAuto();
});
$("#historyAddCurrent").addEventListener("click", ()=>{
  const h=loadHistory(); const k=`${state.data.year}-${pad2(state.data.month+1)}`; h[k]=state.data.baseSalary||0; saveHistory(h); renderAvgDailyAuto();
});
$("#historyClear").addEventListener("click", ()=>{ if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–∫–ª–∞–¥–æ–≤?")){ saveHistory({}); renderAvgDailyAuto(); }});
function renderAvgDailyAuto(){ const t=compute(state.data); avgDailyAutoView.textContent = fmtRub(t.avgAuto); }

/* ==== –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç ==== */
$("#btnExportJson").addEventListener("click", ()=>{
  const payload={schema:2, payload:state.data, history:loadHistory()};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`podrabotki_${state.data.year}_${state.data.month+1}.json`; a.click(); URL.revokeObjectURL(a.href);
});
importJson.addEventListener("change", async ()=>{
  const f=importJson.files?.[0]; if(!f) return;
  try{
    const text=await f.text(); const json=JSON.parse(text); if(!json||!json.payload) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");
    state.data=json.payload; if(json.history) saveHistory(json.history); saveMonth(state.data);
    state.selected=null; updateMonthHeader(); renderCalendar(); renderDayPanel(); renderHolidaysTab(); renderTotals(); bindSettings(); renderAvgDailyAuto();
    alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
  }catch(e){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+(e?.message||e)); }
  finally{ importJson.value=""; }
});
$("#btnResetMonth").addEventListener("click", ()=>{
  if(!confirm("–°—Ç–µ—Ä–µ—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü?")) return;
  localStorage.removeItem(KEY); state.data=loadMonth(state.data.year,state.data.month); state.selected=null;
  updateMonthHeader(); renderCalendar(); renderDayPanel(); renderHolidaysTab(); renderTotals(); bindSettings(); renderAvgDailyAuto();
});

/* ==== PWA ==== */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    if(location.search.includes("kill-sw")){
      navigator.serviceWorker.getRegistrations().then(rs=>{rs.forEach(r=>r.unregister()); caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))).finally(()=>location.replace(location.pathname+"?v="+Date.now()));});
      return;
    }
    navigator.serviceWorker.register("./sw.js",{scope:"./"}).catch(()=>{});
  });
}
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); deferredPrompt=e; $("#btnInstall").style.display="inline-block"; });
$("#btnInstall").addEventListener("click", async ()=>{
  if(!deferredPrompt){ alert("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞: ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª."); return; }
  deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; $("#btnInstall").style.display="none";
});
$("#btnUpdate").addEventListener("click", async ()=>{
  try{ const regs=await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); } finally { location.reload(); }
});

/* ==== START ==== */
setTab("journal");
(function initSelected(){ const t=new Date(); state.selected=ymd(state.data.year,state.data.month, Math.min(t.getDate(), daysInMonth(state.data.year,state.data.month))); })();
initUI();
</script>
</body>
</html>
