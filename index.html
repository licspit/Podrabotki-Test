<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="theme-color" content="#0b0d12">
<style>
  :root{
    --bg:#0f1115; --card:#161b22; --mut:#9aa4b2; --text:#e6eef8; --accent:#3b82f6; --accent-2:#2563eb;
    --ok:#16a34a; --danger:#ef4444; --pill:#0b1220; --border:#202735;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:940px;margin:0 auto;padding:16px}
  .h1{font-weight:800;font-size:28px;margin:6px 0 14px}
  .tabs{display:flex;gap:12px;margin:4px 0 14px}
  .tab{border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 16px;border-radius:14px;cursor:pointer}
  .tab.active{outline:2px solid var(--accent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;align-items:center}
  .row.wrap{flex-wrap:wrap}
  .grow{flex:1;min-width:0}

  /* –æ—Ç–∫–ª—é—á–∞–µ–º double-tap zoom –Ω–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö */
html, body { touch-action: manipulation; }
.btn, .tab, .cal-day, label, input, select {
  touch-action: manipulation;
}

      .btn{
  border:1px solid var(--border);
  background:#1f2937;
  color:var(--text);
  border-radius:14px;
  padding:0 14px;
  cursor:pointer;
  height:44px;
  white-space:nowrap;

  /* –ù–û–í–û–ï: –∏–¥–µ–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä */
  display:flex;
  align-items:center;
  justify-content:center;
}
      
/* –∑–∞—â–∏—Ç–∞ –æ—Ç –∑—É–º–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –∏–Ω–ø—É—Ç–∞—Ö –≤ iOS: —à—Ä–∏—Ñ—Ç >= 16px */
input, select { font-size:16px; }

  .btn.primary{background:var(--accent);border-color:var(--accent-2)}
  .btn.danger{background:#3a0d12;border-color:#7f1d1d}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  input,select{width:100%;padding:0 14px;border-radius:12px;border:1px solid var(--border);
               background:#0e1420;color:var(--text);height:44px}
  .mut{color:var(--mut)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:780px){.grid-3{grid-template-columns:1fr}}

  .quick{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
  .quick .btn{padding:16px 8px;height:48px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);
        padding:6px 10px;border-radius:999px;border:1px solid var(--border)}
  .mtt{margin-top:8px}
  .mt-8{margin-top:8px}
  .section-title{font-weight:700;margin:2px 0 8px}

      /* --- –ò–º–ø–æ—Ä—Ç: –∫—Ä–∞—Å–∏–≤—ã–π —Ñ–∞–π–ª-–∏–Ω–ø—É—Ç --- */
.file-wrap{
  display:grid;
  grid-template-columns:auto 1fr; /* –∫–Ω–æ–ø–∫–∞ | –∏–º—è —Ñ–∞–π–ª–∞ */
  gap:12px;
  align-items:center;
}
.file-input{
  position:absolute;
  width:1px;height:1px;overflow:hidden;
  clip:rect(0 0 0 0); clip-path: inset(50%);
  white-space:nowrap;border:0;padding:0;margin:-1px;
}
.file-name{
  display:flex;align-items:center;
  height:44px;padding:0 14px;border-radius:12px;
  background:#0e1420;border:1px solid var(--border);
  color:var(--text);
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
/* --- –ò–º–ø–æ—Ä—Ç: —Ä–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ --- */
.import-grid{
  display:grid;
  grid-template-columns: 200px 1fr; /* –ª–µ–≤–∞—è —É–∑–∫–∞—è –∫–æ–ª–æ–Ω–∫–∞ + –ø—Ä–∞–≤–∞—è —Ä–∞—Å—Ç—è–∂–∏–º–∞—è */
  grid-auto-rows: 44px;
  column-gap:12px;
  row-gap:12px;
  align-items:center;
}

/* –¥–µ–ª–∞–µ–º .file-wrap ¬´—Å–∫–≤–æ–∑–Ω–æ–π¬ª, —á—Ç–æ–±—ã –µ—ë –¥–µ—Ç–∏ –ª–µ–≥–ª–∏ –≤ —Å–µ—Ç–∫—É —Ä–æ–¥–∏—Ç–µ–ª—è */
.import-grid .file-wrap{ display: contents; }

      
@media (max-width: 560px){
  .import-grid{
    grid-template-columns: 1fr;      /* –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
    grid-auto-rows:auto;
  }
  .import-grid .file-name{ grid-column:auto; }
}
      
  /* –ü–æ–ª–µ + –∫–Ω–æ–ø–∫–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ –≤ –ª–∏–Ω–∏—é */
  .field-row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
  .field{display:flex;flex-direction:column;gap:6px}

  /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
  .cal-head{
    display:grid;
    grid-template-columns:auto 1fr auto; /* –∫–Ω–æ–ø–∫–∞ | –∑–∞–≥–æ–ª–æ–≤–æ–∫ | –∫–Ω–æ–ø–∫–∞ */
    align-items:center;
    gap:12px;
    width:100%;
  }
  .cal-title {
  font-weight: 800;
  font-size: 16px;   /* –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä */
  text-align: center;
  line-height: 1.2;
}
.cal-title .year {
  display: block;
  font-size: 16px;
  font-weight: 500;
  margin-top: 2px;
}
  .cal-head .btn:first-child{ justify-self:start; }
  .cal-head .btn:last-child{  justify-self:end;  }
  .cal-head .btn{ max-width:100%; }

  .cal-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:6px 0 8px;color:var(--mut)}
  .cal-dow span{text-align:center}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cal-day{position:relative;border:1px solid var(--border);background:#0f1420;border-radius:18px;min-height:60px;padding:6px 6px 4px;text-align:center;color:var(--text);cursor:pointer}
  .cal-day .num{display:block;font-weight:700;margin-bottom:2px}
  .cal-day .badge{font-size:15px;line-height:1}
  .cal-day.selected{outline:3px solid var(--accent);outline-offset:0}
  .legend{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px;color:var(--mut)}
  .legend span{display:inline-flex;align-items:center;gap:6px}

  /* –°—Ç—Ä–æ–∫–∞ –∑–∞–ø–∏—Å–∏: 3 –∫–æ–ª–æ–Ω–∫–∏ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ | —á–∞—Å—ã | –¥–µ–π—Å—Ç–≤–∏—è */
  .rowline{
    display:grid;
    grid-template-columns:1fr 100px auto;
    gap:8px;
    align-items:center;
    padding:10px;
    border:1px solid var(--border);
    border-radius:12px;
    margin:6px 0;
  }
  .rowline .hours{ text-align:right }
  .rowline .actions{ justify-self:end }

  .money{text-align:right}
  .totals{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .totals .pill{background:#0f1625}

      /* –†—è–¥ –¥–≤—É—Ö –Ω–∏–∂–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
.buttons-row{
  grid-column: 1 / -1;  /* —Ä–∞—Å—Ç—è–Ω—É—Ç—å –Ω–∞ –æ–±–µ –∫–æ–ª–æ–Ω–∫–∏ —Å–µ—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ */
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.buttons-row .btn{
  flex:1 1 180px;       /* –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞; —É–∂–∏–º–∞—é—Ç—Å—è –Ω–∞ —É–∑–∫–æ–º —ç–∫—Ä–∞–Ω–µ */
}
      
  @media (max-width:560px){
    .rowline{ grid-template-columns:1fr 70px auto }
    .cal-day{min-height:56px}
  }
      @media (max-width:560px){
  .import-grid{ grid-template-columns:1fr; grid-auto-rows:auto; }
  .buttons-row .btn{ flex:1 1 140px; }
}
      /* ===== Modal (–ê—Ä—Ö–∏–≤) ===== */
.modal[hidden]{ display:none }
.modal{
  position:fixed; inset:0; z-index:9999; display:grid; place-items:center;
}
.modal-backdrop{
  position:absolute; inset:0; background:#0008; backdrop-filter:saturate(80%) blur(2px);
}
      /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–∫—Ä–µ—Å—Ç–∏–∫) */
.modal-close{
  position:absolute; top:10px; right:10px;
  width:36px; height:36px; border-radius:999px;
  border:1px solid var(--border); background:#111827; color:var(--text);
  display:flex; align-items:center; justify-content:center; cursor:pointer;
  font-size:20px; line-height:1;
      padding: 2px 0 0;
}

/* –¥–µ–ª–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –º–æ–¥–∞–ª–∫–∏ —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–æ–π, –∞ –Ω–µ —Ñ–æ–Ω */
.modal-card{
  position:relative; z-index:1; width:min(720px, calc(100% - 24px));
  background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;
overscroll-behavior: contain;
  /* –ù–û–í–û–ï: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
  max-height:calc(100vh - 24px);
  overflow:auto;
  -webkit-overflow-scrolling: touch; /* iOS –ø–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
}

/* –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞, –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ */
body.no-scroll{
  overflow:hidden;
  height:100vh; /* —Ñ–∏–∫—Å –¥–ª—è iOS */
}
.modal-head{ font-weight:800; font-size:18px; margin-bottom:12px }
.modal-row{ display:grid; grid-template-columns:1fr 1fr auto; gap:12px; align-items:end }
@media (max-width:560px){
  .modal-row{ grid-template-columns:1fr 1fr; }
  .modal-row .wide{ grid-column:1 / -1; }
}
.small-note{ color:var(--mut); margin-top:8px }

/* –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
.archive-totals{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px }
.archive-totals .pill{ background:#0f1625 }
.archive-list{ margin-top:10px }
.archive-item{
  display:grid; grid-template-columns:1fr 90px; gap:8px; align-items:center;
  padding:8px; border:1px solid var(--border); border-radius:10px; margin:6px 0;
}
.archive-item .r{ text-align:right }
</style>
</head>
<body>
  <div class="wrap">
    <div class="h1">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</div>

    <div class="tabs">
      <button class="tab active" data-tab="journal">–ñ—É—Ä–Ω–∞–ª</button>
      <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="tab" data-tab="holidays">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
      <button class="tab" data-tab="import">–ò–º–ø–æ—Ä—Ç</button>
    </div>

    <!-- JOURNAL -->
    <section id="journal" class="tabpage">
      <div class="card">
        <div class="field-row">
          <div class="field">
            <div class="mut">–î–∞—Ç–∞</div>
            <input id="dt" readonly>
          </div>
          <button class="btn" id="btnToday">–°–µ–≥–æ–¥–Ω—è</button>
        </div>

        <div class="field-row mt-8">
          <div class="field">
            <div class="mut">–ß–∞—Å—ã</div>
            <input id="hours" inputmode="decimal" placeholder="–Ω–∞–ø—Ä., 3.5">
          </div>
          <button class="btn primary" id="btnAdd">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="section-title mt-8">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏:</div>
        <div class="quick" id="quick">
          <button class="btn" data-qk="hrs-3.5">3.5 —á</button>
          <button class="btn" data-qk="hrs-8">8 —á</button>
          <button class="btn" data-qk="leave-hours">–û—Ç–≥—É–ª</button>
          <button class="btn" data-qk="vacation">–û—Ç–ø—É—Å–∫</button>
        </div>
      </div>

      <div class="card">
        <div class="cal-head">
          <button class="btn" id="prevM">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
          <div class="cal-title" id="cal-title"></div>
          <button class="btn" id="nextM">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
        </div>
        <div class="cal-dow" id="cal-dow"></div>
        <div class="cal-grid" id="cal-grid"></div>
        <div class="legend">
          <span>üõ†Ô∏è ‚Äî –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞</span>
          <span>‚õî ‚Äî –æ—Ç–≥—É–ª</span>
          <span>üèñÔ∏è ‚Äî –æ—Ç–ø—É—Å–∫</span>
          <span>üéâ ‚Äî –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π</span>
        </div>
      </div>

      <div class="card">
        <div id="day-list"></div>
        <div class="totals" id="totals"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="tabpage" hidden>
      <div class="card">
        <div class="grid-3">
          <div>
            <div class="mut">–û–∫–ª–∞–¥, ‚ÇΩ (–Ω–∞ —Ä—É–∫–∏)</div>
            <input id="salary" inputmode="numeric">
          </div>
          <div>
            <div class="mut">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ (–ü–Ω‚Äì–ü—Ç –º–∏–Ω—É—Å –ø—Ä–∞–∑–¥–Ω–∏–∫–∏)</div>
            <input id="workdays" inputmode="numeric" readonly>
          </div>
          <div>
            <div class="mut">–ß–∞—Å–æ–≤ –≤ –¥–µ–Ω—å</div>
            <input id="hoursPerDay" inputmode="numeric" value="8">
          </div>
        </div>
        <div class="mtt">
          <div class="mut">–°—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π (–¥–ª—è –æ—Ç–ø—É—Å–∫–∞), ‚ÇΩ ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</div>
          <input id="avgDaily" inputmode="decimal" placeholder="–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å—á–∏—Ç–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞ 12 –º–µ—Å.">
        </div>
        <div class="row mtt">
  <button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  <button class="btn" id="openArchive">–ê—Ä—Ö–∏–≤</button>
</div>
      </div>
    </section>

    <!-- HOLIDAYS -->
    <section id="holidays" class="tabpage" hidden>
      <div class="card">
        <div class="mut">–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ –∫–ª–∏–∫–æ–º (—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ –º–µ—Å—è—Ü–∞–º).</div>
        <div class="cal-head">
          <button class="btn" id="hPrev">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
          <div class="cal-title" id="h-title"></div>
          <button class="btn" id="hNext">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
        </div>
        <div class="cal-dow" id="h-dow"></div>
        <div class="cal-grid" id="h-grid"></div>
      </div>
    </section>

        <!-- Modal: –ê—Ä—Ö–∏–≤ -->
<div id="archiveModal" class="modal" hidden>
  <div class="modal-backdrop" data-close></div>
 <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="archiveTitle">
  <button class="modal-close" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
  <div class="modal-head" id="archiveTitle">–ê—Ä—Ö–∏–≤ –≤—ã–ø–ª–∞—Ç</div>
  
    <div class="modal-row">
      <div>
        <div class="mut">–ú–µ—Å—è—Ü</div>
        <select id="archMonth"></select>
      </div>
      <div>
        <div class="mut">–ì–æ–¥</div>
        <input id="archYear" inputmode="numeric" />
      </div>
      <div>
        <button class="btn primary wide" id="archShow">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      </div>
    </div>

    <div class="small-note">–ò—Å—Ç–æ—Ä–∏—è —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ –≤–∞—à–∏–º –∑–∞–ø–∏—Å—è–º (–ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏, –æ—Ç–≥—É–ª—ã, –æ—Ç–ø—É—Å–∫) –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –∑–∞—Ä–ø–ª–∞—Ç—ã/—á–∞—Å–æ–≤.</div>

    <div id="archResult"></div>

    <div class="row mtt">
      <button class="btn" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>
    <!-- IMPORT -->
<section id="import" class="tabpage" hidden>
  <div class="card">
    <div class="import-grid">
      <div class="file-wrap">
        <label for="file" class="btn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
        <span class="file-name" id="fileName" aria-live="polite">—Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
        <input id="file" type="file" accept="application/json" class="file-input">
      </div>

      <div class="buttons-row">
        <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button class="btn primary" id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
      </div>
    </div>

    <div class="mut mtt">–≠–∫—Å–ø–æ—Ä—Ç –≤–∫–ª—é—á–∞–µ—Ç –∑–∞–ø–∏—Å–∏, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –∏ –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</div>
  </div>
</section>

<script>
/* ================== STATE & STORAGE ================== */
function ymd(d){return d.toISOString().slice(0,10)}
function pad2(n){return String(n).padStart(2,'0')}
function ymStr(y,m){return `${y}-${pad2(m+1)}`}
function makeId(){return Math.random().toString(36).slice(2,9)+Date.now().toString(36)}
const LS_KEYS = { entries:'entries', holidays:'holidays', settings:'settings' };
function loadEntries(){try{return JSON.parse(localStorage.getItem(LS_KEYS.entries)||'[]')}catch(e){return[]}}
function saveEntries(a){localStorage.setItem(LS_KEYS.entries,JSON.stringify(a))}
function loadHolidays(){try{return JSON.parse(localStorage.getItem(LS_KEYS.holidays)||'{}')}catch(e){return{}}}
function saveHolidays(m){localStorage.setItem(LS_KEYS.holidays,JSON.stringify(m))}
function loadSettings(){try{return JSON.parse(localStorage.getItem(LS_KEYS.settings)||'{}')}catch(e){return{}}}
function saveSettingsObj(o){localStorage.setItem(LS_KEYS.settings,JSON.stringify(o))}

/* default settings */
const defaultSettings = { salary:null, workdays:22, hoursPerDay:8, avgDaily:null };
const settings = Object.assign({}, defaultSettings, loadSettings());

/* selected date / month */
const today = new Date();
const state = {
  year: today.getFullYear(),
  month: today.getMonth(),
  get ym(){return ymStr(this.year,this.month)},
  selectedDate: ymd(today),
  holidays: loadHolidays()
};

/* === util === */
function daysInMonth(y,m){ return new Date(y,m+1,0).getDate() }
function isWeekday(y,m,d){ const dow=new Date(y,m,d).getDay(); return dow>=1 && dow<=5; }
function computeWorkdays(y,m){
  const days=daysInMonth(y,m); let wd=0;
  for(let d=1; d<=days; d++) if(isWeekday(y,m,d)) wd++;
  const hol=(state.holidays[ymStr(y,m)]||[]);
  const weekdayHols=hol.filter(d=>isWeekday(y,m,d)).length;
  return Math.max(0, wd - weekdayHols);
}
function updateWorkdaysForCurrentMonth(){
  const wd = computeWorkdays(state.year, state.month);
  settings.workdays = wd; saveSettingsObj(settings);
  const el=document.getElementById('workdays'); if(el) el.value = wd;
}

/* ================== TABS ================== */
const tabBtns=[...document.querySelectorAll('.tab')];
const tabPages=[...document.querySelectorAll('.tabpage')];
tabBtns.forEach(b=>b.onclick=()=>{
  tabBtns.forEach(x=>x.classList.remove('active'));
  tabPages.forEach(s=>s.hidden=true);
  b.classList.add('active');
  document.getElementById(b.dataset.tab).hidden=false;
  if(b.dataset.tab==='holidays'){renderHolidaysCalendar(hYear,hMonth)}
  if(b.dataset.tab==='settings'){updateWorkdaysForCurrentMonth()}
        // –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –∞—Ä—Ö–∏–≤ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º
  if(!modal.hidden) closeArchive();
});

function setTodayUi(){
  document.getElementById('dt').value = new Date(state.selectedDate)
    .toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});
}
document.getElementById('btnToday').onclick=()=>{
  const t = new Date();
  state.year=t.getFullYear(); state.month=t.getMonth(); state.selectedDate=ymd(t);
  setTodayUi(); renderCalendar(state.year,state.month); renderDayDetails(state.selectedDate);
  updateWorkdaysForCurrentMonth();
};

/* SETTINGS */
document.getElementById('salary').value = settings.salary ?? '';
document.getElementById('hoursPerDay').value = settings.hoursPerDay;
document.getElementById('avgDaily').value = settings.avgDaily??'';
updateWorkdaysForCurrentMonth();
document.getElementById('saveSettings').onclick = () => {
  const salaryStr = document.getElementById('salary').value.trim();
  settings.salary = salaryStr === '' ? null : Number(salaryStr);

  settings.hoursPerDay = Number(document.getElementById('hoursPerDay').value || 0);

  const a = document.getElementById('avgDaily').value.trim();
  settings.avgDaily = a === '' ? null : (Number(a.replace(',','.')) || null);

  saveSettingsObj(settings);
  renderDayDetails(state.selectedDate);
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.');
};

/* ADD / UPDATE / DELETE */
function addOrUpdateWork(dateISO, hoursVal){
  const list = loadEntries();
  const idx  = list.findIndex(e => e.date === dateISO && e.kind === 'work');
  const rec  = {
    id:   idx > -1 ? list[idx].id : makeId(),
    date: dateISO,
    kind: 'work',
    hours: Number(hoursVal) || 0
  };
  if (idx > -1) list[idx] = rec; else list.push(rec);
  saveEntries(list);
}

function addOffHours(dateISO, hoursVal){
  const list = loadEntries();
  list.push({ id: makeId(), date: dateISO, kind: 'offHours', hours: Number(hoursVal) || 0 });
  saveEntries(list);
}
function toggleVacation(dateISO){
  const list=loadEntries();
  const idx=list.findIndex(e=>e.date===dateISO && e.kind==='vacation');
  if(idx>-1) list.splice(idx,1);
  else list.push({ id:makeId(), date:dateISO, kind:'vacation', hours:0 });
  saveEntries(list);
}
function deleteEntryById(id){
  const list=loadEntries();
  const i=list.findIndex(e=>e.id===id);
  if(i>-1){ list.splice(i,1); saveEntries(list) }
}
function bindDeleteButtons(){
  document.querySelectorAll('[data-del-id]').forEach(b=>{
    b.onclick=()=>{ deleteEntryById(b.dataset.delId); renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month); };
  });
}

/* inputs */
document.getElementById('btnAdd').onclick=()=>{
  const h = Number(document.getElementById('hours').value.replace(',','.'))||0;
  if(h<=0) return;
  addOrUpdateWork(state.selectedDate,h);
  document.getElementById('hours').value='';
  renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month);
};
document.getElementById('quick').onclick=(ev)=>{
  const b=ev.target.closest('button[data-qk]'); if(!b) return;
  const code=b.dataset.qk;
  if(code==='hrs-3.5') addOrUpdateWork(state.selectedDate,3.5);
  if(code==='hrs-8') addOrUpdateWork(state.selectedDate,8);
  if(code==='leave-hours'){
    const n = Number((prompt('–û—Ç–≥—É–ª (—á–∞—Å—ã):','2')||'').replace(',','.'))||0;
    if(n>0) addOffHours(state.selectedDate,n);
  }
  if(code==='vacation') toggleVacation(state.selectedDate);
  renderDayDetails(state.selectedDate); renderCalendar(state.year,state.month);
};

/* CALENDAR */
function renderCalendar(y,m){
  const titleEl = document.getElementById('cal-title');
const d = new Date(y,m,1);
const month = d.toLocaleDateString('ru-RU',{month:'long'});
const year  = d.getFullYear();
titleEl.innerHTML = `${month}<span class="year">${year} –≥.</span>`;

  document.getElementById('cal-dow').innerHTML =
    ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(d=>`<span>${d}</span>`).join('');

  const grid=document.getElementById('cal-grid'); grid.innerHTML='';
  const first=new Date(y,m,1);
  const startCol=(first.getDay()+6)%7;
  const n=daysInMonth(y,m);
  const entries=loadEntries();
  const hol = state.holidays[ymStr(y,m)] || [];

  for(let i=0;i<startCol;i++){
    const d=document.createElement('div'); d.className='cal-day'; d.style.visibility='hidden'; grid.appendChild(d);
  }
  for(let day=1; day<=n; day++){
    const dateISO=`${y}-${pad2(m+1)}-${pad2(day)}`;
    const hasWork=entries.some(e=>e.date===dateISO && e.kind==='work');
    const hasLeave=entries.some(e=>e.date===dateISO && e.kind==='offHours');
    const hasVac=entries.some(e=>e.date===dateISO && e.kind==='vacation');
    const isHol=hol.includes(day);
    const badge=(hasWork?'üõ†Ô∏è':'')+(hasLeave?' ‚õî':'')+(hasVac?' üèñÔ∏è':'')+(isHol?' üéâ':'');

    const btn=document.createElement('button');
    btn.className='cal-day';
    if(dateISO===state.selectedDate) btn.classList.add('selected');
    btn.innerHTML=`<span class="num">${day}</span><div class="badge">${badge}</div>`;
    btn.onclick=()=>{ state.selectedDate=dateISO; setTodayUi(); renderCalendar(y,m); renderDayDetails(dateISO); };
    grid.appendChild(btn);
  }
}
function setSelectedDateToMonth(y, m){
  const prevDay = Number(state.selectedDate.slice(8,10)) || 1;
  const dim = daysInMonth(y, m);
  const day = Math.min(prevDay, dim);
  state.selectedDate = `${y}-${pad2(m+1)}-${pad2(day)}`;
  setTodayUi();
}
      
document.getElementById('prevM').onclick = () => {
  state.month--;
  if (state.month < 0) { state.month = 11; state.year--; }
  setSelectedDateToMonth(state.year, state.month);
  renderCalendar(state.year, state.month);
  renderDayDetails(state.selectedDate);
  updateWorkdaysForCurrentMonth();
};

document.getElementById('nextM').onclick = () => {
  state.month++;
  if (state.month > 11) { state.month = 0; state.year++; }
  setSelectedDateToMonth(state.year, state.month);
  renderCalendar(state.year, state.month);
  renderDayDetails(state.selectedDate);
  updateWorkdaysForCurrentMonth();
};
/* TOTALS + LIST */
      /* ===== ARCHIVE: helpers for arbitrary month ===== */
function hourRateFor(y,m){
  const wd  = Math.max(1, computeWorkdays(y,m));
  const hpd = Math.max(1, Number(settings.hoursPerDay||8));
  const sal = Number(settings.salary||0);
  return (wd*hpd) > 0 ? sal/(wd*hpd) : 0;
}

// —Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞ (—Å–∫–æ–ª—å–∑—è—â–∏–µ 12 –º–µ—Å ¬´–¥–æ¬ª –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ)
function autoAverageDailyFor(y,m){
  const anchor = new Date(y, m, 1);
  let sum = 0;
  for(let i=1;i<=12;i++){
    const d = new Date(anchor); d.setMonth(anchor.getMonth()-i);
    sum += monthAccruals(d.getFullYear(), d.getMonth());
  }
  return sum / (29.3 * 12);
}
function avgDailyFor(y,m){
  if(settings.avgDaily!=null) return Number(settings.avgDaily)||0;
  return autoAverageDailyFor(y,m);
}

// —Ä–∞—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Å—è—Ü—É
function totalsForMonth(y,m){
  const ym = ymStr(y,m);
  const list = loadEntries().filter(e => e.date.slice(0,7) === ym);

  let workH = 0, offH = 0;
  const vacDays = [];

  list.forEach(e=>{
    if(e.kind === 'work') workH += Number(e.hours||0);
    else if(e.kind === 'offHours') offH += Number(e.hours||0);
    else if(e.kind === 'vacation') vacDays.push(Number(e.date.slice(8,10)));
  });

  const hol = state.holidays[ym] || [];
  const rate = hourRateFor(y,m);
  const dayFromSalary = Number(settings.salary||0) / Math.max(1, computeWorkdays(y,m));

  const vacPaidDays = vacDays.filter(d => !hol.includes(d)).length;
  const vacWeekdays = vacDays.filter(d => isWeekday(y,m,d)).length;

  const payWork = workH * rate;
  const payVac  = avgDailyFor(y,m) * vacPaidDays;
  const base    = Math.max(0, Number(settings.salary||0) - offH*rate - vacWeekdays*dayFromSalary);
  const total   = base + payWork + payVac;

  return { workH, offH, vacPaidDays, vacWeekdays, rate, payWork, payVac, base, total };
}

// –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–æ—á–∫–∞ –ø–æ –¥–Ω—è–º
function monthEntriesList(y,m){
  const ym = ymStr(y,m);
  const list = loadEntries().filter(e => e.date.slice(0,7) === ym)
                 .sort((a,b)=>a.date.localeCompare(b.date));
  const byDay = new Map();
  list.forEach(e=>{
    const d = Number(e.date.slice(8,10));
    if(!byDay.has(d)) byDay.set(d, []);
    byDay.get(d).push(e);
  });
  return [...byDay.entries()].map(([d,items])=>{
    const label = `${String(d).padStart(2,'0')}.${String(m+1).padStart(2,'0')}.${y}`;
    const text = items.map(e=>{
      const icon = e.kind==='work'?'üõ†Ô∏è':(e.kind==='offHours'?'‚õî':'üèñÔ∏è');
      const hrs  = e.kind==='vacation' ? '' : ` ‚Äî ${Number(e.hours||0)} —á`;
      const title= e.kind==='work'?'–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞':(e.kind==='offHours'?'–û—Ç–≥—É–ª':'–û—Ç–ø—É—Å–∫');
      return `${icon} ${title}${hrs}`;
    }).join(', ');
    return { label, text };
  });
}
function currentHourRate(){
  const wd = Math.max(1, Number(settings.workdays||22));
  const hpd= Math.max(1, Number(settings.hoursPerDay||8));
  const sal= Number(settings.salary||0);
  return wd*hpd>0 ? sal/(wd*hpd) : 0;
}
function monthAccruals(y,m){
  const ym = ymStr(y,m);
  const list = loadEntries().filter(e=>e.date.slice(0,7)===ym);
  const rate = currentHourRate();
  let workH = 0;
  list.forEach(e=>{ if(e.kind==='work') workH += Number(e.hours||0); });
  const overtimePay = workH * rate;
  return Number(settings.salary||0) + overtimePay;
}
function autoAverageDaily(){
  const anchor = new Date(state.year, state.month, 1);
  let sum = 0;
  for(let i=1;i<=12;i++){
    const d = new Date(anchor); d.setMonth(anchor.getMonth()-i);
    sum += monthAccruals(d.getFullYear(), d.getMonth());
  }
  return sum / (29.3 * 12);
}
function avgDaily(){
  if(settings.avgDaily!=null) return Number(settings.avgDaily)||0;
  return autoAverageDaily();
}
function calcTotals(dateISO){
  const y = Number(dateISO.slice(0,4));
  const m = Number(dateISO.slice(5,7)) - 1;
  const ym = dateISO.slice(0,7);

  const list = loadEntries().filter(e => e.date.slice(0,7) === ym);

  let workH = 0, offH = 0;
  const vacDays = [];

  list.forEach(e=>{
    if(e.kind === 'work') workH += Number(e.hours||0);
    else if(e.kind === 'offHours') offH += Number(e.hours||0);
    else if(e.kind === 'vacation') vacDays.push(Number(e.date.slice(8,10)));
  });

  const rate = currentHourRate();
  const dayFromSalary = Number(settings.salary||0) / Math.max(1, Number(settings.workdays||22));
  const hol = state.holidays[ymStr(y,m)] || [];

  const vacPaidDays = vacDays.filter(d => !hol.includes(d)).length;
  const vacWeekdays = vacDays.filter(d => isWeekday(y,m,d)).length;

  const payWork = workH * rate;
  const payVac  = avgDaily() * vacPaidDays;

  const base = Math.max(0, Number(settings.salary||0) - offH*rate - vacWeekdays*dayFromSalary);
  const total = base + payWork + payVac;
  return { workH, offH, vacPaidDays, vacWeekdays, rate, payWork, payVac, base, total };
}
function renderDayDetails(dateISO){
  const box=document.getElementById('day-list');
  const list=loadEntries().filter(e=>e.date===dateISO);
  const label=new Date(dateISO).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  let html=`<h3 style="margin:6px 0 10px">${label}</h3>`;
  if(list.length===0){ html+=`<div class="mut">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</div>`; }
  else{
    html+=list.map(e=>{
      const icon = e.kind==='work'?'üõ†Ô∏è':(e.kind==='offHours'?'‚õî':'üèñÔ∏è');
      const title= e.kind==='work'?'–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞':(e.kind==='offHours'?'–û—Ç–≥—É–ª':'–û—Ç–ø—É—Å–∫');
      const hrs  = e.kind==='vacation'?'‚Äî':Number(e.hours||0).toFixed(2);
      return `<div class="rowline">
        <div><span class="pill">${icon}</span> ${title}</div>
        <div class="hours">${hrs}</div>
        <div class="actions"><button class="btn danger" data-del-id="${e.id}">–£–¥–∞–ª–∏—Ç—å</button></div>
      </div>`;
    }).join('');
  }
  box.innerHTML=html;
  bindDeleteButtons();

  const t=calcTotals(dateISO);
  document.getElementById('totals').innerHTML = `
    <span class="pill">–ë–∞–∑–∞: ${t.base.toLocaleString('ru-RU')} ‚ÇΩ</span>
    <span class="pill">–ü–æ—á–∞—Å–æ–≤–∞—è: ${t.rate.toFixed(0)} ‚ÇΩ/—á</span>
    <span class="pill">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏: ${t.payWork.toLocaleString('ru-RU')} ‚ÇΩ (—á–∞—Å—ã: ${t.workH.toFixed(2)})</span>
    <span class="pill">–û—Ç–≥—É–ª: ${t.offH.toFixed(2)} —á</span>
    <span class="pill">–û—Ç–ø—É—Å–∫: ${t.payVac.toLocaleString('ru-RU')} ‚ÇΩ (–¥–Ω.: ${t.vacPaidDays})</span>
    <span class="pill" style="font-weight:700">–ò—Ç–æ–≥–æ: ${t.total.toLocaleString('ru-RU')} ‚ÇΩ</span>
  `;
}

/* HOLIDAYS */
let hYear=state.year, hMonth=state.month;
function renderHolidaysCalendar(y,m){
  const t = document.getElementById('h-title');
const d = new Date(y,m,1);
const month = d.toLocaleDateString('ru-RU',{month:'long'});
const year  = d.getFullYear();
t.innerHTML = `${month}<span class="year">${year} –≥.</span>`;

  document.getElementById('h-dow').innerHTML =
    ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(d=>`<span>${d}</span>`).join('');
  const grid=document.getElementById('h-grid'); grid.innerHTML='';
  const first=new Date(y,m,1);
  const startCol=(first.getDay()+6)%7, n=daysInMonth(y,m);
  const key = ymStr(y,m);
  const arr = (state.holidays[key] || []).slice();

  for(let i=0;i<startCol;i++){ const d=document.createElement('div'); d.className='cal-day'; d.style.visibility='hidden'; grid.appendChild(d); }
  for(let day=1; day<=n; day++){
    const btn=document.createElement('button'); btn.className='cal-day';
    const isHol=arr.includes(day);
    btn.innerHTML=`<span class="num">${day}</span><div class="badge">${isHol?'üéâ':''}</div>`;
    btn.onclick = () => {
  const list = state.holidays[key] || [];
  const i = list.indexOf(day);
  if (i > -1) list.splice(i, 1); else list.push(day);
  state.holidays[key] = list.sort((a,b)=>a-b);
  saveHolidays(state.holidays);

  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞–ª–∏ —Å–µ—Ç–∫—É –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
  renderHolidaysCalendar(y, m);

  // 1) –í–°–ï–ì–î–ê –æ–±–Ω–æ–≤–ª—è–µ–º "–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ"
  //    (—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü = —Ç–æ—Ç, —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç –≤ –∂—É—Ä–Ω–∞–ª–µ)
  updateWorkdaysForCurrentMonth();

  // 2) –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–º –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç –º–µ—Å—è—Ü, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç –≤ –∂—É—Ä–Ω–∞–ª–µ ‚Äî
  //    –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –∏—Ç–æ–≥–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å,
  //    —á—Ç–æ–±—ã —Å—Ç–∞–≤–∫–∞/–∏—Ç–æ–≥–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–ª–∏—Å—å —Å—Ä–∞–∑—É.
  if (y === state.year && m === state.month) {
    renderCalendar(state.year, state.month);
    renderDayDetails(state.selectedDate);
  }
};
    grid.appendChild(btn);
  }
}
document.getElementById('hPrev').onclick=()=>{ hMonth--; if(hMonth<0){hMonth=11;hYear--} renderHolidaysCalendar(hYear,hMonth) }
document.getElementById('hNext').onclick=()=>{ hMonth++; if(hMonth>11){hMonth=0;hYear++} renderHolidaysCalendar(hYear,hMonth) }

/* IMPORT / EXPORT */
document.getElementById('btnExport').onclick=()=>{
  const payload = { entries: loadEntries(), holidays: loadHolidays(), settings };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paycalc_data.json'; a.click();
  URL.revokeObjectURL(a.href);
};
document.getElementById('btnImport').onclick=()=>{
  const f=document.getElementById('file').files?.[0];
  if(!f) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª JSON');
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(Array.isArray(data.entries)) saveEntries(data.entries); else saveEntries([]);
      if(data.holidays && typeof data.holidays==='object') saveHolidays(data.holidays);
      if(data.settings && typeof data.settings==='object'){
        Object.assign(settings, defaultSettings, data.settings); saveSettingsObj(settings);
      }
      alert('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
      renderCalendar(state.year,state.month); renderDayDetails(state.selectedDate);
      updateWorkdaysForCurrentMonth();
    }catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e.message) }
  };
  r.readAsText(f);
};

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ UI
const fileInput  = document.getElementById('file');
const fileNameEl = document.getElementById('fileName');
if (fileInput && fileNameEl){
  fileInput.addEventListener('change', () => {
    fileNameEl.textContent = fileInput.files?.[0]?.name || '—Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
  });
}
      
/* INIT */
function renderHolidaysCalendarInit(){ renderHolidaysCalendar(hYear,hMonth); }
setTodayUi();
renderCalendar(state.year,state.month);
renderDayDetails(state.selectedDate);
renderHolidaysCalendarInit();
updateWorkdaysForCurrentMonth();

      /* ===== ARCHIVE: UI ===== */
const modal = document.getElementById('archiveModal');
const archMonthSel = document.getElementById('archMonth');
const archYearInp  = document.getElementById('archYear');
const archShowBtn  = document.getElementById('archShow');
const archResult   = document.getElementById('archResult');

function openArchive(){
  if(archMonthSel && archMonthSel.options.length === 0){
    const months = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
    months.forEach((name,i)=>{
      const opt=document.createElement('option');
      opt.value = i; opt.textContent = name; archMonthSel.appendChild(opt);
    });
  }
  archMonthSel.value = String(state.month);
  archYearInp.value  = String(state.year);

  modal.hidden = false;
  document.body.classList.add('no-scroll');   // ‚Üê –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
  // –ø–æ –∂–µ–ª–∞–Ω–∏—é: —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å—á—ë—Ç
  // renderArchive();
        archMonthSel?.focus();
}

function closeArchive(){
  modal.hidden = true;
  document.body.classList.remove('no-scroll'); // ‚Üê –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
}
function renderArchive(){
  const y = Number(archYearInp.value||state.year);
  const m = Number(archMonthSel.value||state.month);

  const t = totalsForMonth(y,m);
  const items = monthEntriesList(y,m);

  const head = new Date(y,m,1).toLocaleDateString('ru-RU',{month:'long', year:'numeric'});
  let html = `<h3 style="margin:10px 0 6px">${head}</h3>`;

  html += `
    <div class="archive-totals">
      <span class="pill">–ë–∞–∑–∞: ${t.base.toLocaleString('ru-RU')} ‚ÇΩ</span>
      <span class="pill">–ü–æ—á–∞—Å–æ–≤–∞—è: ${t.rate.toFixed(0)} ‚ÇΩ/—á</span>
      <span class="pill">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏: ${t.payWork.toLocaleString('ru-RU')} ‚ÇΩ (—á–∞—Å—ã: ${t.workH.toFixed(2)})</span>
      <span class="pill">–û—Ç–≥—É–ª: ${t.offH.toFixed(2)} —á</span>
      <span class="pill">–û—Ç–ø—É—Å–∫: ${t.payVac.toLocaleString('ru-RU')} ‚ÇΩ (–¥–Ω.: ${t.vacPaidDays})</span>
      <span class="pill" style="font-weight:700">–ò—Ç–æ–≥–æ: ${t.total.toLocaleString('ru-RU')} ‚ÇΩ</span>
    </div>
  `;

  if(items.length){
    html += `<div class="archive-list">` +
      items.map(it=>`
        <div class="archive-item">
          <div>${it.label}</div>
          <div class="r">${it.text}</div>
        </div>
      `).join('') +
    `</div>`;
  }else{
    html += `<div class="mut" style="margin-top:10px">–ó–∞–ø–∏—Å–µ–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –Ω–µ—Ç.</div>`;
  }

  archResult.innerHTML = html;
}

// –∫–Ω–æ–ø–∫–∏
document.getElementById('openArchive')?.addEventListener('click', openArchive);
modal?.addEventListener('click', (e)=>{
  if(e.target.matches('[data-close]')) closeArchive();
});
archShowBtn?.addEventListener('click', renderArchive);
/* PWA register */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
  // –ì–ª—É—à–∏–º –±—ã—Å—Ç—Ä—ã–π –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Ç–∞–ø (–¥–≤–æ–π–Ω–æ–π) ‚Äî –Ω–µ –¥–∞—ë–º –±—Ä–∞—É–∑–µ—Ä—É –≤–∫–ª—é—á–∏—Ç—å –∑—É–º
(function preventDoubleTapZoom(){
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (e) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();   // –±–ª–æ–∫–∏—Ä—É–µ–º "–≤—Ç–æ—Ä–æ–π" —Ç–∞–ø
    }
    lastTouchEnd = now;
  }, { passive: false });
})();
</script>
</body>
</html>
